<!DOCTYPE html><html><head><title>socket.io.js</title><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><link rel="stylesheet" media="all" href="../../../docco.css"></head><body><div id="container"><div id="background"></div><div id="jump_to">Jump To &hellip;<div id="jump_wrapper"><div id="jump_page"><a href="../../../index.html" class="source"><span class="file_name">README</span></a><a href="../../../Gruntfile.js.html" class="source "><span class="base_path">. / </span><span class="file_name">Gruntfile.js</span></a><a href="../../../client/app/about/about.controller.js.html" class="source "><span class="base_path">client / app / about / </span><span class="file_name">about.controller.js</span></a><a href="../../../client/app/about/about.controller.spec.js.html" class="source "><span class="base_path">client / app / about / </span><span class="file_name">about.controller.spec.js</span></a><a href="../../../client/app/about/about.js.html" class="source "><span class="base_path">client / app / about / </span><span class="file_name">about.js</span></a><a href="../../../client/app/account/account.js.html" class="source "><span class="base_path">client / app / account / </span><span class="file_name">account.js</span></a><a href="../../../client/app/account/login/login.controller.js.html" class="source "><span class="base_path">client / app / account / login / </span><span class="file_name">login.controller.js</span></a><a href="../../../client/app/account/settings/settings.controller.js.html" class="source "><span class="base_path">client / app / account / settings / </span><span class="file_name">settings.controller.js</span></a><a href="../../../client/app/account/signup/signup.controller.js.html" class="source "><span class="base_path">client / app / account / signup / </span><span class="file_name">signup.controller.js</span></a><a href="../../../client/app/admin/admin.controller.js.html" class="source "><span class="base_path">client / app / admin / </span><span class="file_name">admin.controller.js</span></a><a href="../../../client/app/admin/admin.js.html" class="source "><span class="base_path">client / app / admin / </span><span class="file_name">admin.js</span></a><a href="../../../client/app/app.js.html" class="source "><span class="base_path">client / app / </span><span class="file_name">app.js</span></a><a href="../../../client/app/cart/cart.controller.js.html" class="source "><span class="base_path">client / app / cart / </span><span class="file_name">cart.controller.js</span></a><a href="../../../client/app/cart/cart.controller.spec.js.html" class="source "><span class="base_path">client / app / cart / </span><span class="file_name">cart.controller.spec.js</span></a><a href="../../../client/app/cart/cart.factory.js.html" class="source "><span class="base_path">client / app / cart / </span><span class="file_name">cart.factory.js</span></a><a href="../../../client/app/cart/cart.js.html" class="source "><span class="base_path">client / app / cart / </span><span class="file_name">cart.js</span></a><a href="../../../client/app/catalog/catalog.controller.js.html" class="source "><span class="base_path">client / app / catalog / </span><span class="file_name">catalog.controller.js</span></a><a href="../../../client/app/catalog/catalog.controller.spec.js.html" class="source "><span class="base_path">client / app / catalog / </span><span class="file_name">catalog.controller.spec.js</span></a><a href="../../../client/app/catalog/catalog.js.html" class="source "><span class="base_path">client / app / catalog / </span><span class="file_name">catalog.js</span></a><a href="../../../client/app/main/main.controller.js.html" class="source "><span class="base_path">client / app / main / </span><span class="file_name">main.controller.js</span></a><a href="../../../client/app/main/main.controller.spec.js.html" class="source "><span class="base_path">client / app / main / </span><span class="file_name">main.controller.spec.js</span></a><a href="../../../client/app/main/main.js.html" class="source "><span class="base_path">client / app / main / </span><span class="file_name">main.js</span></a><a href="../../../client/app/product/product.controller.js.html" class="source "><span class="base_path">client / app / product / </span><span class="file_name">product.controller.js</span></a><a href="../../../client/app/product/product.controller.spec.js.html" class="source "><span class="base_path">client / app / product / </span><span class="file_name">product.controller.spec.js</span></a><a href="../../../client/app/product/product.js.html" class="source "><span class="base_path">client / app / product / </span><span class="file_name">product.js</span></a><a href="../../../client/app/vendor/vendor.controller.js.html" class="source "><span class="base_path">client / app / vendor / </span><span class="file_name">vendor.controller.js</span></a><a href="../../../client/app/vendor/vendor.controller.spec.js.html" class="source "><span class="base_path">client / app / vendor / </span><span class="file_name">vendor.controller.spec.js</span></a><a href="../../../client/app/vendor/vendor.js.html" class="source "><span class="base_path">client / app / vendor / </span><span class="file_name">vendor.js</span></a><a href="../../../client/components/auth/auth.service.js.html" class="source "><span class="base_path">client / components / auth / </span><span class="file_name">auth.service.js</span></a><a href="../../../client/components/auth/user.service.js.html" class="source "><span class="base_path">client / components / auth / </span><span class="file_name">user.service.js</span></a><a href="../../../client/components/auth/vendor/vendor.service.js.html" class="source "><span class="base_path">client / components / auth / vendor / </span><span class="file_name">vendor.service.js</span></a><a href="../../../client/components/auth/vendor/vendor.service.spec.js.html" class="source "><span class="base_path">client / components / auth / vendor / </span><span class="file_name">vendor.service.spec.js</span></a><a href="../../../client/components/modal/modal.service.js.html" class="source "><span class="base_path">client / components / modal / </span><span class="file_name">modal.service.js</span></a><a href="../../../client/components/mongoose-error/mongoose-error.directive.js.html" class="source "><span class="base_path">client / components / mongoose-error / </span><span class="file_name">mongoose-error.directive.js</span></a><a href="../../../client/components/navbar/navbar.controller.js.html" class="source "><span class="base_path">client / components / navbar / </span><span class="file_name">navbar.controller.js</span></a><a href="../../../client/components/socket/socket.io.js.html" class="source selected"><span class="base_path">client / components / socket / </span><span class="file_name">socket.io.js</span></a><a href="../../../client/components/socket/socket.mock.js.html" class="source "><span class="base_path">client / components / socket / </span><span class="file_name">socket.mock.js</span></a><a href="../../../client/components/socket/socket.service.js.html" class="source "><span class="base_path">client / components / socket / </span><span class="file_name">socket.service.js</span></a><a href="../../../karma.conf.js.html" class="source "><span class="base_path">. / </span><span class="file_name">karma.conf.js</span></a><a href="../../../protractor.conf.js.html" class="source "><span class="base_path">. / </span><span class="file_name">protractor.conf.js</span></a><a href="../../../server/api/amazon/index.js.html" class="source "><span class="base_path">server / api / amazon / </span><span class="file_name">index.js</span></a><a href="../../../server/api/amazon/product.controller.js.html" class="source "><span class="base_path">server / api / amazon / </span><span class="file_name">product.controller.js</span></a><a href="../../../server/api/amazon/product.model.js.html" class="source "><span class="base_path">server / api / amazon / </span><span class="file_name">product.model.js</span></a><a href="../../../server/api/amazon/product.socket.js.html" class="source "><span class="base_path">server / api / amazon / </span><span class="file_name">product.socket.js</span></a><a href="../../../server/api/amazon/product.spec.js.html" class="source "><span class="base_path">server / api / amazon / </span><span class="file_name">product.spec.js</span></a><a href="../../../server/api/amazonCart/index.js.html" class="source "><span class="base_path">server / api / amazonCart / </span><span class="file_name">index.js</span></a><a href="../../../server/api/amazonCart/product.controller.js.html" class="source "><span class="base_path">server / api / amazonCart / </span><span class="file_name">product.controller.js</span></a><a href="../../../server/api/amazonCart/product.model.js.html" class="source "><span class="base_path">server / api / amazonCart / </span><span class="file_name">product.model.js</span></a><a href="../../../server/api/amazonCart/product.socket.js.html" class="source "><span class="base_path">server / api / amazonCart / </span><span class="file_name">product.socket.js</span></a><a href="../../../server/api/amazonCart/product.spec.js.html" class="source "><span class="base_path">server / api / amazonCart / </span><span class="file_name">product.spec.js</span></a><a href="../../../server/api/buyer/buyer.controller.js.html" class="source "><span class="base_path">server / api / buyer / </span><span class="file_name">buyer.controller.js</span></a><a href="../../../server/api/buyer/buyer.model.js.html" class="source "><span class="base_path">server / api / buyer / </span><span class="file_name">buyer.model.js</span></a><a href="../../../server/api/buyer/buyer.model.spec.js.html" class="source "><span class="base_path">server / api / buyer / </span><span class="file_name">buyer.model.spec.js</span></a><a href="../../../server/api/buyer/index.js.html" class="source "><span class="base_path">server / api / buyer / </span><span class="file_name">index.js</span></a><a href="../../../server/api/cart/cart.controller.js.html" class="source "><span class="base_path">server / api / cart / </span><span class="file_name">cart.controller.js</span></a><a href="../../../server/api/cart/cart.model.js.html" class="source "><span class="base_path">server / api / cart / </span><span class="file_name">cart.model.js</span></a><a href="../../../server/api/cart/cart.socket.js.html" class="source "><span class="base_path">server / api / cart / </span><span class="file_name">cart.socket.js</span></a><a href="../../../server/api/cart/cart.spec.js.html" class="source "><span class="base_path">server / api / cart / </span><span class="file_name">cart.spec.js</span></a><a href="../../../server/api/cart/index.js.html" class="source "><span class="base_path">server / api / cart / </span><span class="file_name">index.js</span></a><a href="../../../server/api/product/index.js.html" class="source "><span class="base_path">server / api / product / </span><span class="file_name">index.js</span></a><a href="../../../server/api/product/product.controller.js.html" class="source "><span class="base_path">server / api / product / </span><span class="file_name">product.controller.js</span></a><a href="../../../server/api/product/product.model.js.html" class="source "><span class="base_path">server / api / product / </span><span class="file_name">product.model.js</span></a><a href="../../../server/api/product/product.socket.js.html" class="source "><span class="base_path">server / api / product / </span><span class="file_name">product.socket.js</span></a><a href="../../../server/api/product/product.spec.js.html" class="source "><span class="base_path">server / api / product / </span><span class="file_name">product.spec.js</span></a><a href="../../../server/api/showroom/index.js.html" class="source "><span class="base_path">server / api / showroom / </span><span class="file_name">index.js</span></a><a href="../../../server/api/showroom/showroom.controller.js.html" class="source "><span class="base_path">server / api / showroom / </span><span class="file_name">showroom.controller.js</span></a><a href="../../../server/api/showroom/showroom.model.js.html" class="source "><span class="base_path">server / api / showroom / </span><span class="file_name">showroom.model.js</span></a><a href="../../../server/api/showroom/showroom.socket.js.html" class="source "><span class="base_path">server / api / showroom / </span><span class="file_name">showroom.socket.js</span></a><a href="../../../server/api/showroom/showroom.spec.js.html" class="source "><span class="base_path">server / api / showroom / </span><span class="file_name">showroom.spec.js</span></a><a href="../../../server/api/thing/index.js.html" class="source "><span class="base_path">server / api / thing / </span><span class="file_name">index.js</span></a><a href="../../../server/api/thing/thing.controller.js.html" class="source "><span class="base_path">server / api / thing / </span><span class="file_name">thing.controller.js</span></a><a href="../../../server/api/thing/thing.model.js.html" class="source "><span class="base_path">server / api / thing / </span><span class="file_name">thing.model.js</span></a><a href="../../../server/api/thing/thing.socket.js.html" class="source "><span class="base_path">server / api / thing / </span><span class="file_name">thing.socket.js</span></a><a href="../../../server/api/thing/thing.spec.js.html" class="source "><span class="base_path">server / api / thing / </span><span class="file_name">thing.spec.js</span></a><a href="../../../server/api/user/index.js.html" class="source "><span class="base_path">server / api / user / </span><span class="file_name">index.js</span></a><a href="../../../server/api/user/user.controller.js.html" class="source "><span class="base_path">server / api / user / </span><span class="file_name">user.controller.js</span></a><a href="../../../server/api/user/user.model.js.html" class="source "><span class="base_path">server / api / user / </span><span class="file_name">user.model.js</span></a><a href="../../../server/api/user/user.model.spec.js.html" class="source "><span class="base_path">server / api / user / </span><span class="file_name">user.model.spec.js</span></a><a href="../../../server/api/vendor/index.js.html" class="source "><span class="base_path">server / api / vendor / </span><span class="file_name">index.js</span></a><a href="../../../server/api/vendor/vendor.controller.js.html" class="source "><span class="base_path">server / api / vendor / </span><span class="file_name">vendor.controller.js</span></a><a href="../../../server/api/vendor/vendor.model.js.html" class="source "><span class="base_path">server / api / vendor / </span><span class="file_name">vendor.model.js</span></a><a href="../../../server/api/vendor/vendor.socket.js.html" class="source "><span class="base_path">server / api / vendor / </span><span class="file_name">vendor.socket.js</span></a><a href="../../../server/api/vendor/vendor.spec.js.html" class="source "><span class="base_path">server / api / vendor / </span><span class="file_name">vendor.spec.js</span></a><a href="../../../server/app.js.html" class="source "><span class="base_path">server / </span><span class="file_name">app.js</span></a><a href="../../../server/auth/auth.service.js.html" class="source "><span class="base_path">server / auth / </span><span class="file_name">auth.service.js</span></a><a href="../../../server/auth/facebook/index.js.html" class="source "><span class="base_path">server / auth / facebook / </span><span class="file_name">index.js</span></a><a href="../../../server/auth/facebook/passport.js.html" class="source "><span class="base_path">server / auth / facebook / </span><span class="file_name">passport.js</span></a><a href="../../../server/auth/google/index.js.html" class="source "><span class="base_path">server / auth / google / </span><span class="file_name">index.js</span></a><a href="../../../server/auth/google/passport.js.html" class="source "><span class="base_path">server / auth / google / </span><span class="file_name">passport.js</span></a><a href="../../../server/auth/index.js.html" class="source "><span class="base_path">server / auth / </span><span class="file_name">index.js</span></a><a href="../../../server/auth/local/index.js.html" class="source "><span class="base_path">server / auth / local / </span><span class="file_name">index.js</span></a><a href="../../../server/auth/local/passport.js.html" class="source "><span class="base_path">server / auth / local / </span><span class="file_name">passport.js</span></a><a href="../../../server/auth/twitter/index.js.html" class="source "><span class="base_path">server / auth / twitter / </span><span class="file_name">index.js</span></a><a href="../../../server/auth/twitter/passport.js.html" class="source "><span class="base_path">server / auth / twitter / </span><span class="file_name">passport.js</span></a><a href="../../../server/components/errors/index.js.html" class="source "><span class="base_path">server / components / errors / </span><span class="file_name">index.js</span></a><a href="../../../server/config/environment/development.js.html" class="source "><span class="base_path">server / config / environment / </span><span class="file_name">development.js</span></a><a href="../../../server/config/environment/index.js.html" class="source "><span class="base_path">server / config / environment / </span><span class="file_name">index.js</span></a><a href="../../../server/config/environment/production.js.html" class="source "><span class="base_path">server / config / environment / </span><span class="file_name">production.js</span></a><a href="../../../server/config/environment/test.js.html" class="source "><span class="base_path">server / config / environment / </span><span class="file_name">test.js</span></a><a href="../../../server/config/express.js.html" class="source "><span class="base_path">server / config / </span><span class="file_name">express.js</span></a><a href="../../../server/config/local.env.js.html" class="source "><span class="base_path">server / config / </span><span class="file_name">local.env.js</span></a><a href="../../../server/config/seed.js.html" class="source "><span class="base_path">server / config / </span><span class="file_name">seed.js</span></a><a href="../../../server/config/socketio.js.html" class="source "><span class="base_path">server / config / </span><span class="file_name">socketio.js</span></a><a href="../../../server/routes.js.html" class="source "><span class="base_path">server / </span><span class="file_name">routes.js</span></a><a href="../../../server.js.html" class="source "><span class="base_path">. / </span><span class="file_name">server.js</span></a></div></div></div><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>socket.io.js</h1><div class="filepath">client/components/socket/</div></th><th class="code"></th></tr></thead><tbody><tr id="section-1"><td class="docs"><div class="pilwrap"><a href="#section-1" class="pilcrow">&#182;</a></div>
</td><td class="code"><div class="highlight"><pre><span class="o">!</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;object&quot;</span><span class="o">==</span><span class="k">typeof</span> <span class="nx">exports</span><span class="o">&amp;&amp;</span><span class="s2">&quot;undefined&quot;</span><span class="o">!=</span><span class="k">typeof</span> <span class="nx">module</span><span class="p">)</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="nx">e</span><span class="p">();</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="s2">&quot;function&quot;</span><span class="o">==</span><span class="k">typeof</span> <span class="nx">define</span><span class="o">&amp;&amp;</span><span class="nx">define</span><span class="p">.</span><span class="nx">amd</span><span class="p">)</span><span class="nx">define</span><span class="p">([],</span><span class="nx">e</span><span class="p">);</span><span class="k">else</span><span class="p">{</span><span class="kd">var</span> <span class="nx">f</span><span class="p">;</span><span class="s2">&quot;undefined&quot;</span><span class="o">!=</span><span class="k">typeof</span> <span class="nb">window</span><span class="o">?</span><span class="nx">f</span><span class="o">=</span><span class="nb">window</span><span class="o">:</span><span class="s2">&quot;undefined&quot;</span><span class="o">!=</span><span class="k">typeof</span> <span class="nx">global</span><span class="o">?</span><span class="nx">f</span><span class="o">=</span><span class="nx">global</span><span class="o">:</span><span class="s2">&quot;undefined&quot;</span><span class="o">!=</span><span class="k">typeof</span> <span class="nx">self</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="nx">f</span><span class="o">=</span><span class="nx">self</span><span class="p">),</span><span class="nx">f</span><span class="p">.</span><span class="nx">io</span><span class="o">=</span><span class="nx">e</span><span class="p">()}}(</span><span class="kd">function</span><span class="p">(){</span><span class="kd">var</span> <span class="nx">define</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">;</span><span class="k">return</span> <span class="p">(</span><span class="kd">function</span> <span class="nx">e</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="nx">n</span><span class="p">,</span><span class="nx">r</span><span class="p">){</span><span class="kd">function</span> <span class="nx">s</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span><span class="nx">u</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">n</span><span class="p">[</span><span class="nx">o</span><span class="p">]){</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">t</span><span class="p">[</span><span class="nx">o</span><span class="p">]){</span><span class="kd">var</span> <span class="nx">a</span><span class="o">=</span><span class="k">typeof</span> <span class="nx">require</span><span class="o">==</span><span class="s2">&quot;function&quot;</span><span class="o">&amp;&amp;</span><span class="nx">require</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">u</span><span class="o">&amp;&amp;</span><span class="nx">a</span><span class="p">)</span><span class="k">return</span> <span class="nx">a</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span><span class="o">!</span><span class="mi">0</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span><span class="k">return</span> <span class="nx">i</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span><span class="o">!</span><span class="mi">0</span><span class="p">);</span><span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Cannot find module &#39;&quot;</span><span class="o">+</span><span class="nx">o</span><span class="o">+</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)}</span><span class="kd">var</span> <span class="nx">f</span><span class="o">=</span><span class="nx">n</span><span class="p">[</span><span class="nx">o</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="nx">exports</span><span class="o">:</span><span class="p">{}};</span><span class="nx">t</span><span class="p">[</span><span class="nx">o</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="nx">call</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">exports</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span><span class="kd">var</span> <span class="nx">n</span><span class="o">=</span><span class="nx">t</span><span class="p">[</span><span class="nx">o</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="nx">e</span><span class="p">];</span><span class="k">return</span> <span class="nx">s</span><span class="p">(</span><span class="nx">n</span><span class="o">?</span><span class="nx">n</span><span class="o">:</span><span class="nx">e</span><span class="p">)},</span><span class="nx">f</span><span class="p">,</span><span class="nx">f</span><span class="p">.</span><span class="nx">exports</span><span class="p">,</span><span class="nx">e</span><span class="p">,</span><span class="nx">t</span><span class="p">,</span><span class="nx">n</span><span class="p">,</span><span class="nx">r</span><span class="p">)}</span><span class="k">return</span> <span class="nx">n</span><span class="p">[</span><span class="nx">o</span><span class="p">].</span><span class="nx">exports</span><span class="p">}</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="k">typeof</span> <span class="nx">require</span><span class="o">==</span><span class="s2">&quot;function&quot;</span><span class="o">&amp;&amp;</span><span class="nx">require</span><span class="p">;</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">o</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">o</span><span class="o">&lt;</span><span class="nx">r</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">o</span><span class="o">++</span><span class="p">)</span><span class="nx">s</span><span class="p">(</span><span class="nx">r</span><span class="p">[</span><span class="nx">o</span><span class="p">]);</span><span class="k">return</span> <span class="nx">s</span><span class="p">})({</span><span class="mi">1</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;./lib/&#39;</span><span class="p">);</span>

<span class="p">},{</span><span class="s2">&quot;./lib/&quot;</span><span class="o">:</span><span class="mi">2</span><span class="p">}],</span><span class="mi">2</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span></pre></div></td></tr><tr id="section-2"><td class="docs"><div class="pilwrap"><a href="#section-2" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Module dependencies.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;./url&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">parser</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;socket.io-parser&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">Manager</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;./manager&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">debug</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">)(</span><span class="s1">&#39;socket.io-client&#39;</span><span class="p">);</span></pre></div></td></tr><tr id="section-3"><td class="docs"><div class="pilwrap"><a href="#section-3" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Module exports.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">exports</span> <span class="o">=</span> <span class="nx">lookup</span><span class="p">;</span></pre></div></td></tr><tr id="section-4"><td class="docs"><div class="pilwrap"><a href="#section-4" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Managers cache.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">cache</span> <span class="o">=</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">managers</span> <span class="o">=</span> <span class="p">{};</span></pre></div></td></tr><tr id="section-5"><td class="docs"><div class="pilwrap"><a href="#section-5" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Looks up an existing <code>Manager</code> for multiplexing.</p>

<h2>If the user summons</h2></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"><p><code>io('<a href='http://localhost/a'>http://localhost/a</a>');</code><br />  <code>io('<a href='http://localhost/b'>http://localhost/b</a>');</code></p>

<p>We reuse the existing instance based on same scheme/port/host,<br />and we initialize sockets for each namespace.</p></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">lookup</span><span class="p">(</span><span class="nx">uri</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">uri</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">opts</span> <span class="o">=</span> <span class="nx">uri</span><span class="p">;</span>
    <span class="nx">uri</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">opts</span> <span class="o">=</span> <span class="nx">opts</span> <span class="o">||</span> <span class="p">{};</span>

  <span class="kd">var</span> <span class="nx">parsed</span> <span class="o">=</span> <span class="nx">url</span><span class="p">(</span><span class="nx">uri</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">source</span> <span class="o">=</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">source</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">io</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">forceNew</span> <span class="o">||</span> <span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;force new connection&#39;</span><span class="p">]</span> <span class="o">||</span> <span class="kc">false</span> <span class="o">===</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">multiplex</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;ignoring socket cache for %s&#39;</span><span class="p">,</span> <span class="nx">source</span><span class="p">);</span>
    <span class="nx">io</span> <span class="o">=</span> <span class="nx">Manager</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">cache</span><span class="p">[</span><span class="nx">id</span><span class="p">])</span> <span class="p">{</span>
      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;new io instance for %s&#39;</span><span class="p">,</span> <span class="nx">source</span><span class="p">);</span>
      <span class="nx">cache</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Manager</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">io</span> <span class="o">=</span> <span class="nx">cache</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">io</span><span class="p">.</span><span class="nx">socket</span><span class="p">(</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">path</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-6"><td class="docs"><div class="pilwrap"><a href="#section-6" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Protocol version.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">=</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">protocol</span><span class="p">;</span></pre></div></td></tr><tr id="section-7"><td class="docs"><div class="pilwrap"><a href="#section-7" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p><code>connect</code>.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>uri </span><span class="dox_type">String</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">connect</span> <span class="o">=</span> <span class="nx">lookup</span><span class="p">;</span></pre></div></td></tr><tr id="section-8"><td class="docs"><div class="pilwrap"><a href="#section-8" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Expose constructors for standalone build.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">Manager</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;./manager&#39;</span><span class="p">);</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">Socket</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;./socket&#39;</span><span class="p">);</span>

<span class="p">},{</span><span class="s2">&quot;./manager&quot;</span><span class="o">:</span><span class="mi">3</span><span class="p">,</span><span class="s2">&quot;./socket&quot;</span><span class="o">:</span><span class="mi">5</span><span class="p">,</span><span class="s2">&quot;./url&quot;</span><span class="o">:</span><span class="mi">6</span><span class="p">,</span><span class="s2">&quot;debug&quot;</span><span class="o">:</span><span class="mi">10</span><span class="p">,</span><span class="s2">&quot;socket.io-parser&quot;</span><span class="o">:</span><span class="mi">46</span><span class="p">}],</span><span class="mi">3</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span></pre></div></td></tr><tr id="section-9"><td class="docs"><div class="pilwrap"><a href="#section-9" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Module dependencies.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;./url&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">eio</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;engine.io-client&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">Socket</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;./socket&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">Emitter</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;component-emitter&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">parser</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;socket.io-parser&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">on</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;./on&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">bind</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;component-bind&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">object</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;object-component&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">debug</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">)(</span><span class="s1">&#39;socket.io-client:manager&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">indexOf</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;indexof&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">Backoff</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;backo2&#39;</span><span class="p">);</span></pre></div></td></tr><tr id="section-10"><td class="docs"><div class="pilwrap"><a href="#section-10" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Module exports</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Manager</span><span class="p">;</span></pre></div></td></tr><tr id="section-11"><td class="docs"><div class="pilwrap"><a href="#section-11" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p><code>Manager</code> constructor.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>engine </span><span class="dox_type">String</span><span>- instance or engine uri/opts</span></div><div class="dox_tag_detail"><span>options </span><span class="dox_type">Object</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">Manager</span><span class="p">(</span><span class="nx">uri</span><span class="p">,</span> <span class="nx">opts</span><span class="p">){</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="k">this</span> <span class="k">instanceof</span> <span class="nx">Manager</span><span class="p">))</span> <span class="k">return</span> <span class="k">new</span> <span class="nx">Manager</span><span class="p">(</span><span class="nx">uri</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">uri</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="s1">&#39;object&#39;</span> <span class="o">==</span> <span class="k">typeof</span> <span class="nx">uri</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">opts</span> <span class="o">=</span> <span class="nx">uri</span><span class="p">;</span>
    <span class="nx">uri</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">opts</span> <span class="o">=</span> <span class="nx">opts</span> <span class="o">||</span> <span class="p">{};</span>

  <span class="nx">opts</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">path</span> <span class="o">||</span> <span class="s1">&#39;/socket.io&#39;</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">nsps</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">subs</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">opts</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">reconnection</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">reconnection</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">reconnectionAttempts</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">reconnectionAttempts</span> <span class="o">||</span> <span class="kc">Infinity</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">reconnectionDelay</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">reconnectionDelay</span> <span class="o">||</span> <span class="mi">1000</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">reconnectionDelayMax</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">reconnectionDelayMax</span> <span class="o">||</span> <span class="mi">5000</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">randomizationFactor</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">randomizationFactor</span> <span class="o">||</span> <span class="mf">0.5</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">backoff</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backoff</span><span class="p">({</span>
    <span class="nx">min</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">reconnectionDelay</span><span class="p">(),</span>
    <span class="nx">max</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">reconnectionDelayMax</span><span class="p">(),</span>
    <span class="nx">jitter</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">randomizationFactor</span><span class="p">()</span>
  <span class="p">});</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">timeout</span><span class="p">(</span><span class="kc">null</span> <span class="o">==</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">timeout</span> <span class="o">?</span> <span class="mi">20000</span> <span class="o">:</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">timeout</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">=</span> <span class="s1">&#39;closed&#39;</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">uri</span> <span class="o">=</span> <span class="nx">uri</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">connected</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">encoding</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">packetBuffer</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">encoder</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">Encoder</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">decoder</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">Decoder</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">autoConnect</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">autoConnect</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">autoConnect</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">open</span><span class="p">();</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-12"><td class="docs"><div class="pilwrap"><a href="#section-12" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Propagate given event to sockets and emit on <code>this</code></p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">emitAll</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">nsp</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">nsps</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">nsps</span><span class="p">[</span><span class="nx">nsp</span><span class="p">].</span><span class="nx">emit</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">nsps</span><span class="p">[</span><span class="nx">nsp</span><span class="p">],</span> <span class="nx">arguments</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-13"><td class="docs"><div class="pilwrap"><a href="#section-13" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Update <code>socket.id</code> of all sockets</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">updateSocketIds</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">nsp</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">nsps</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">nsps</span><span class="p">[</span><span class="nx">nsp</span><span class="p">].</span><span class="nx">id</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">engine</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-14"><td class="docs"><div class="pilwrap"><a href="#section-14" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Mix in <code>Emitter</code>.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Emitter</span><span class="p">(</span><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span></pre></div></td></tr><tr id="section-15"><td class="docs"><div class="pilwrap"><a href="#section-15" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Sets the <code>reconnection</code> config.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>true/false </span><span class="dox_type">Boolean</span><span>- if it should automatically reconnect</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Manager</span><span>self or value</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">reconnection</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">){</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_reconnection</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_reconnection</span> <span class="o">=</span> <span class="o">!!</span><span class="nx">v</span><span class="p">;</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-16"><td class="docs"><div class="pilwrap"><a href="#section-16" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Sets the reconnection attempts config.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>max </span><span class="dox_type">Number</span><span>- reconnection attempts before giving up</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Manager</span><span>self or value</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">reconnectionAttempts</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">){</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_reconnectionAttempts</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_reconnectionAttempts</span> <span class="o">=</span> <span class="nx">v</span><span class="p">;</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-17"><td class="docs"><div class="pilwrap"><a href="#section-17" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Sets the delay between reconnections.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>delay </span><span class="dox_type">Number</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Manager</span><span>self or value</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">reconnectionDelay</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">){</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_reconnectionDelay</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_reconnectionDelay</span> <span class="o">=</span> <span class="nx">v</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">backoff</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">backoff</span><span class="p">.</span><span class="nx">setMin</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">randomizationFactor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">){</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_randomizationFactor</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_randomizationFactor</span> <span class="o">=</span> <span class="nx">v</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">backoff</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">backoff</span><span class="p">.</span><span class="nx">setJitter</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-18"><td class="docs"><div class="pilwrap"><a href="#section-18" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Sets the maximum delay between reconnections.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>delay </span><span class="dox_type">Number</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Manager</span><span>self or value</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">reconnectionDelayMax</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">){</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_reconnectionDelayMax</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_reconnectionDelayMax</span> <span class="o">=</span> <span class="nx">v</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">backoff</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">backoff</span><span class="p">.</span><span class="nx">setMax</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-19"><td class="docs"><div class="pilwrap"><a href="#section-19" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Sets the connection timeout. <code>false</code> to disable</p></div><div class="details"><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Manager</span><span>self or value</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">timeout</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">){</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_timeout</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_timeout</span> <span class="o">=</span> <span class="nx">v</span><span class="p">;</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-20"><td class="docs"><div class="pilwrap"><a href="#section-20" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Starts trying to reconnect if reconnection is enabled and we have not<br />started reconnecting yet</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">maybeReconnectOnOpen</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div></td></tr><tr id="section-21"><td class="docs"><div class="pilwrap"><a href="#section-21" class="pilcrow">&#182;</a></div><p>Only try to reconnect if it's the first time we're connecting</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">reconnecting</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">_reconnection</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">backoff</span><span class="p">.</span><span class="nx">attempts</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-22"><td class="docs"><div class="pilwrap"><a href="#section-22" class="pilcrow">&#182;</a></div><p>keeps reconnection from firing twice for the same reconnection loop</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">reconnect</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-23"><td class="docs"><div class="pilwrap"><a href="#section-23" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Sets the current transport <code>socket</code>.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>optional, </span><span class="dox_type">Function</span><span>- callback</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Manager</span><span>self</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">open</span> <span class="o">=</span>
<span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">connect</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fn</span><span class="p">){</span>
  <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;readyState %s&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">~</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">))</span> <span class="k">return</span> <span class="k">this</span><span class="p">;</span>

  <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;opening %s&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">engine</span> <span class="o">=</span> <span class="nx">eio</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">uri</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">opts</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">socket</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">engine</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">=</span> <span class="s1">&#39;opening&#39;</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">skipReconnect</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></pre></div></td></tr><tr id="section-24"><td class="docs"><div class="pilwrap"><a href="#section-24" class="pilcrow">&#182;</a></div><p>emit <code>open</code></p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">openSub</span> <span class="o">=</span> <span class="nx">on</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">onopen</span><span class="p">();</span>
    <span class="nx">fn</span> <span class="o">&amp;&amp;</span> <span class="nx">fn</span><span class="p">();</span>
  <span class="p">});</span></pre></div></td></tr><tr id="section-25"><td class="docs"><div class="pilwrap"><a href="#section-25" class="pilcrow">&#182;</a></div><p>emit <code>connect_error</code></p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">errorSub</span> <span class="o">=</span> <span class="nx">on</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;connect_error&#39;</span><span class="p">);</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">cleanup</span><span class="p">();</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">=</span> <span class="s1">&#39;closed&#39;</span><span class="p">;</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">emitAll</span><span class="p">(</span><span class="s1">&#39;connect_error&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">err</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Connection error&#39;</span><span class="p">);</span>
      <span class="nx">err</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
      <span class="nx">fn</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr><tr id="section-26"><td class="docs"><div class="pilwrap"><a href="#section-26" class="pilcrow">&#182;</a></div><p>Only do this if there is no fn to handle the error</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">self</span><span class="p">.</span><span class="nx">maybeReconnectOnOpen</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">});</span></pre></div></td></tr><tr id="section-27"><td class="docs"><div class="pilwrap"><a href="#section-27" class="pilcrow">&#182;</a></div><p>emit <code>connect_timeout</code></p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="kc">false</span> <span class="o">!==</span> <span class="k">this</span><span class="p">.</span><span class="nx">_timeout</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">timeout</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_timeout</span><span class="p">;</span>
    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;connect attempt will timeout after %d&#39;</span><span class="p">,</span> <span class="nx">timeout</span><span class="p">);</span></pre></div></td></tr><tr id="section-28"><td class="docs"><div class="pilwrap"><a href="#section-28" class="pilcrow">&#182;</a></div><p>set timer</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">timer</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;connect attempt timed out after %d&#39;</span><span class="p">,</span> <span class="nx">timeout</span><span class="p">);</span>
      <span class="nx">openSub</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
      <span class="nx">socket</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
      <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;timeout&#39;</span><span class="p">);</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">emitAll</span><span class="p">(</span><span class="s1">&#39;connect_timeout&#39;</span><span class="p">,</span> <span class="nx">timeout</span><span class="p">);</span>
    <span class="p">},</span> <span class="nx">timeout</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">subs</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
      <span class="nx">destroy</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">timer</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">subs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">openSub</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">subs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">errorSub</span><span class="p">);</span>

  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-29"><td class="docs"><div class="pilwrap"><a href="#section-29" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Called upon transport open.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onopen</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">);</span></pre></div></td></tr><tr id="section-30"><td class="docs"><div class="pilwrap"><a href="#section-30" class="pilcrow">&#182;</a></div><p>clear old subs</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">cleanup</span><span class="p">();</span></pre></div></td></tr><tr id="section-31"><td class="docs"><div class="pilwrap"><a href="#section-31" class="pilcrow">&#182;</a></div><p>mark as open</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">=</span> <span class="s1">&#39;open&#39;</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">);</span></pre></div></td></tr><tr id="section-32"><td class="docs"><div class="pilwrap"><a href="#section-32" class="pilcrow">&#182;</a></div><p>add new subs</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">socket</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">engine</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">subs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">on</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;ondata&#39;</span><span class="p">)));</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">subs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">on</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">decoder</span><span class="p">,</span> <span class="s1">&#39;decoded&#39;</span><span class="p">,</span> <span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;ondecoded&#39;</span><span class="p">)));</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">subs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">on</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;onerror&#39;</span><span class="p">)));</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">subs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">on</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;onclose&#39;</span><span class="p">)));</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-33"><td class="docs"><div class="pilwrap"><a href="#section-33" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Called with data.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">ondata</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">decoder</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-34"><td class="docs"><div class="pilwrap"><a href="#section-34" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Called when parser fully decodes a packet.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">ondecoded</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">packet</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;packet&#39;</span><span class="p">,</span> <span class="nx">packet</span><span class="p">);</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-35"><td class="docs"><div class="pilwrap"><a href="#section-35" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Called upon socket error.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
  <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">emitAll</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-36"><td class="docs"><div class="pilwrap"><a href="#section-36" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Creates a new socket for the given <code>nsp</code>.</p></div><div class="details"><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Socket</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">socket</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">nsp</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">socket</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">nsps</span><span class="p">[</span><span class="nx">nsp</span><span class="p">];</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Socket</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">nsp</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">nsps</span><span class="p">[</span><span class="nx">nsp</span><span class="p">]</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connect&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="nx">socket</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">engine</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!~</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">connected</span><span class="p">,</span> <span class="nx">socket</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">connected</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">socket</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">socket</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-37"><td class="docs"><div class="pilwrap"><a href="#section-37" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Called upon a socket close.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>socket </span><span class="dox_type">Socket</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">destroy</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">socket</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">indexOf</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">connected</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">~</span><span class="nx">index</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">connected</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">connected</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-38"><td class="docs"><div class="pilwrap"><a href="#section-38" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Writes a packet.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>packet </span><span class="dox_type">Object</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">packet</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">packet</span><span class="p">){</span>
  <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;writing packet %j&#39;</span><span class="p">,</span> <span class="nx">packet</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">encoding</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-39"><td class="docs"><div class="pilwrap"><a href="#section-39" class="pilcrow">&#182;</a></div><p>encode, then write to engine with result</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">self</span><span class="p">.</span><span class="nx">encoding</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">encoder</span><span class="p">.</span><span class="nx">encode</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">encodedPackets</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">encodedPackets</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">engine</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">encodedPackets</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
      <span class="p">}</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">encoding</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">processPacketQueue</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// add packet to the queue</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">packetBuffer</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">packet</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-40"><td class="docs"><div class="pilwrap"><a href="#section-40" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>If packet buffer is non-empty, begins encoding the<br />next packet in line.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">processPacketQueue</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">packetBuffer</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">encoding</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">pack</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">packetBuffer</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">packet</span><span class="p">(</span><span class="nx">pack</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-41"><td class="docs"><div class="pilwrap"><a href="#section-41" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Clean up transport subscriptions and packet buffer.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">cleanup</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="kd">var</span> <span class="nx">sub</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="nx">sub</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">subs</span><span class="p">.</span><span class="nx">shift</span><span class="p">())</span> <span class="nx">sub</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">packetBuffer</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">encoding</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">decoder</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-42"><td class="docs"><div class="pilwrap"><a href="#section-42" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Close the current socket.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">close</span> <span class="o">=</span>
<span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">disconnect</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">skipReconnect</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">backoff</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">=</span> <span class="s1">&#39;closed&#39;</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">engine</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">engine</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-43"><td class="docs"><div class="pilwrap"><a href="#section-43" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Called upon engine close.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onclose</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">reason</span><span class="p">){</span>
  <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">cleanup</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">backoff</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">=</span> <span class="s1">&#39;closed&#39;</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="nx">reason</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_reconnection</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">skipReconnect</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">reconnect</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-44"><td class="docs"><div class="pilwrap"><a href="#section-44" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Attempt a reconnection.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">reconnect</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">reconnecting</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">skipReconnect</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">backoff</span><span class="p">.</span><span class="nx">attempts</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_reconnectionAttempts</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;reconnect failed&#39;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">backoff</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">emitAll</span><span class="p">(</span><span class="s1">&#39;reconnect_failed&#39;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">reconnecting</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">delay</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">backoff</span><span class="p">.</span><span class="nx">duration</span><span class="p">();</span>
    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;will wait %dms before reconnect attempt&#39;</span><span class="p">,</span> <span class="nx">delay</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">reconnecting</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">timer</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">skipReconnect</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;attempting reconnect&#39;</span><span class="p">);</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">emitAll</span><span class="p">(</span><span class="s1">&#39;reconnect_attempt&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">backoff</span><span class="p">.</span><span class="nx">attempts</span><span class="p">);</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">emitAll</span><span class="p">(</span><span class="s1">&#39;reconnecting&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">backoff</span><span class="p">.</span><span class="nx">attempts</span><span class="p">);</span></pre></div></td></tr><tr id="section-45"><td class="docs"><div class="pilwrap"><a href="#section-45" class="pilcrow">&#182;</a></div><p>check again for the case socket closed in above events</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">skipReconnect</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

      <span class="nx">self</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;reconnect attempt error&#39;</span><span class="p">);</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">reconnecting</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">reconnect</span><span class="p">();</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">emitAll</span><span class="p">(</span><span class="s1">&#39;reconnect_error&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;reconnect success&#39;</span><span class="p">);</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">onreconnect</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">},</span> <span class="nx">delay</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">subs</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
      <span class="nx">destroy</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">timer</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-46"><td class="docs"><div class="pilwrap"><a href="#section-46" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Called upon successful reconnect.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onreconnect</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="kd">var</span> <span class="nx">attempt</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">backoff</span><span class="p">.</span><span class="nx">attempts</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">reconnecting</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">backoff</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">updateSocketIds</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">emitAll</span><span class="p">(</span><span class="s1">&#39;reconnect&#39;</span><span class="p">,</span> <span class="nx">attempt</span><span class="p">);</span>
<span class="p">};</span>

<span class="p">},{</span><span class="s2">&quot;./on&quot;</span><span class="o">:</span><span class="mi">4</span><span class="p">,</span><span class="s2">&quot;./socket&quot;</span><span class="o">:</span><span class="mi">5</span><span class="p">,</span><span class="s2">&quot;./url&quot;</span><span class="o">:</span><span class="mi">6</span><span class="p">,</span><span class="s2">&quot;backo2&quot;</span><span class="o">:</span><span class="mi">7</span><span class="p">,</span><span class="s2">&quot;component-bind&quot;</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="s2">&quot;component-emitter&quot;</span><span class="o">:</span><span class="mi">9</span><span class="p">,</span><span class="s2">&quot;debug&quot;</span><span class="o">:</span><span class="mi">10</span><span class="p">,</span><span class="s2">&quot;engine.io-client&quot;</span><span class="o">:</span><span class="mi">11</span><span class="p">,</span><span class="s2">&quot;indexof&quot;</span><span class="o">:</span><span class="mi">42</span><span class="p">,</span><span class="s2">&quot;object-component&quot;</span><span class="o">:</span><span class="mi">43</span><span class="p">,</span><span class="s2">&quot;socket.io-parser&quot;</span><span class="o">:</span><span class="mi">46</span><span class="p">}],</span><span class="mi">4</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span></pre></div></td></tr><tr id="section-47"><td class="docs"><div class="pilwrap"><a href="#section-47" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Module exports.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">on</span><span class="p">;</span></pre></div></td></tr><tr id="section-48"><td class="docs"><div class="pilwrap"><a href="#section-48" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Helper for subscriptions.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>obj </span><span class="dox_type">Object</span><span class="dox_type">EventEmitter</span><span>- with `Emitter` mixin or `EventEmitter`</span></div><div class="dox_tag_detail"><span>event </span><span class="dox_type">String</span><span>- name</span></div><div class="dox_tag_detail"><span>callback </span><span class="dox_type">Function</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">on</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">ev</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">obj</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">ev</span><span class="p">,</span> <span class="nx">fn</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">destroy</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="nx">obj</span><span class="p">.</span><span class="nx">removeListener</span><span class="p">(</span><span class="nx">ev</span><span class="p">,</span> <span class="nx">fn</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="p">},{}],</span><span class="mi">5</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span></pre></div></td></tr><tr id="section-49"><td class="docs"><div class="pilwrap"><a href="#section-49" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Module dependencies.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">parser</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;socket.io-parser&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">Emitter</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;component-emitter&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">toArray</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;to-array&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">on</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;./on&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">bind</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;component-bind&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">debug</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">)(</span><span class="s1">&#39;socket.io-client:socket&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">hasBin</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;has-binary&#39;</span><span class="p">);</span></pre></div></td></tr><tr id="section-50"><td class="docs"><div class="pilwrap"><a href="#section-50" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Module exports.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">exports</span> <span class="o">=</span> <span class="nx">Socket</span><span class="p">;</span></pre></div></td></tr><tr id="section-51"><td class="docs"><div class="pilwrap"><a href="#section-51" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Internal events (blacklisted).<br />These events can't be emitted by the user.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">events</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">connect</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nx">connect_error</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nx">connect_timeout</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nx">disconnect</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nx">error</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nx">reconnect</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nx">reconnect_attempt</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nx">reconnect_failed</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nx">reconnect_error</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nx">reconnecting</span><span class="o">:</span> <span class="mi">1</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-52"><td class="docs"><div class="pilwrap"><a href="#section-52" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Shortcut to <code>Emitter#emit</code>.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">emit</span> <span class="o">=</span> <span class="nx">Emitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">emit</span><span class="p">;</span></pre></div></td></tr><tr id="section-53"><td class="docs"><div class="pilwrap"><a href="#section-53" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p><code>Socket</code> constructor.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">Socket</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">nsp</span><span class="p">){</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">io</span> <span class="o">=</span> <span class="nx">io</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">nsp</span> <span class="o">=</span> <span class="nx">nsp</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">json</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span> <span class="c1">// compat</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">ids</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">acks</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nx">autoConnect</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">open</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">receiveBuffer</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">sendBuffer</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">connected</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">disconnected</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-54"><td class="docs"><div class="pilwrap"><a href="#section-54" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Mix in <code>Emitter</code>.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Emitter</span><span class="p">(</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span></pre></div></td></tr><tr id="section-55"><td class="docs"><div class="pilwrap"><a href="#section-55" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Subscribe to open, close and packet events</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">subEvents</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">subs</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">io</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">io</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">subs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="nx">on</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;onopen&#39;</span><span class="p">)),</span>
    <span class="nx">on</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="s1">&#39;packet&#39;</span><span class="p">,</span> <span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;onpacket&#39;</span><span class="p">)),</span>
    <span class="nx">on</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;onclose&#39;</span><span class="p">))</span>
  <span class="p">];</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-56"><td class="docs"><div class="pilwrap"><a href="#section-56" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>"Opens" the socket.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">open</span> <span class="o">=</span>
<span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">connect</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">connected</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">;</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">subEvents</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nx">open</span><span class="p">();</span> <span class="c1">// ensure open</span>
  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;open&#39;</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nx">readyState</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">onopen</span><span class="p">();</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-57"><td class="docs"><div class="pilwrap"><a href="#section-57" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Sends a <code>message</code> event.</p></div><div class="details"><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Socket</span><span>self</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">send</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">toArray</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
  <span class="nx">args</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-58"><td class="docs"><div class="pilwrap"><a href="#section-58" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Override <code>emit</code>.<br />If the event is in <code>events</code>, it's emitted normally.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>event </span><span class="dox_type">String</span><span>- name</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Socket</span><span>self</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">emit</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ev</span><span class="p">){</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">events</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">ev</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">emit</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">toArray</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">parserType</span> <span class="o">=</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">EVENT</span><span class="p">;</span> <span class="c1">// default</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">hasBin</span><span class="p">(</span><span class="nx">args</span><span class="p">))</span> <span class="p">{</span> <span class="nx">parserType</span> <span class="o">=</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">BINARY_EVENT</span><span class="p">;</span> <span class="p">}</span> <span class="c1">// binary</span>
  <span class="kd">var</span> <span class="nx">packet</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">parserType</span><span class="p">,</span> <span class="nx">data</span><span class="o">:</span> <span class="nx">args</span> <span class="p">};</span></pre></div></td></tr><tr id="section-59"><td class="docs"><div class="pilwrap"><a href="#section-59" class="pilcrow">&#182;</a></div><p>event ack callback</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;function&#39;</span> <span class="o">==</span> <span class="k">typeof</span> <span class="nx">args</span><span class="p">[</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;emitting packet with ack id %d&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">ids</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">acks</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">ids</span><span class="p">]</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
    <span class="nx">packet</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ids</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">connected</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">packet</span><span class="p">(</span><span class="nx">packet</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">sendBuffer</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">packet</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-60"><td class="docs"><div class="pilwrap"><a href="#section-60" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Sends a packet.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>packet </span><span class="dox_type">Object</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">packet</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">packet</span><span class="p">){</span>
  <span class="nx">packet</span><span class="p">.</span><span class="nx">nsp</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">nsp</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nx">packet</span><span class="p">(</span><span class="nx">packet</span><span class="p">);</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-61"><td class="docs"><div class="pilwrap"><a href="#section-61" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Called upon engine <code>open</code>.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onopen</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;transport is open - connecting&#39;</span><span class="p">);</span></pre></div></td></tr><tr id="section-62"><td class="docs"><div class="pilwrap"><a href="#section-62" class="pilcrow">&#182;</a></div><p>write connect packet if necessary</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;/&#39;</span> <span class="o">!=</span> <span class="k">this</span><span class="p">.</span><span class="nx">nsp</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">packet</span><span class="p">({</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">CONNECT</span> <span class="p">});</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-63"><td class="docs"><div class="pilwrap"><a href="#section-63" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Called upon engine <code>close</code>.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>reason </span><span class="dox_type">String</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onclose</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">reason</span><span class="p">){</span>
  <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;close (%s)&#39;</span><span class="p">,</span> <span class="nx">reason</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">connected</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">disconnected</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;disconnect&#39;</span><span class="p">,</span> <span class="nx">reason</span><span class="p">);</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-64"><td class="docs"><div class="pilwrap"><a href="#section-64" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Called with socket packet.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>packet </span><span class="dox_type">Object</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onpacket</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">packet</span><span class="p">){</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">packet</span><span class="p">.</span><span class="nx">nsp</span> <span class="o">!=</span> <span class="k">this</span><span class="p">.</span><span class="nx">nsp</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

  <span class="k">switch</span> <span class="p">(</span><span class="nx">packet</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">CONNECT</span><span class="o">:</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">onconnect</span><span class="p">();</span>
      <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">EVENT</span><span class="o">:</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">onevent</span><span class="p">(</span><span class="nx">packet</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">BINARY_EVENT</span><span class="o">:</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">onevent</span><span class="p">(</span><span class="nx">packet</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">ACK</span><span class="o">:</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">onack</span><span class="p">(</span><span class="nx">packet</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">BINARY_ACK</span><span class="o">:</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">onack</span><span class="p">(</span><span class="nx">packet</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">DISCONNECT</span><span class="o">:</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">ondisconnect</span><span class="p">();</span>
      <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">ERROR</span><span class="o">:</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-65"><td class="docs"><div class="pilwrap"><a href="#section-65" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Called upon a server event.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>packet </span><span class="dox_type">Object</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onevent</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">packet</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">packet</span><span class="p">.</span><span class="nx">data</span> <span class="o">||</span> <span class="p">[];</span>
  <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;emitting event %j&#39;</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="nx">packet</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;attaching ack callback to event&#39;</span><span class="p">);</span>
    <span class="nx">args</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">ack</span><span class="p">(</span><span class="nx">packet</span><span class="p">.</span><span class="nx">id</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">connected</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">emit</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">receiveBuffer</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-66"><td class="docs"><div class="pilwrap"><a href="#section-66" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Produces an ack callback to emit with an event.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">ack</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">sent</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(){</span></pre></div></td></tr><tr id="section-67"><td class="docs"><div class="pilwrap"><a href="#section-67" class="pilcrow">&#182;</a></div><p>prevent double callbacks</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">sent</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="nx">sent</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">toArray</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;sending ack %j&#39;</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">hasBin</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="o">?</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">BINARY_ACK</span> <span class="o">:</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">ACK</span><span class="p">;</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">packet</span><span class="p">({</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nx">type</span><span class="p">,</span>
      <span class="nx">id</span><span class="o">:</span> <span class="nx">id</span><span class="p">,</span>
      <span class="nx">data</span><span class="o">:</span> <span class="nx">args</span>
    <span class="p">});</span>
  <span class="p">};</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-68"><td class="docs"><div class="pilwrap"><a href="#section-68" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Called upon a server acknowlegement.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>packet </span><span class="dox_type">Object</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onack</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">packet</span><span class="p">){</span>
  <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;calling ack %s with %j&#39;</span><span class="p">,</span> <span class="nx">packet</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">fn</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">acks</span><span class="p">[</span><span class="nx">packet</span><span class="p">.</span><span class="nx">id</span><span class="p">];</span>
  <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
  <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">acks</span><span class="p">[</span><span class="nx">packet</span><span class="p">.</span><span class="nx">id</span><span class="p">];</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-69"><td class="docs"><div class="pilwrap"><a href="#section-69" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Called upon server connect.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onconnect</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">connected</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">disconnected</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;connect&#39;</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">emitBuffered</span><span class="p">();</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-70"><td class="docs"><div class="pilwrap"><a href="#section-70" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Emit buffered events (received and emitted).</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">emitBuffered</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="kd">var</span> <span class="nx">i</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">receiveBuffer</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">emit</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">receiveBuffer</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">receiveBuffer</span> <span class="o">=</span> <span class="p">[];</span>

  <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">sendBuffer</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">packet</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">sendBuffer</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">sendBuffer</span> <span class="o">=</span> <span class="p">[];</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-71"><td class="docs"><div class="pilwrap"><a href="#section-71" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Called upon server disconnect.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">ondisconnect</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;server disconnect (%s)&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">nsp</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">onclose</span><span class="p">(</span><span class="s1">&#39;io server disconnect&#39;</span><span class="p">);</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-72"><td class="docs"><div class="pilwrap"><a href="#section-72" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Called upon forced client/server side disconnections,<br />this method ensures the manager stops tracking us and<br />that reconnections don't get triggered for this.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">destroy</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">subs</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-73"><td class="docs"><div class="pilwrap"><a href="#section-73" class="pilcrow">&#182;</a></div><p>clean subscriptions to avoid reconnections</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">subs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">subs</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">destroy</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">subs</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nx">destroy</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-74"><td class="docs"><div class="pilwrap"><a href="#section-74" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Disconnects the socket manually.</p></div><div class="details"><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Socket</span><span>self</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">close</span> <span class="o">=</span>
<span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">disconnect</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">connected</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;performing disconnect (%s)&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">nsp</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">packet</span><span class="p">({</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">DISCONNECT</span> <span class="p">});</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-75"><td class="docs"><div class="pilwrap"><a href="#section-75" class="pilcrow">&#182;</a></div><p>remove socket from pool</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>

  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">connected</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-76"><td class="docs"><div class="pilwrap"><a href="#section-76" class="pilcrow">&#182;</a></div><p>fire events</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">onclose</span><span class="p">(</span><span class="s1">&#39;io client disconnect&#39;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span>

<span class="p">},{</span><span class="s2">&quot;./on&quot;</span><span class="o">:</span><span class="mi">4</span><span class="p">,</span><span class="s2">&quot;component-bind&quot;</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="s2">&quot;component-emitter&quot;</span><span class="o">:</span><span class="mi">9</span><span class="p">,</span><span class="s2">&quot;debug&quot;</span><span class="o">:</span><span class="mi">10</span><span class="p">,</span><span class="s2">&quot;has-binary&quot;</span><span class="o">:</span><span class="mi">38</span><span class="p">,</span><span class="s2">&quot;socket.io-parser&quot;</span><span class="o">:</span><span class="mi">46</span><span class="p">,</span><span class="s2">&quot;to-array&quot;</span><span class="o">:</span><span class="mi">50</span><span class="p">}],</span><span class="mi">6</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span>
<span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">global</span><span class="p">){</span></pre></div></td></tr><tr id="section-77"><td class="docs"><div class="pilwrap"><a href="#section-77" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Module dependencies.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">parseuri</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;parseuri&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">debug</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">)(</span><span class="s1">&#39;socket.io-client:url&#39;</span><span class="p">);</span></pre></div></td></tr><tr id="section-78"><td class="docs"><div class="pilwrap"><a href="#section-78" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Module exports.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span></pre></div></td></tr><tr id="section-79"><td class="docs"><div class="pilwrap"><a href="#section-79" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>URL parser.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>url </span><span class="dox_type">String</span></div><div class="dox_tag_detail"><span>An </span><span class="dox_type">Object</span><span>- object meant to mimic window.location.</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">url</span><span class="p">(</span><span class="nx">uri</span><span class="p">,</span> <span class="nx">loc</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">uri</span><span class="p">;</span></pre></div></td></tr><tr id="section-80"><td class="docs"><div class="pilwrap"><a href="#section-80" class="pilcrow">&#182;</a></div><p>default to window.location</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">loc</span> <span class="o">=</span> <span class="nx">loc</span> <span class="o">||</span> <span class="nx">global</span><span class="p">.</span><span class="nx">location</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">==</span> <span class="nx">uri</span><span class="p">)</span> <span class="nx">uri</span> <span class="o">=</span> <span class="nx">loc</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">+</span> <span class="s1">&#39;//&#39;</span> <span class="o">+</span> <span class="nx">loc</span><span class="p">.</span><span class="nx">host</span><span class="p">;</span></pre></div></td></tr><tr id="section-81"><td class="docs"><div class="pilwrap"><a href="#section-81" class="pilcrow">&#182;</a></div><p>relative path support</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">==</span> <span class="k">typeof</span> <span class="nx">uri</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;/&#39;</span> <span class="o">==</span> <span class="nx">uri</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;/&#39;</span> <span class="o">==</span> <span class="nx">uri</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">uri</span> <span class="o">=</span> <span class="nx">loc</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">+</span> <span class="nx">uri</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">uri</span> <span class="o">=</span> <span class="nx">loc</span><span class="p">.</span><span class="nx">hostname</span> <span class="o">+</span> <span class="nx">uri</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="sr">/^(https?|wss?):\/\//</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">uri</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;protocol-less url %s&#39;</span><span class="p">,</span> <span class="nx">uri</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!=</span> <span class="k">typeof</span> <span class="nx">loc</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">uri</span> <span class="o">=</span> <span class="nx">loc</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">+</span> <span class="s1">&#39;//&#39;</span> <span class="o">+</span> <span class="nx">uri</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">uri</span> <span class="o">=</span> <span class="s1">&#39;https://&#39;</span> <span class="o">+</span> <span class="nx">uri</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-82"><td class="docs"><div class="pilwrap"><a href="#section-82" class="pilcrow">&#182;</a></div><p>parse</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;parse %s&#39;</span><span class="p">,</span> <span class="nx">uri</span><span class="p">);</span>
    <span class="nx">obj</span> <span class="o">=</span> <span class="nx">parseuri</span><span class="p">(</span><span class="nx">uri</span><span class="p">);</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-83"><td class="docs"><div class="pilwrap"><a href="#section-83" class="pilcrow">&#182;</a></div><p>make sure we treat <code>localhost:80</code> and <code>localhost</code> equally</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">obj</span><span class="p">.</span><span class="nx">port</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="sr">/^(http|ws)$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">protocol</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">obj</span><span class="p">.</span><span class="nx">port</span> <span class="o">=</span> <span class="s1">&#39;80&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="sr">/^(http|ws)s$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">protocol</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">obj</span><span class="p">.</span><span class="nx">port</span> <span class="o">=</span> <span class="s1">&#39;443&#39;</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">obj</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">path</span> <span class="o">||</span> <span class="s1">&#39;/&#39;</span><span class="p">;</span></pre></div></td></tr><tr id="section-84"><td class="docs"><div class="pilwrap"><a href="#section-84" class="pilcrow">&#182;</a></div><p>define unique id</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">obj</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">+</span> <span class="s1">&#39;://&#39;</span> <span class="o">+</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">host</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">port</span><span class="p">;</span></pre></div></td></tr><tr id="section-85"><td class="docs"><div class="pilwrap"><a href="#section-85" class="pilcrow">&#182;</a></div><p>define href</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">obj</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">+</span> <span class="s1">&#39;://&#39;</span> <span class="o">+</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">host</span> <span class="o">+</span> <span class="p">(</span><span class="nx">loc</span> <span class="o">&amp;&amp;</span> <span class="nx">loc</span><span class="p">.</span><span class="nx">port</span> <span class="o">==</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">port</span> <span class="o">?</span> <span class="s1">&#39;&#39;</span> <span class="o">:</span> <span class="p">(</span><span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">port</span><span class="p">));</span>

  <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="k">typeof</span> <span class="nx">self</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span> <span class="o">?</span> <span class="nx">self</span> <span class="o">:</span> <span class="k">typeof</span> <span class="nb">window</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span> <span class="o">?</span> <span class="nb">window</span> <span class="o">:</span> <span class="p">{})</span>
<span class="p">},{</span><span class="s2">&quot;debug&quot;</span><span class="o">:</span><span class="mi">10</span><span class="p">,</span><span class="s2">&quot;parseuri&quot;</span><span class="o">:</span><span class="mi">44</span><span class="p">}],</span><span class="mi">7</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span></pre></div></td></tr><tr id="section-86"><td class="docs"><div class="pilwrap"><a href="#section-86" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Expose <code>Backoff</code>.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Backoff</span><span class="p">;</span></pre></div></td></tr><tr id="section-87"><td class="docs"><div class="pilwrap"><a href="#section-87" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Initialize backoff timer with <code>opts</code>.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>opts </span><span class="dox_type">Object</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"><ul>
<li><code>min</code> initial timeout in milliseconds [100]</li>
<li><code>max</code> max timeout [10000]</li>
<li><code>jitter</code> [0]</li>
<li><code>factor</code> [2]</li>
</ul></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">Backoff</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">opts</span> <span class="o">=</span> <span class="nx">opts</span> <span class="o">||</span> <span class="p">{};</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">ms</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">min</span> <span class="o">||</span> <span class="mi">100</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">max</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">max</span> <span class="o">||</span> <span class="mi">10000</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">factor</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">factor</span> <span class="o">||</span> <span class="mi">2</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">jitter</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">jitter</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">jitter</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="o">?</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">jitter</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">attempts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-88"><td class="docs"><div class="pilwrap"><a href="#section-88" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Return the backoff duration.</p></div><div class="details"><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Number</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Backoff</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">duration</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="kd">var</span> <span class="nx">ms</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ms</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">factor</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">attempts</span><span class="o">++</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">jitter</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">rand</span> <span class="o">=</span>  <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">deviation</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">rand</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">jitter</span> <span class="o">*</span> <span class="nx">ms</span><span class="p">);</span>
    <span class="nx">ms</span> <span class="o">=</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">rand</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>  <span class="o">?</span> <span class="nx">ms</span> <span class="o">-</span> <span class="nx">deviation</span> <span class="o">:</span> <span class="nx">ms</span> <span class="o">+</span> <span class="nx">deviation</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">ms</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">max</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-89"><td class="docs"><div class="pilwrap"><a href="#section-89" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Reset the number of attempts.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Backoff</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">reset</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">attempts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-90"><td class="docs"><div class="pilwrap"><a href="#section-90" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Set the minimum duration</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Backoff</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setMin</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">min</span><span class="p">){</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">ms</span> <span class="o">=</span> <span class="nx">min</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-91"><td class="docs"><div class="pilwrap"><a href="#section-91" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Set the maximum duration</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Backoff</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setMax</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">max</span><span class="p">){</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">max</span> <span class="o">=</span> <span class="nx">max</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-92"><td class="docs"><div class="pilwrap"><a href="#section-92" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Set the jitter</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Backoff</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setJitter</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">jitter</span><span class="p">){</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">jitter</span> <span class="o">=</span> <span class="nx">jitter</span><span class="p">;</span>
<span class="p">};</span>


<span class="p">},{}],</span><span class="mi">8</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span></pre></div></td></tr><tr id="section-93"><td class="docs"><div class="pilwrap"><a href="#section-93" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Slice reference.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">slice</span> <span class="o">=</span> <span class="p">[].</span><span class="nx">slice</span><span class="p">;</span></pre></div></td></tr><tr id="section-94"><td class="docs"><div class="pilwrap"><a href="#section-94" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Bind <code>obj</code> to <code>fn</code>.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>obj </span><span class="dox_type">Object</span></div><div class="dox_tag_detail"><span>fn </span><span class="dox_type">Function</span><span class="dox_type">String</span><span>- or string</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Function</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">fn</span><span class="p">){</span>
  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">==</span> <span class="k">typeof</span> <span class="nx">fn</span><span class="p">)</span> <span class="nx">fn</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">fn</span><span class="p">];</span>
  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;function&#39;</span> <span class="o">!=</span> <span class="k">typeof</span> <span class="nx">fn</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;bind() requires a function&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">return</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">)));</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="p">},{}],</span><span class="mi">9</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span></pre></div></td></tr><tr id="section-95"><td class="docs"><div class="pilwrap"><a href="#section-95" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Expose <code>Emitter</code>.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Emitter</span><span class="p">;</span></pre></div></td></tr><tr id="section-96"><td class="docs"><div class="pilwrap"><a href="#section-96" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Initialize a new <code>Emitter</code>.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">Emitter</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="k">return</span> <span class="nx">mixin</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-97"><td class="docs"><div class="pilwrap"><a href="#section-97" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Mixin the emitter properties.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>obj </span><span class="dox_type">Object</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Object</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">mixin</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">Emitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Emitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-98"><td class="docs"><div class="pilwrap"><a href="#section-98" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Listen on the given <code>event</code> with <code>fn</code>.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>event </span><span class="dox_type">String</span></div><div class="dox_tag_detail"><span>fn </span><span class="dox_type">Function</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Emitter</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Emitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">on</span> <span class="o">=</span>
<span class="nx">Emitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addEventListener</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">fn</span><span class="p">){</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span> <span class="o">||</span> <span class="p">{};</span>
  <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">||</span> <span class="p">[])</span>
    <span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">fn</span><span class="p">);</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-99"><td class="docs"><div class="pilwrap"><a href="#section-99" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Adds an <code>event</code> listener that will be invoked a single<br />time then automatically removed.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>event </span><span class="dox_type">String</span></div><div class="dox_tag_detail"><span>fn </span><span class="dox_type">Function</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Emitter</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Emitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">once</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">fn</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span> <span class="o">||</span> <span class="p">{};</span>

  <span class="kd">function</span> <span class="nx">on</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">on</span><span class="p">);</span>
    <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">on</span><span class="p">.</span><span class="nx">fn</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">on</span><span class="p">);</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-100"><td class="docs"><div class="pilwrap"><a href="#section-100" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Remove the given callback for <code>event</code> or all<br />registered callbacks.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>event </span><span class="dox_type">String</span></div><div class="dox_tag_detail"><span>fn </span><span class="dox_type">Function</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Emitter</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Emitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">off</span> <span class="o">=</span>
<span class="nx">Emitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">removeListener</span> <span class="o">=</span>
<span class="nx">Emitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">removeAllListeners</span> <span class="o">=</span>
<span class="nx">Emitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">removeEventListener</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">fn</span><span class="p">){</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span> <span class="o">||</span> <span class="p">{};</span></pre></div></td></tr><tr id="section-101"><td class="docs"><div class="pilwrap"><a href="#section-101" class="pilcrow">&#182;</a></div><p>all</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-102"><td class="docs"><div class="pilwrap"><a href="#section-102" class="pilcrow">&#182;</a></div><p>specific event</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">callbacks</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="p">[</span><span class="nx">event</span><span class="p">];</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">callbacks</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">;</span></pre></div></td></tr><tr id="section-103"><td class="docs"><div class="pilwrap"><a href="#section-103" class="pilcrow">&#182;</a></div><p>remove all handlers</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="p">[</span><span class="nx">event</span><span class="p">];</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-104"><td class="docs"><div class="pilwrap"><a href="#section-104" class="pilcrow">&#182;</a></div><p>remove specific handler</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">cb</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">callbacks</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">cb</span> <span class="o">=</span> <span class="nx">callbacks</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">cb</span> <span class="o">===</span> <span class="nx">fn</span> <span class="o">||</span> <span class="nx">cb</span><span class="p">.</span><span class="nx">fn</span> <span class="o">===</span> <span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">callbacks</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-105"><td class="docs"><div class="pilwrap"><a href="#section-105" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Emit <code>event</code> with the given args.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>event </span><span class="dox_type">String</span></div><div class="dox_tag_detail"><span>... </span><span class="dox_type">Mixed</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Emitter</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Emitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">emit</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span> <span class="o">||</span> <span class="p">{};</span>
  <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="p">[].</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">,</span> <span class="nx">callbacks</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="p">[</span><span class="nx">event</span><span class="p">];</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">callbacks</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">callbacks</span> <span class="o">=</span> <span class="nx">callbacks</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">callbacks</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">callbacks</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-106"><td class="docs"><div class="pilwrap"><a href="#section-106" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Return array of callbacks for <code>event</code>.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>event </span><span class="dox_type">String</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Array</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Emitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">listeners</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span> <span class="o">||</span> <span class="p">{};</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">||</span> <span class="p">[];</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-107"><td class="docs"><div class="pilwrap"><a href="#section-107" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Check if this emitter has <code>event</code> handlers.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>event </span><span class="dox_type">String</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Boolean</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Emitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hasListeners</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span>
  <span class="k">return</span> <span class="o">!!</span> <span class="k">this</span><span class="p">.</span><span class="nx">listeners</span><span class="p">(</span><span class="nx">event</span><span class="p">).</span><span class="nx">length</span><span class="p">;</span>
<span class="p">};</span>

<span class="p">},{}],</span><span class="mi">10</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span></pre></div></td></tr><tr id="section-108"><td class="docs"><div class="pilwrap"><a href="#section-108" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Expose <code>debug()</code> as the module.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">debug</span><span class="p">;</span></pre></div></td></tr><tr id="section-109"><td class="docs"><div class="pilwrap"><a href="#section-109" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Create a debugger with the given <code>name</code>.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>name </span><span class="dox_type">String</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Type</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">debug</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">debug</span><span class="p">.</span><span class="nx">enabled</span><span class="p">(</span><span class="nx">name</span><span class="p">))</span> <span class="k">return</span> <span class="kd">function</span><span class="p">(){};</span>

  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fmt</span><span class="p">){</span>
    <span class="nx">fmt</span> <span class="o">=</span> <span class="nx">coerce</span><span class="p">(</span><span class="nx">fmt</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">curr</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">ms</span> <span class="o">=</span> <span class="nx">curr</span> <span class="o">-</span> <span class="p">(</span><span class="nx">debug</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">||</span> <span class="nx">curr</span><span class="p">);</span>
    <span class="nx">debug</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">curr</span><span class="p">;</span>

    <span class="nx">fmt</span> <span class="o">=</span> <span class="nx">name</span>
      <span class="o">+</span> <span class="s1">&#39; &#39;</span>
      <span class="o">+</span> <span class="nx">fmt</span>
      <span class="o">+</span> <span class="s1">&#39; +&#39;</span> <span class="o">+</span> <span class="nx">debug</span><span class="p">.</span><span class="nx">humanize</span><span class="p">(</span><span class="nx">ms</span><span class="p">);</span></pre></div></td></tr><tr id="section-110"><td class="docs"><div class="pilwrap"><a href="#section-110" class="pilcrow">&#182;</a></div><p>This hackery is required for IE8
where <code>console.log</code> doesn't have 'apply'</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nb">window</span><span class="p">.</span><span class="nx">console</span>
      <span class="o">&amp;&amp;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span>
      <span class="o">&amp;&amp;</span> <span class="nb">Function</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">apply</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">,</span> <span class="nx">console</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-111"><td class="docs"><div class="pilwrap"><a href="#section-111" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>The currently active debug mode names.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">debug</span><span class="p">.</span><span class="nx">names</span> <span class="o">=</span> <span class="p">[];</span>
<span class="nx">debug</span><span class="p">.</span><span class="nx">skips</span> <span class="o">=</span> <span class="p">[];</span></pre></div></td></tr><tr id="section-112"><td class="docs"><div class="pilwrap"><a href="#section-112" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Enables a debug mode by name. This can include modes<br />separated by a colon and wildcards.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>name </span><span class="dox_type">String</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">debug</span><span class="p">.</span><span class="nx">enable</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="nx">localStorage</span><span class="p">.</span><span class="nx">debug</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){}</span>

  <span class="kd">var</span> <span class="nx">split</span> <span class="o">=</span> <span class="p">(</span><span class="nx">name</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="sr">/[\s,]+/</span><span class="p">)</span>
    <span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">split</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="o">=</span> <span class="nx">split</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;.*?&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">debug</span><span class="p">.</span><span class="nx">skips</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s1">&#39;^&#39;</span> <span class="o">+</span> <span class="nx">name</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;$&#39;</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">debug</span><span class="p">.</span><span class="nx">names</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s1">&#39;^&#39;</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;$&#39;</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-113"><td class="docs"><div class="pilwrap"><a href="#section-113" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Disable debug output.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">debug</span><span class="p">.</span><span class="nx">disable</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="nx">debug</span><span class="p">.</span><span class="nx">enable</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-114"><td class="docs"><div class="pilwrap"><a href="#section-114" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Humanize the given <code>ms</code>.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>m </span><span class="dox_type">Number</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">String</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">debug</span><span class="p">.</span><span class="nx">humanize</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ms</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">sec</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="p">,</span> <span class="nx">min</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span>
    <span class="p">,</span> <span class="nx">hour</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="nx">min</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">ms</span> <span class="o">&gt;=</span> <span class="nx">hour</span><span class="p">)</span> <span class="k">return</span> <span class="p">(</span><span class="nx">ms</span> <span class="o">/</span> <span class="nx">hour</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;h&#39;</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">ms</span> <span class="o">&gt;=</span> <span class="nx">min</span><span class="p">)</span> <span class="k">return</span> <span class="p">(</span><span class="nx">ms</span> <span class="o">/</span> <span class="nx">min</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;m&#39;</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">ms</span> <span class="o">&gt;=</span> <span class="nx">sec</span><span class="p">)</span> <span class="k">return</span> <span class="p">(</span><span class="nx">ms</span> <span class="o">/</span> <span class="nx">sec</span> <span class="o">|</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;s&#39;</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">ms</span> <span class="o">+</span> <span class="s1">&#39;ms&#39;</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-115"><td class="docs"><div class="pilwrap"><a href="#section-115" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Returns true if the given mode name is enabled, false otherwise.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>name </span><span class="dox_type">String</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Boolean</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">debug</span><span class="p">.</span><span class="nx">enabled</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">debug</span><span class="p">.</span><span class="nx">skips</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">debug</span><span class="p">.</span><span class="nx">skips</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">test</span><span class="p">(</span><span class="nx">name</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">debug</span><span class="p">.</span><span class="nx">names</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">debug</span><span class="p">.</span><span class="nx">names</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">test</span><span class="p">(</span><span class="nx">name</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-116"><td class="docs"><div class="pilwrap"><a href="#section-116" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Coerce <code>val</code>.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">coerce</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">val</span> <span class="k">instanceof</span> <span class="nb">Error</span><span class="p">)</span> <span class="k">return</span> <span class="nx">val</span><span class="p">.</span><span class="nx">stack</span> <span class="o">||</span> <span class="nx">val</span><span class="p">.</span><span class="nx">message</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">val</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-117"><td class="docs"><div class="pilwrap"><a href="#section-117" class="pilcrow">&#182;</a></div><p>persist</p>
</td><td class="code"><div class="highlight"><pre><span class="k">try</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">localStorage</span><span class="p">)</span> <span class="nx">debug</span><span class="p">.</span><span class="nx">enable</span><span class="p">(</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">debug</span><span class="p">);</span>
<span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){}</span>

<span class="p">},{}],</span><span class="mi">11</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span>  <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;./lib/&#39;</span><span class="p">);</span>

<span class="p">},{</span><span class="s2">&quot;./lib/&quot;</span><span class="o">:</span><span class="mi">12</span><span class="p">}],</span><span class="mi">12</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;./socket&#39;</span><span class="p">);</span></pre></div></td></tr><tr id="section-118"><td class="docs"><div class="pilwrap"><a href="#section-118" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Exports parser</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">parser</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;engine.io-parser&#39;</span><span class="p">);</span>

<span class="p">},{</span><span class="s2">&quot;./socket&quot;</span><span class="o">:</span><span class="mi">13</span><span class="p">,</span><span class="s2">&quot;engine.io-parser&quot;</span><span class="o">:</span><span class="mi">25</span><span class="p">}],</span><span class="mi">13</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span>
<span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">global</span><span class="p">){</span></pre></div></td></tr><tr id="section-119"><td class="docs"><div class="pilwrap"><a href="#section-119" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Module dependencies.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">transports</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;./transports&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">Emitter</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;component-emitter&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">debug</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">)(</span><span class="s1">&#39;engine.io-client:socket&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;indexof&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">parser</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;engine.io-parser&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">parseuri</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;parseuri&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">parsejson</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;parsejson&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">parseqs</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;parseqs&#39;</span><span class="p">);</span></pre></div></td></tr><tr id="section-120"><td class="docs"><div class="pilwrap"><a href="#section-120" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Module exports.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Socket</span><span class="p">;</span></pre></div></td></tr><tr id="section-121"><td class="docs"><div class="pilwrap"><a href="#section-121" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Noop function.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">noop</span><span class="p">(){}</span></pre></div></td></tr><tr id="section-122"><td class="docs"><div class="pilwrap"><a href="#section-122" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Socket constructor.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>uri </span><span class="dox_type">String</span><span class="dox_type">Object</span><span>- or options</span></div><div class="dox_tag_detail"><span>options </span><span class="dox_type">Object</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">Socket</span><span class="p">(</span><span class="nx">uri</span><span class="p">,</span> <span class="nx">opts</span><span class="p">){</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="k">this</span> <span class="k">instanceof</span> <span class="nx">Socket</span><span class="p">))</span> <span class="k">return</span> <span class="k">new</span> <span class="nx">Socket</span><span class="p">(</span><span class="nx">uri</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span>

  <span class="nx">opts</span> <span class="o">=</span> <span class="nx">opts</span> <span class="o">||</span> <span class="p">{};</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">uri</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;object&#39;</span> <span class="o">==</span> <span class="k">typeof</span> <span class="nx">uri</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">opts</span> <span class="o">=</span> <span class="nx">uri</span><span class="p">;</span>
    <span class="nx">uri</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">uri</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">uri</span> <span class="o">=</span> <span class="nx">parseuri</span><span class="p">(</span><span class="nx">uri</span><span class="p">);</span>
    <span class="nx">opts</span><span class="p">.</span><span class="nx">host</span> <span class="o">=</span> <span class="nx">uri</span><span class="p">.</span><span class="nx">host</span><span class="p">;</span>
    <span class="nx">opts</span><span class="p">.</span><span class="nx">secure</span> <span class="o">=</span> <span class="nx">uri</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">==</span> <span class="s1">&#39;https&#39;</span> <span class="o">||</span> <span class="nx">uri</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">==</span> <span class="s1">&#39;wss&#39;</span><span class="p">;</span>
    <span class="nx">opts</span><span class="p">.</span><span class="nx">port</span> <span class="o">=</span> <span class="nx">uri</span><span class="p">.</span><span class="nx">port</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">uri</span><span class="p">.</span><span class="nx">query</span><span class="p">)</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">query</span> <span class="o">=</span> <span class="nx">uri</span><span class="p">.</span><span class="nx">query</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">secure</span> <span class="o">=</span> <span class="kc">null</span> <span class="o">!=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">secure</span> <span class="o">?</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">secure</span> <span class="o">:</span>
    <span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">location</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;https:&#39;</span> <span class="o">==</span> <span class="nx">location</span><span class="p">.</span><span class="nx">protocol</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">host</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">pieces</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">host</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">);</span>
    <span class="nx">opts</span><span class="p">.</span><span class="nx">hostname</span> <span class="o">=</span> <span class="nx">pieces</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">pieces</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">opts</span><span class="p">.</span><span class="nx">port</span> <span class="o">=</span> <span class="nx">pieces</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">opts</span><span class="p">.</span><span class="nx">port</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-123"><td class="docs"><div class="pilwrap"><a href="#section-123" class="pilcrow">&#182;</a></div><p>if no port is specified manually, use the protocol default</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">opts</span><span class="p">.</span><span class="nx">port</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">secure</span> <span class="o">?</span> <span class="s1">&#39;443&#39;</span> <span class="o">:</span> <span class="s1">&#39;80&#39;</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">agent</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">agent</span> <span class="o">||</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">hostname</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">hostname</span> <span class="o">||</span>
    <span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">location</span> <span class="o">?</span> <span class="nx">location</span><span class="p">.</span><span class="nx">hostname</span> <span class="o">:</span> <span class="s1">&#39;localhost&#39;</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">port</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">port</span> <span class="o">||</span> <span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">location</span> <span class="o">&amp;&amp;</span> <span class="nx">location</span><span class="p">.</span><span class="nx">port</span> <span class="o">?</span>
       <span class="nx">location</span><span class="p">.</span><span class="nx">port</span> <span class="o">:</span>
       <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">secure</span> <span class="o">?</span> <span class="mi">443</span> <span class="o">:</span> <span class="mi">80</span><span class="p">));</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">query</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">query</span> <span class="o">||</span> <span class="p">{};</span>
  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">==</span> <span class="k">typeof</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span> <span class="o">=</span> <span class="nx">parseqs</span><span class="p">.</span><span class="nx">decode</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">upgrade</span> <span class="o">=</span> <span class="kc">false</span> <span class="o">!==</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">upgrade</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">path</span> <span class="o">||</span> <span class="s1">&#39;/engine.io&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/$/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">forceJSONP</span> <span class="o">=</span> <span class="o">!!</span><span class="nx">opts</span><span class="p">.</span><span class="nx">forceJSONP</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">jsonp</span> <span class="o">=</span> <span class="kc">false</span> <span class="o">!==</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">jsonp</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">forceBase64</span> <span class="o">=</span> <span class="o">!!</span><span class="nx">opts</span><span class="p">.</span><span class="nx">forceBase64</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">enablesXDR</span> <span class="o">=</span> <span class="o">!!</span><span class="nx">opts</span><span class="p">.</span><span class="nx">enablesXDR</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">timestampParam</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">timestampParam</span> <span class="o">||</span> <span class="s1">&#39;t&#39;</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">timestampRequests</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">timestampRequests</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">transports</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">transports</span> <span class="o">||</span> <span class="p">[</span><span class="s1">&#39;polling&#39;</span><span class="p">,</span> <span class="s1">&#39;websocket&#39;</span><span class="p">];</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">writeBuffer</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">callbackBuffer</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">policyPort</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">policyPort</span> <span class="o">||</span> <span class="mi">843</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">rememberUpgrade</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">rememberUpgrade</span> <span class="o">||</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">binaryType</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">onlyBinaryUpgrades</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">onlyBinaryUpgrades</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">perMessageDeflate</span> <span class="o">=</span> <span class="kc">false</span> <span class="o">!==</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">perMessageDeflate</span> <span class="o">?</span> <span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">perMessageDeflate</span> <span class="o">||</span> <span class="kc">true</span><span class="p">)</span> <span class="o">:</span> <span class="kc">false</span><span class="p">;</span></pre></div></td></tr><tr id="section-124"><td class="docs"><div class="pilwrap"><a href="#section-124" class="pilcrow">&#182;</a></div><p>SSL options for Node.js client</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">pfx</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">pfx</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">key</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">key</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">passphrase</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">passphrase</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">cert</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">cert</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">ca</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">ca</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">ciphers</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">ciphers</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">rejectUnauthorized</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">rejectUnauthorized</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">open</span><span class="p">();</span>
<span class="p">}</span>

<span class="nx">Socket</span><span class="p">.</span><span class="nx">priorWebsocketSuccess</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></pre></div></td></tr><tr id="section-125"><td class="docs"><div class="pilwrap"><a href="#section-125" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Mix in <code>Emitter</code>.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Emitter</span><span class="p">(</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span></pre></div></td></tr><tr id="section-126"><td class="docs"><div class="pilwrap"><a href="#section-126" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Protocol version.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Socket</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">=</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">protocol</span><span class="p">;</span> <span class="c1">// this is an int</span></pre></div></td></tr><tr id="section-127"><td class="docs"><div class="pilwrap"><a href="#section-127" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Expose deps for legacy compatibility<br />and standalone browser access.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Socket</span><span class="p">.</span><span class="nx">Socket</span> <span class="o">=</span> <span class="nx">Socket</span><span class="p">;</span>
<span class="nx">Socket</span><span class="p">.</span><span class="nx">Transport</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;./transport&#39;</span><span class="p">);</span>
<span class="nx">Socket</span><span class="p">.</span><span class="nx">transports</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;./transports&#39;</span><span class="p">);</span>
<span class="nx">Socket</span><span class="p">.</span><span class="nx">parser</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;engine.io-parser&#39;</span><span class="p">);</span></pre></div></td></tr><tr id="section-128"><td class="docs"><div class="pilwrap"><a href="#section-128" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Creates transport of the given type.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>transport </span><span class="dox_type">String</span><span>- name</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Transport</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">createTransport</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;creating transport &quot;%s&quot;&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">query</span> <span class="o">=</span> <span class="nx">clone</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">);</span></pre></div></td></tr><tr id="section-129"><td class="docs"><div class="pilwrap"><a href="#section-129" class="pilcrow">&#182;</a></div><p>append engine.io protocol identifier</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">query</span><span class="p">.</span><span class="nx">EIO</span> <span class="o">=</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">protocol</span><span class="p">;</span></pre></div></td></tr><tr id="section-130"><td class="docs"><div class="pilwrap"><a href="#section-130" class="pilcrow">&#182;</a></div><p>transport name</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">query</span><span class="p">.</span><span class="nx">transport</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span></pre></div></td></tr><tr id="section-131"><td class="docs"><div class="pilwrap"><a href="#section-131" class="pilcrow">&#182;</a></div><p>session id if we already have one</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="nx">query</span><span class="p">.</span><span class="nx">sid</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">transport</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">transports</span><span class="p">[</span><span class="nx">name</span><span class="p">]({</span>
    <span class="nx">agent</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">agent</span><span class="p">,</span>
    <span class="nx">hostname</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">hostname</span><span class="p">,</span>
    <span class="nx">port</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span>
    <span class="nx">secure</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">secure</span><span class="p">,</span>
    <span class="nx">path</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span>
    <span class="nx">query</span><span class="o">:</span> <span class="nx">query</span><span class="p">,</span>
    <span class="nx">forceJSONP</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">forceJSONP</span><span class="p">,</span>
    <span class="nx">jsonp</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">jsonp</span><span class="p">,</span>
    <span class="nx">forceBase64</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">forceBase64</span><span class="p">,</span>
    <span class="nx">enablesXDR</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">enablesXDR</span><span class="p">,</span>
    <span class="nx">timestampRequests</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">timestampRequests</span><span class="p">,</span>
    <span class="nx">timestampParam</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">timestampParam</span><span class="p">,</span>
    <span class="nx">policyPort</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">policyPort</span><span class="p">,</span>
    <span class="nx">socket</span><span class="o">:</span> <span class="k">this</span><span class="p">,</span>
    <span class="nx">pfx</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">pfx</span><span class="p">,</span>
    <span class="nx">key</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span>
    <span class="nx">passphrase</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">passphrase</span><span class="p">,</span>
    <span class="nx">cert</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">cert</span><span class="p">,</span>
    <span class="nx">ca</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">ca</span><span class="p">,</span>
    <span class="nx">ciphers</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">ciphers</span><span class="p">,</span>
    <span class="nx">rejectUnauthorized</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">rejectUnauthorized</span><span class="p">,</span>
    <span class="nx">perMessageDeflate</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">perMessageDeflate</span>
  <span class="p">});</span>

  <span class="k">return</span> <span class="nx">transport</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">clone</span> <span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">o</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">o</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">o</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-132"><td class="docs"><div class="pilwrap"><a href="#section-132" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Initializes transport to use and starts probe.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">open</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">transport</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">rememberUpgrade</span> <span class="o">&amp;&amp;</span> <span class="nx">Socket</span><span class="p">.</span><span class="nx">priorWebsocketSuccess</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">transports</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;websocket&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">transport</span> <span class="o">=</span> <span class="s1">&#39;websocket&#39;</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">transports</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-133"><td class="docs"><div class="pilwrap"><a href="#section-133" class="pilcrow">&#182;</a></div><p>Emit error on next tick so it can be listened to</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;No transports available&#39;</span><span class="p">);</span>
    <span class="p">},</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">transport</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">transports</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">=</span> <span class="s1">&#39;opening&#39;</span><span class="p">;</span></pre></div></td></tr><tr id="section-134"><td class="docs"><div class="pilwrap"><a href="#section-134" class="pilcrow">&#182;</a></div><p>Retry with the next transport if the transport is disabled (jsonp: false)</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">transport</span><span class="p">;</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="nx">transport</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">createTransport</span><span class="p">(</span><span class="nx">transport</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">transports</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">open</span><span class="p">();</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">transport</span><span class="p">.</span><span class="nx">open</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">setTransport</span><span class="p">(</span><span class="nx">transport</span><span class="p">);</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-135"><td class="docs"><div class="pilwrap"><a href="#section-135" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Sets the current transport. Disables the existing one (if any).</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setTransport</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">transport</span><span class="p">){</span>
  <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;setting transport %s&#39;</span><span class="p">,</span> <span class="nx">transport</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">transport</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;clearing existing transport %s&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">removeAllListeners</span><span class="p">();</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-136"><td class="docs"><div class="pilwrap"><a href="#section-136" class="pilcrow">&#182;</a></div><p>set up transport</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">transport</span> <span class="o">=</span> <span class="nx">transport</span><span class="p">;</span></pre></div></td></tr><tr id="section-137"><td class="docs"><div class="pilwrap"><a href="#section-137" class="pilcrow">&#182;</a></div><p>set up transport listeners</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">transport</span>
  <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;drain&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">onDrain</span><span class="p">();</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;packet&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">packet</span><span class="p">){</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">onPacket</span><span class="p">(</span><span class="nx">packet</span><span class="p">);</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">onError</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">onClose</span><span class="p">(</span><span class="s1">&#39;transport close&#39;</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-138"><td class="docs"><div class="pilwrap"><a href="#section-138" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Probes a transport.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>transport </span><span class="dox_type">String</span><span>- name</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">probe</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;probing transport &quot;%s&quot;&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">transport</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">createTransport</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="p">{</span> <span class="nx">probe</span><span class="o">:</span> <span class="mi">1</span> <span class="p">})</span>
    <span class="p">,</span> <span class="nx">failed</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="p">,</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="nx">Socket</span><span class="p">.</span><span class="nx">priorWebsocketSuccess</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">onTransportOpen</span><span class="p">(){</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">onlyBinaryUpgrades</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">upgradeLosesBinary</span> <span class="o">=</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">supportsBinary</span> <span class="o">&amp;&amp;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">supportsBinary</span><span class="p">;</span>
      <span class="nx">failed</span> <span class="o">=</span> <span class="nx">failed</span> <span class="o">||</span> <span class="nx">upgradeLosesBinary</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">failed</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;probe transport &quot;%s&quot; opened&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
    <span class="nx">transport</span><span class="p">.</span><span class="nx">send</span><span class="p">([{</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;ping&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="o">:</span> <span class="s1">&#39;probe&#39;</span><span class="p">,</span> <span class="nx">options</span><span class="o">:</span> <span class="p">{</span> <span class="nx">compress</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span> <span class="p">}]);</span>
    <span class="nx">transport</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;packet&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">failed</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;pong&#39;</span> <span class="o">==</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">type</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;probe&#39;</span> <span class="o">==</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;probe transport &quot;%s&quot; pong&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">upgrading</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;upgrading&#39;</span><span class="p">,</span> <span class="nx">transport</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">transport</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
        <span class="nx">Socket</span><span class="p">.</span><span class="nx">priorWebsocketSuccess</span> <span class="o">=</span> <span class="s1">&#39;websocket&#39;</span> <span class="o">==</span> <span class="nx">transport</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>

        <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;pausing current transport &quot;%s&quot;&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">pause</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">failed</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;closed&#39;</span> <span class="o">==</span> <span class="nx">self</span><span class="p">.</span><span class="nx">readyState</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
          <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;changing transport and sending upgrade packet&#39;</span><span class="p">);</span>

          <span class="nx">cleanup</span><span class="p">();</span>

          <span class="nx">self</span><span class="p">.</span><span class="nx">setTransport</span><span class="p">(</span><span class="nx">transport</span><span class="p">);</span>
          <span class="nx">transport</span><span class="p">.</span><span class="nx">send</span><span class="p">([{</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;upgrade&#39;</span><span class="p">,</span> <span class="nx">options</span><span class="o">:</span> <span class="p">{</span> <span class="nx">compress</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span> <span class="p">}]);</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;upgrade&#39;</span><span class="p">,</span> <span class="nx">transport</span><span class="p">);</span>
          <span class="nx">transport</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">upgrading</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">flush</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;probe transport &quot;%s&quot; failed&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">err</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;probe error&#39;</span><span class="p">);</span>
        <span class="nx">err</span><span class="p">.</span><span class="nx">transport</span> <span class="o">=</span> <span class="nx">transport</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;upgradeError&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">freezeTransport</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">failed</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span></pre></div></td></tr><tr id="section-139"><td class="docs"><div class="pilwrap"><a href="#section-139" class="pilcrow">&#182;</a></div><p>Any callback called by transport should be ignored since now</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">failed</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

    <span class="nx">cleanup</span><span class="p">();</span>

    <span class="nx">transport</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
    <span class="nx">transport</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-140"><td class="docs"><div class="pilwrap"><a href="#section-140" class="pilcrow">&#182;</a></div><p>Handle any error that happens while probing</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">onerror</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">error</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;probe error: &#39;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
    <span class="nx">error</span><span class="p">.</span><span class="nx">transport</span> <span class="o">=</span> <span class="nx">transport</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>

    <span class="nx">freezeTransport</span><span class="p">();</span>

    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;probe transport &quot;%s&quot; failed because of error: %s&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;upgradeError&#39;</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">onTransportClose</span><span class="p">(){</span>
    <span class="nx">onerror</span><span class="p">(</span><span class="s2">&quot;transport closed&quot;</span><span class="p">);</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-141"><td class="docs"><div class="pilwrap"><a href="#section-141" class="pilcrow">&#182;</a></div><p>When the socket is closed while we're probing</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">onclose</span><span class="p">(){</span>
    <span class="nx">onerror</span><span class="p">(</span><span class="s2">&quot;socket closed&quot;</span><span class="p">);</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-142"><td class="docs"><div class="pilwrap"><a href="#section-142" class="pilcrow">&#182;</a></div><p>When the socket is upgraded while we're probing</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">onupgrade</span><span class="p">(</span><span class="nx">to</span><span class="p">){</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">transport</span> <span class="o">&amp;&amp;</span> <span class="nx">to</span><span class="p">.</span><span class="nx">name</span> <span class="o">!=</span> <span class="nx">transport</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;&quot;%s&quot; works - aborting &quot;%s&quot;&#39;</span><span class="p">,</span> <span class="nx">to</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">transport</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
      <span class="nx">freezeTransport</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-143"><td class="docs"><div class="pilwrap"><a href="#section-143" class="pilcrow">&#182;</a></div><p>Remove all listeners on the transport and on self</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">cleanup</span><span class="p">(){</span>
    <span class="nx">transport</span><span class="p">.</span><span class="nx">removeListener</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="nx">onTransportOpen</span><span class="p">);</span>
    <span class="nx">transport</span><span class="p">.</span><span class="nx">removeListener</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">onerror</span><span class="p">);</span>
    <span class="nx">transport</span><span class="p">.</span><span class="nx">removeListener</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="nx">onTransportClose</span><span class="p">);</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">removeListener</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="nx">onclose</span><span class="p">);</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">removeListener</span><span class="p">(</span><span class="s1">&#39;upgrading&#39;</span><span class="p">,</span> <span class="nx">onupgrade</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">transport</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="nx">onTransportOpen</span><span class="p">);</span>
  <span class="nx">transport</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">onerror</span><span class="p">);</span>
  <span class="nx">transport</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="nx">onTransportClose</span><span class="p">);</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="nx">onclose</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;upgrading&#39;</span><span class="p">,</span> <span class="nx">onupgrade</span><span class="p">);</span>

  <span class="nx">transport</span><span class="p">.</span><span class="nx">open</span><span class="p">();</span>

<span class="p">};</span></pre></div></td></tr><tr id="section-144"><td class="docs"><div class="pilwrap"><a href="#section-144" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Called when connection is deemed open.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onOpen</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;socket open&#39;</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">=</span> <span class="s1">&#39;open&#39;</span><span class="p">;</span>
  <span class="nx">Socket</span><span class="p">.</span><span class="nx">priorWebsocketSuccess</span> <span class="o">=</span> <span class="s1">&#39;websocket&#39;</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">flush</span><span class="p">();</span></pre></div></td></tr><tr id="section-145"><td class="docs"><div class="pilwrap"><a href="#section-145" class="pilcrow">&#182;</a></div><p>we check for <code>readyState</code> in case an <code>open</code>
listener already closed the socket</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;open&#39;</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">upgrade</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">pause</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;starting upgrade probes&#39;</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">upgrades</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">probe</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">upgrades</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-146"><td class="docs"><div class="pilwrap"><a href="#section-146" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Handles a packet.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onPacket</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">packet</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;opening&#39;</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">||</span> <span class="s1">&#39;open&#39;</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;socket receive: type &quot;%s&quot;, data &quot;%s&quot;&#39;</span><span class="p">,</span> <span class="nx">packet</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;packet&#39;</span><span class="p">,</span> <span class="nx">packet</span><span class="p">);</span></pre></div></td></tr><tr id="section-147"><td class="docs"><div class="pilwrap"><a href="#section-147" class="pilcrow">&#182;</a></div><p>Socket is live - any packet counts</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;heartbeat&#39;</span><span class="p">);</span>

    <span class="k">switch</span> <span class="p">(</span><span class="nx">packet</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="s1">&#39;open&#39;</span><span class="o">:</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">onHandshake</span><span class="p">(</span><span class="nx">parsejson</span><span class="p">(</span><span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">));</span>
        <span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="s1">&#39;pong&#39;</span><span class="o">:</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setPing</span><span class="p">();</span>
        <span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="s1">&#39;error&#39;</span><span class="o">:</span>
        <span class="kd">var</span> <span class="nx">err</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;server error&#39;</span><span class="p">);</span>
        <span class="nx">err</span><span class="p">.</span><span class="nx">code</span> <span class="o">=</span> <span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="s1">&#39;message&#39;</span><span class="o">:</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;packet received with socket readyState &quot;%s&quot;&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-148"><td class="docs"><div class="pilwrap"><a href="#section-148" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Called upon handshake completion.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>handshake </span><span class="dox_type">Object</span><span>- obj</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onHandshake</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;handshake&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">sid</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">sid</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">sid</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">upgrades</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">filterUpgrades</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">upgrades</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">pingInterval</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">pingInterval</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">pingTimeout</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">pingTimeout</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">onOpen</span><span class="p">();</span></pre></div></td></tr><tr id="section-149"><td class="docs"><div class="pilwrap"><a href="#section-149" class="pilcrow">&#182;</a></div><p>In case open handler closes socket</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span>  <span class="p">(</span><span class="s1">&#39;closed&#39;</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">setPing</span><span class="p">();</span></pre></div></td></tr><tr id="section-150"><td class="docs"><div class="pilwrap"><a href="#section-150" class="pilcrow">&#182;</a></div><p>Prolong liveness of socket on heartbeat</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">removeListener</span><span class="p">(</span><span class="s1">&#39;heartbeat&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">onHeartbeat</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;heartbeat&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">onHeartbeat</span><span class="p">);</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-151"><td class="docs"><div class="pilwrap"><a href="#section-151" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Resets ping timeout.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onHeartbeat</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">timeout</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">clearTimeout</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pingTimeoutTimer</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">pingTimeoutTimer</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;closed&#39;</span> <span class="o">==</span> <span class="nx">self</span><span class="p">.</span><span class="nx">readyState</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">onClose</span><span class="p">(</span><span class="s1">&#39;ping timeout&#39;</span><span class="p">);</span>
  <span class="p">},</span> <span class="nx">timeout</span> <span class="o">||</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">pingInterval</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">pingTimeout</span><span class="p">));</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-152"><td class="docs"><div class="pilwrap"><a href="#section-152" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Pings server every <code>this.pingInterval</code> and expects response<br />within <code>this.pingTimeout</code> or closes connection.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setPing</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">pingIntervalTimer</span><span class="p">);</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">pingIntervalTimer</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;writing ping packet - expecting pong within %sms&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">pingTimeout</span><span class="p">);</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">ping</span><span class="p">();</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">onHeartbeat</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">pingTimeout</span><span class="p">);</span>
  <span class="p">},</span> <span class="nx">self</span><span class="p">.</span><span class="nx">pingInterval</span><span class="p">);</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-153"><td class="docs"><div class="pilwrap"><a href="#section-153" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Sends a ping packet.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">ping</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">sendPacket</span><span class="p">(</span><span class="s1">&#39;ping&#39;</span><span class="p">);</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-154"><td class="docs"><div class="pilwrap"><a href="#section-154" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Called on <code>drain</code> event</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onDrain</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">prevBufferLen</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">callbackBuffer</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">callbackBuffer</span><span class="p">[</span><span class="nx">i</span><span class="p">]();</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">writeBuffer</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">prevBufferLen</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">callbackBuffer</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">prevBufferLen</span><span class="p">);</span></pre></div></td></tr><tr id="section-155"><td class="docs"><div class="pilwrap"><a href="#section-155" class="pilcrow">&#182;</a></div><p>setting prevBufferLen = 0 is very important
for example, when upgrading, upgrade packet is sent over,
and a nonzero prevBufferLen could cause problems on <code>drain</code></p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">prevBufferLen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">writeBuffer</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;drain&#39;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">flush</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-156"><td class="docs"><div class="pilwrap"><a href="#section-156" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Flush write buffers.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">flush</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;closed&#39;</span> <span class="o">!=</span> <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">writable</span> <span class="o">&amp;&amp;</span>
    <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">upgrading</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">writeBuffer</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;flushing %d packets in socket&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">writeBuffer</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">writeBuffer</span><span class="p">);</span></pre></div></td></tr><tr id="section-157"><td class="docs"><div class="pilwrap"><a href="#section-157" class="pilcrow">&#182;</a></div><p>keep track of current length of writeBuffer
splice writeBuffer and callbackBuffer on <code>drain</code></p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">prevBufferLen</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">writeBuffer</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;flush&#39;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-158"><td class="docs"><div class="pilwrap"><a href="#section-158" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Sends a message.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>message. </span><span class="dox_type">String</span></div><div class="dox_tag_detail"><span>callback </span><span class="dox_type">Function</span><span>- function.</span></div><div class="dox_tag_detail"><span>options. </span><span class="dox_type">Object</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Socket</span><span>for chaining.</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">write</span> <span class="o">=</span>
<span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">send</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">sendPacket</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="nx">msg</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">fn</span><span class="p">);</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-159"><td class="docs"><div class="pilwrap"><a href="#section-159" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Sends a packet.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>packet </span><span class="dox_type">String</span><span>- type.</span></div><div class="dox_tag_detail"><span>data. </span><span class="dox_type">String</span></div><div class="dox_tag_detail"><span>options. </span><span class="dox_type">Object</span></div><div class="dox_tag_detail"><span>callback </span><span class="dox_type">Function</span><span>- function.</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">sendPacket</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;function&#39;</span> <span class="o">==</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">fn</span> <span class="o">=</span> <span class="nx">options</span><span class="p">;</span>
    <span class="nx">options</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;closing&#39;</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">||</span> <span class="s1">&#39;closed&#39;</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
  <span class="nx">options</span><span class="p">.</span><span class="nx">compress</span> <span class="o">=</span> <span class="kc">false</span> <span class="o">!==</span> <span class="nx">options</span><span class="p">.</span><span class="nx">compress</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">packet</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">type</span><span class="o">:</span> <span class="nx">type</span><span class="p">,</span>
    <span class="nx">data</span><span class="o">:</span> <span class="nx">data</span><span class="p">,</span>
    <span class="nx">options</span><span class="o">:</span> <span class="nx">options</span>
  <span class="p">};</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;packetCreate&#39;</span><span class="p">,</span> <span class="nx">packet</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">writeBuffer</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">packet</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">callbackBuffer</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">fn</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">flush</span><span class="p">();</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-160"><td class="docs"><div class="pilwrap"><a href="#section-160" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Closes the connection.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">close</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;opening&#39;</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">||</span> <span class="s1">&#39;open&#39;</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">=</span> <span class="s1">&#39;closing&#39;</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="kd">function</span> <span class="nx">close</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">onClose</span><span class="p">(</span><span class="s1">&#39;forced close&#39;</span><span class="p">);</span>
      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;socket closing - telling transport to close&#39;</span><span class="p">);</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">cleanupAndClose</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">removeListener</span><span class="p">(</span><span class="s1">&#39;upgrade&#39;</span><span class="p">,</span> <span class="nx">cleanupAndClose</span><span class="p">);</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">removeListener</span><span class="p">(</span><span class="s1">&#39;upgradeError&#39;</span><span class="p">,</span> <span class="nx">cleanupAndClose</span><span class="p">);</span>
      <span class="nx">close</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">waitForUpgrade</span><span class="p">()</span> <span class="p">{</span></pre></div></td></tr><tr id="section-161"><td class="docs"><div class="pilwrap"><a href="#section-161" class="pilcrow">&#182;</a></div><p>wait for upgrade to finish since we can't send packets while pausing a transport</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">self</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;upgrade&#39;</span><span class="p">,</span> <span class="nx">cleanupAndClose</span><span class="p">);</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;upgradeError&#39;</span><span class="p">,</span> <span class="nx">cleanupAndClose</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">writeBuffer</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;drain&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">upgrading</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">waitForUpgrade</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">close</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">upgrading</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">waitForUpgrade</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">close</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-162"><td class="docs"><div class="pilwrap"><a href="#section-162" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Called upon transport error</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onError</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;socket error %j&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
  <span class="nx">Socket</span><span class="p">.</span><span class="nx">priorWebsocketSuccess</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">onClose</span><span class="p">(</span><span class="s1">&#39;transport error&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-163"><td class="docs"><div class="pilwrap"><a href="#section-163" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Called upon transport close.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onClose</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">reason</span><span class="p">,</span> <span class="nx">desc</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;opening&#39;</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">||</span> <span class="s1">&#39;open&#39;</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">||</span> <span class="s1">&#39;closing&#39;</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;socket close with reason: &quot;%s&quot;&#39;</span><span class="p">,</span> <span class="nx">reason</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></pre></div></td></tr><tr id="section-164"><td class="docs"><div class="pilwrap"><a href="#section-164" class="pilcrow">&#182;</a></div><p>clear timers</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">clearTimeout</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pingIntervalTimer</span><span class="p">);</span>
    <span class="nx">clearTimeout</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pingTimeoutTimer</span><span class="p">);</span></pre></div></td></tr><tr id="section-165"><td class="docs"><div class="pilwrap"><a href="#section-165" class="pilcrow">&#182;</a></div><p>clean buffers in next tick, so developers can still
grab the buffers on <code>close</code> event</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">writeBuffer</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">callbackBuffer</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">prevBufferLen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">},</span> <span class="mi">0</span><span class="p">);</span></pre></div></td></tr><tr id="section-166"><td class="docs"><div class="pilwrap"><a href="#section-166" class="pilcrow">&#182;</a></div><p>stop event from firing again for transport</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">removeAllListeners</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">);</span></pre></div></td></tr><tr id="section-167"><td class="docs"><div class="pilwrap"><a href="#section-167" class="pilcrow">&#182;</a></div><p>ensure transport won't stay open</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span></pre></div></td></tr><tr id="section-168"><td class="docs"><div class="pilwrap"><a href="#section-168" class="pilcrow">&#182;</a></div><p>ignore further transport communication</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">removeAllListeners</span><span class="p">();</span></pre></div></td></tr><tr id="section-169"><td class="docs"><div class="pilwrap"><a href="#section-169" class="pilcrow">&#182;</a></div><p>set ready state</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">=</span> <span class="s1">&#39;closed&#39;</span><span class="p">;</span></pre></div></td></tr><tr id="section-170"><td class="docs"><div class="pilwrap"><a href="#section-170" class="pilcrow">&#182;</a></div><p>clear session id</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span></pre></div></td></tr><tr id="section-171"><td class="docs"><div class="pilwrap"><a href="#section-171" class="pilcrow">&#182;</a></div><p>emit close event</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="nx">reason</span><span class="p">,</span> <span class="nx">desc</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-172"><td class="docs"><div class="pilwrap"><a href="#section-172" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Filters upgrades, returning only those matching client transports.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>server </span><span class="dox_type">Array</span><span>- upgrades</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">filterUpgrades</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">upgrades</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">filteredUpgrades</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">j</span> <span class="o">=</span> <span class="nx">upgrades</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">j</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">~</span><span class="nx">index</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">transports</span><span class="p">,</span> <span class="nx">upgrades</span><span class="p">[</span><span class="nx">i</span><span class="p">]))</span> <span class="nx">filteredUpgrades</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">upgrades</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">filteredUpgrades</span><span class="p">;</span>
<span class="p">};</span>

<span class="p">}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="k">typeof</span> <span class="nx">self</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span> <span class="o">?</span> <span class="nx">self</span> <span class="o">:</span> <span class="k">typeof</span> <span class="nb">window</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span> <span class="o">?</span> <span class="nb">window</span> <span class="o">:</span> <span class="p">{})</span>
<span class="p">},{</span><span class="s2">&quot;./transport&quot;</span><span class="o">:</span><span class="mi">14</span><span class="p">,</span><span class="s2">&quot;./transports&quot;</span><span class="o">:</span><span class="mi">15</span><span class="p">,</span><span class="s2">&quot;component-emitter&quot;</span><span class="o">:</span><span class="mi">9</span><span class="p">,</span><span class="s2">&quot;debug&quot;</span><span class="o">:</span><span class="mi">22</span><span class="p">,</span><span class="s2">&quot;engine.io-parser&quot;</span><span class="o">:</span><span class="mi">25</span><span class="p">,</span><span class="s2">&quot;indexof&quot;</span><span class="o">:</span><span class="mi">42</span><span class="p">,</span><span class="s2">&quot;parsejson&quot;</span><span class="o">:</span><span class="mi">34</span><span class="p">,</span><span class="s2">&quot;parseqs&quot;</span><span class="o">:</span><span class="mi">35</span><span class="p">,</span><span class="s2">&quot;parseuri&quot;</span><span class="o">:</span><span class="mi">36</span><span class="p">}],</span><span class="mi">14</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span></pre></div></td></tr><tr id="section-173"><td class="docs"><div class="pilwrap"><a href="#section-173" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Module dependencies.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">parser</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;engine.io-parser&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">Emitter</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;component-emitter&#39;</span><span class="p">);</span></pre></div></td></tr><tr id="section-174"><td class="docs"><div class="pilwrap"><a href="#section-174" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Module exports.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Transport</span><span class="p">;</span></pre></div></td></tr><tr id="section-175"><td class="docs"><div class="pilwrap"><a href="#section-175" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Transport abstract constructor.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>options. </span><span class="dox_type">Object</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">Transport</span> <span class="p">(</span><span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">path</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">hostname</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">hostname</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">port</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">port</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">secure</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">secure</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">query</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">query</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">timestampParam</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">timestampParam</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">timestampRequests</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">timestampRequests</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">agent</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">agent</span> <span class="o">||</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">socket</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">enablesXDR</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">enablesXDR</span><span class="p">;</span></pre></div></td></tr><tr id="section-176"><td class="docs"><div class="pilwrap"><a href="#section-176" class="pilcrow">&#182;</a></div><p>SSL options for Node.js client</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">pfx</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">pfx</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">key</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">key</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">passphrase</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">passphrase</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">cert</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">cert</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">ca</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">ca</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">ciphers</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">ciphers</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">rejectUnauthorized</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">rejectUnauthorized</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-177"><td class="docs"><div class="pilwrap"><a href="#section-177" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Mix in <code>Emitter</code>.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Emitter</span><span class="p">(</span><span class="nx">Transport</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span></pre></div></td></tr><tr id="section-178"><td class="docs"><div class="pilwrap"><a href="#section-178" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>A counter used to prevent collisions in the timestamps used<br />for cache busting.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Transport</span><span class="p">.</span><span class="nx">timestamps</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr><tr id="section-179"><td class="docs"><div class="pilwrap"><a href="#section-179" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Emits an error.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>str </span><span class="dox_type">String</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Transport</span><span>for chaining</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Transport</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onError</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">desc</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">err</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
  <span class="nx">err</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">&#39;TransportError&#39;</span><span class="p">;</span>
  <span class="nx">err</span><span class="p">.</span><span class="nx">description</span> <span class="o">=</span> <span class="nx">desc</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-180"><td class="docs"><div class="pilwrap"><a href="#section-180" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Opens the transport.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Transport</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">open</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;closed&#39;</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">=</span> <span class="s1">&#39;opening&#39;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">doOpen</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-181"><td class="docs"><div class="pilwrap"><a href="#section-181" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Closes the transport.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Transport</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">close</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;opening&#39;</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">||</span> <span class="s1">&#39;open&#39;</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">doClose</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">onClose</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-182"><td class="docs"><div class="pilwrap"><a href="#section-182" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Sends multiple packets.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>packets </span><span class="dox_type">Array</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Transport</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">send</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">packets</span><span class="p">){</span>
  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;open&#39;</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">packets</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Transport not open&#39;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-183"><td class="docs"><div class="pilwrap"><a href="#section-183" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Called upon open</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Transport</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onOpen</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">=</span> <span class="s1">&#39;open&#39;</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">writable</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">);</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-184"><td class="docs"><div class="pilwrap"><a href="#section-184" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Called with data.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>data </span><span class="dox_type">String</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Transport</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onData</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">packet</span> <span class="o">=</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">decodePacket</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">binaryType</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">onPacket</span><span class="p">(</span><span class="nx">packet</span><span class="p">);</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-185"><td class="docs"><div class="pilwrap"><a href="#section-185" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Called with a decoded packet.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Transport</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onPacket</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">packet</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;packet&#39;</span><span class="p">,</span> <span class="nx">packet</span><span class="p">);</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-186"><td class="docs"><div class="pilwrap"><a href="#section-186" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Called upon close.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Transport</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onClose</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">=</span> <span class="s1">&#39;closed&#39;</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">);</span>
<span class="p">};</span>

<span class="p">},{</span><span class="s2">&quot;component-emitter&quot;</span><span class="o">:</span><span class="mi">9</span><span class="p">,</span><span class="s2">&quot;engine.io-parser&quot;</span><span class="o">:</span><span class="mi">25</span><span class="p">}],</span><span class="mi">15</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span>
<span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">global</span><span class="p">){</span></pre></div></td></tr><tr id="section-187"><td class="docs"><div class="pilwrap"><a href="#section-187" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Module dependencies</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">XMLHttpRequest</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;xmlhttprequest&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">XHR</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;./polling-xhr&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">JSONP</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;./polling-jsonp&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">websocket</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;./websocket&#39;</span><span class="p">);</span></pre></div></td></tr><tr id="section-188"><td class="docs"><div class="pilwrap"><a href="#section-188" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Export transports.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">polling</span> <span class="o">=</span> <span class="nx">polling</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">websocket</span> <span class="o">=</span> <span class="nx">websocket</span><span class="p">;</span></pre></div></td></tr><tr id="section-189"><td class="docs"><div class="pilwrap"><a href="#section-189" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Polling transport polymorphic constructor.<br />Decides on xhr vs jsonp based on feature detection.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">polling</span><span class="p">(</span><span class="nx">opts</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">xhr</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">xd</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">xs</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">jsonp</span> <span class="o">=</span> <span class="kc">false</span> <span class="o">!==</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">jsonp</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">location</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">isSSL</span> <span class="o">=</span> <span class="s1">&#39;https:&#39;</span> <span class="o">==</span> <span class="nx">location</span><span class="p">.</span><span class="nx">protocol</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">port</span> <span class="o">=</span> <span class="nx">location</span><span class="p">.</span><span class="nx">port</span><span class="p">;</span></pre></div></td></tr><tr id="section-190"><td class="docs"><div class="pilwrap"><a href="#section-190" class="pilcrow">&#182;</a></div><p>some user agents have empty <code>location.port</code></p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">port</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">port</span> <span class="o">=</span> <span class="nx">isSSL</span> <span class="o">?</span> <span class="mi">443</span> <span class="o">:</span> <span class="mi">80</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">xd</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">hostname</span> <span class="o">!=</span> <span class="nx">location</span><span class="p">.</span><span class="nx">hostname</span> <span class="o">||</span> <span class="nx">port</span> <span class="o">!=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">port</span><span class="p">;</span>
    <span class="nx">xs</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">secure</span> <span class="o">!=</span> <span class="nx">isSSL</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">opts</span><span class="p">.</span><span class="nx">xdomain</span> <span class="o">=</span> <span class="nx">xd</span><span class="p">;</span>
  <span class="nx">opts</span><span class="p">.</span><span class="nx">xscheme</span> <span class="o">=</span> <span class="nx">xs</span><span class="p">;</span>
  <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">(</span><span class="nx">opts</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;open&#39;</span> <span class="k">in</span> <span class="nx">xhr</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">opts</span><span class="p">.</span><span class="nx">forceJSONP</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">XHR</span><span class="p">(</span><span class="nx">opts</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">jsonp</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;JSONP disabled&#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">JSONP</span><span class="p">(</span><span class="nx">opts</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="p">}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="k">typeof</span> <span class="nx">self</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span> <span class="o">?</span> <span class="nx">self</span> <span class="o">:</span> <span class="k">typeof</span> <span class="nb">window</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span> <span class="o">?</span> <span class="nb">window</span> <span class="o">:</span> <span class="p">{})</span>
<span class="p">},{</span><span class="s2">&quot;./polling-jsonp&quot;</span><span class="o">:</span><span class="mi">16</span><span class="p">,</span><span class="s2">&quot;./polling-xhr&quot;</span><span class="o">:</span><span class="mi">17</span><span class="p">,</span><span class="s2">&quot;./websocket&quot;</span><span class="o">:</span><span class="mi">19</span><span class="p">,</span><span class="s2">&quot;xmlhttprequest&quot;</span><span class="o">:</span><span class="mi">20</span><span class="p">}],</span><span class="mi">16</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span>
<span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">global</span><span class="p">){</span></pre></div></td></tr><tr id="section-191"><td class="docs"><div class="pilwrap"><a href="#section-191" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Module requirements.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">Polling</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;./polling&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">inherit</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;component-inherit&#39;</span><span class="p">);</span></pre></div></td></tr><tr id="section-192"><td class="docs"><div class="pilwrap"><a href="#section-192" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Module exports.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">JSONPPolling</span><span class="p">;</span></pre></div></td></tr><tr id="section-193"><td class="docs"><div class="pilwrap"><a href="#section-193" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Cached regular expressions.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">rNewline</span> <span class="o">=</span> <span class="sr">/\n/g</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">rEscapedNewline</span> <span class="o">=</span> <span class="sr">/\\n/g</span><span class="p">;</span></pre></div></td></tr><tr id="section-194"><td class="docs"><div class="pilwrap"><a href="#section-194" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Global JSONP callbacks.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">callbacks</span><span class="p">;</span></pre></div></td></tr><tr id="section-195"><td class="docs"><div class="pilwrap"><a href="#section-195" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Callbacks count.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr><tr id="section-196"><td class="docs"><div class="pilwrap"><a href="#section-196" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Noop.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">empty</span> <span class="p">()</span> <span class="p">{</span> <span class="p">}</span></pre></div></td></tr><tr id="section-197"><td class="docs"><div class="pilwrap"><a href="#section-197" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>JSONP Polling constructor.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>opts. </span><span class="dox_type">Object</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">JSONPPolling</span> <span class="p">(</span><span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">Polling</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">query</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span> <span class="o">||</span> <span class="p">{};</span></pre></div></td></tr><tr id="section-198"><td class="docs"><div class="pilwrap"><a href="#section-198" class="pilcrow">&#182;</a></div><p>define global callbacks array if not present
we do this here (lazily) to avoid unneeded global pollution</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">callbacks</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-199"><td class="docs"><div class="pilwrap"><a href="#section-199" class="pilcrow">&#182;</a></div><p>we need to consider multiple engines in the same page</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">global</span><span class="p">.</span><span class="nx">___eio</span><span class="p">)</span> <span class="nx">global</span><span class="p">.</span><span class="nx">___eio</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">callbacks</span> <span class="o">=</span> <span class="nx">global</span><span class="p">.</span><span class="nx">___eio</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-200"><td class="docs"><div class="pilwrap"><a href="#section-200" class="pilcrow">&#182;</a></div><p>callback identifier</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">index</span> <span class="o">=</span> <span class="nx">callbacks</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span></pre></div></td></tr><tr id="section-201"><td class="docs"><div class="pilwrap"><a href="#section-201" class="pilcrow">&#182;</a></div><p>add callback to jsonp global</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="nx">callbacks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">onData</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
  <span class="p">});</span></pre></div></td></tr><tr id="section-202"><td class="docs"><div class="pilwrap"><a href="#section-202" class="pilcrow">&#182;</a></div><p>append to query string</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">j</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">;</span></pre></div></td></tr><tr id="section-203"><td class="docs"><div class="pilwrap"><a href="#section-203" class="pilcrow">&#182;</a></div><p>prevent spurious errors from being emitted when the window is unloaded</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nb">document</span> <span class="o">&amp;&amp;</span> <span class="nx">global</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">global</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;beforeunload&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">script</span><span class="p">)</span> <span class="nx">self</span><span class="p">.</span><span class="nx">script</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="nx">empty</span><span class="p">;</span>
    <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-204"><td class="docs"><div class="pilwrap"><a href="#section-204" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Inherits from Polling.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">inherit</span><span class="p">(</span><span class="nx">JSONPPolling</span><span class="p">,</span> <span class="nx">Polling</span><span class="p">);</span></pre></div></td></tr><tr id="section-205"><td class="docs"><div class="pilwrap"><a href="#section-205" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>JSONP only supports binary as base64 encoded strings</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">JSONPPolling</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">supportsBinary</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></pre></div></td></tr><tr id="section-206"><td class="docs"><div class="pilwrap"><a href="#section-206" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Closes the socket.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">JSONPPolling</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">doClose</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">script</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">script</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">script</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">script</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">form</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">form</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">form</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">form</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">iframe</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">Polling</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">doClose</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-207"><td class="docs"><div class="pilwrap"><a href="#section-207" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Starts a poll cycle.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">JSONPPolling</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">doPoll</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">script</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">script</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">script</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">script</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">script</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">script</span><span class="p">.</span><span class="nx">async</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="nx">script</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span><span class="p">();</span>
  <span class="nx">script</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">onError</span><span class="p">(</span><span class="s1">&#39;jsonp poll error&#39;</span><span class="p">,</span><span class="nx">e</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">insertAt</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
  <span class="nx">insertAt</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">script</span><span class="p">,</span> <span class="nx">insertAt</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">script</span> <span class="o">=</span> <span class="nx">script</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">isUAgecko</span> <span class="o">=</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">!=</span> <span class="k">typeof</span> <span class="nx">navigator</span> <span class="o">&amp;&amp;</span> <span class="sr">/gecko/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="nx">isUAgecko</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">iframe</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;iframe&#39;</span><span class="p">);</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">iframe</span><span class="p">);</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">iframe</span><span class="p">);</span>
    <span class="p">},</span> <span class="mi">100</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-208"><td class="docs"><div class="pilwrap"><a href="#section-208" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Writes with a hidden iframe.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>data </span><span class="dox_type">String</span><span>- to send</span></div><div class="dox_tag_detail"><span>called </span><span class="dox_type">Function</span><span>- upon flush.</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">JSONPPolling</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">doWrite</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">form</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">form</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;form&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">area</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;textarea&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">iframeId</span> <span class="o">=</span> <span class="s1">&#39;eio_iframe_&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">iframe</span><span class="p">;</span>

    <span class="nx">form</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="s1">&#39;socketio&#39;</span><span class="p">;</span>
    <span class="nx">form</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="s1">&#39;absolute&#39;</span><span class="p">;</span>
    <span class="nx">form</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">top</span> <span class="o">=</span> <span class="s1">&#39;-1000px&#39;</span><span class="p">;</span>
    <span class="nx">form</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">left</span> <span class="o">=</span> <span class="s1">&#39;-1000px&#39;</span><span class="p">;</span>
    <span class="nx">form</span><span class="p">.</span><span class="nx">target</span> <span class="o">=</span> <span class="nx">id</span><span class="p">;</span>
    <span class="nx">form</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="s1">&#39;POST&#39;</span><span class="p">;</span>
    <span class="nx">form</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;accept-charset&#39;</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">);</span>
    <span class="nx">area</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s1">&#39;d&#39;</span><span class="p">;</span>
    <span class="nx">form</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">area</span><span class="p">);</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">form</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">form</span> <span class="o">=</span> <span class="nx">form</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">area</span> <span class="o">=</span> <span class="nx">area</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">form</span><span class="p">.</span><span class="nx">action</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span><span class="p">();</span>

  <span class="kd">function</span> <span class="nx">complete</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">initIframe</span><span class="p">();</span>
    <span class="nx">fn</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">initIframe</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">iframe</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">form</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">iframe</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">onError</span><span class="p">(</span><span class="s1">&#39;jsonp polling iframe removal error&#39;</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">try</span> <span class="p">{</span></pre></div></td></tr><tr id="section-209"><td class="docs"><div class="pilwrap"><a href="#section-209" class="pilcrow">&#182;</a></div><p>ie6 dynamic iframes with target="" support (thanks Chris Lambacher)</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">html</span> <span class="o">=</span> <span class="s1">&#39;&lt;iframe src=&quot;javascript:0&quot; name=&quot;&#39;</span><span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">iframeId</span> <span class="o">+</span><span class="s1">&#39;&quot;&gt;&#39;</span><span class="p">;</span>
      <span class="nx">iframe</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="nx">html</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">iframe</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;iframe&#39;</span><span class="p">);</span>
      <span class="nx">iframe</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">iframeId</span><span class="p">;</span>
      <span class="nx">iframe</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="s1">&#39;javascript:0&#39;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">iframe</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">iframeId</span><span class="p">;</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">form</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">iframe</span><span class="p">);</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">iframe</span> <span class="o">=</span> <span class="nx">iframe</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">initIframe</span><span class="p">();</span></pre></div></td></tr><tr id="section-210"><td class="docs"><div class="pilwrap"><a href="#section-210" class="pilcrow">&#182;</a></div><p>escape \n to prevent it from being converted into \r\n by some UAs
double escaping is required for escaped new lines because unescaping of new lines can be done safely on server-side</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">data</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">rEscapedNewline</span><span class="p">,</span> <span class="s1">&#39;\\\n&#39;</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">area</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">rNewline</span><span class="p">,</span> <span class="s1">&#39;\\n&#39;</span><span class="p">);</span>

  <span class="k">try</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">form</span><span class="p">.</span><span class="nx">submit</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{}</span>

  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">iframe</span><span class="p">.</span><span class="nx">attachEvent</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">iframe</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">iframe</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="s1">&#39;complete&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">complete</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">};</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">iframe</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="nx">complete</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="p">}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="k">typeof</span> <span class="nx">self</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span> <span class="o">?</span> <span class="nx">self</span> <span class="o">:</span> <span class="k">typeof</span> <span class="nb">window</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span> <span class="o">?</span> <span class="nb">window</span> <span class="o">:</span> <span class="p">{})</span>
<span class="p">},{</span><span class="s2">&quot;./polling&quot;</span><span class="o">:</span><span class="mi">18</span><span class="p">,</span><span class="s2">&quot;component-inherit&quot;</span><span class="o">:</span><span class="mi">21</span><span class="p">}],</span><span class="mi">17</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span>
<span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">global</span><span class="p">){</span></pre></div></td></tr><tr id="section-211"><td class="docs"><div class="pilwrap"><a href="#section-211" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Module requirements.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">XMLHttpRequest</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;xmlhttprequest&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">Polling</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;./polling&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">Emitter</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;component-emitter&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">inherit</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;component-inherit&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">debug</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">)(</span><span class="s1">&#39;engine.io-client:polling-xhr&#39;</span><span class="p">);</span></pre></div></td></tr><tr id="section-212"><td class="docs"><div class="pilwrap"><a href="#section-212" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Module exports.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">XHR</span><span class="p">;</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">Request</span> <span class="o">=</span> <span class="nx">Request</span><span class="p">;</span></pre></div></td></tr><tr id="section-213"><td class="docs"><div class="pilwrap"><a href="#section-213" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Empty function</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">empty</span><span class="p">(){}</span></pre></div></td></tr><tr id="section-214"><td class="docs"><div class="pilwrap"><a href="#section-214" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>XHR Polling constructor.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>opts </span><span class="dox_type">Object</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">XHR</span><span class="p">(</span><span class="nx">opts</span><span class="p">){</span>
  <span class="nx">Polling</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">location</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">isSSL</span> <span class="o">=</span> <span class="s1">&#39;https:&#39;</span> <span class="o">==</span> <span class="nx">location</span><span class="p">.</span><span class="nx">protocol</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">port</span> <span class="o">=</span> <span class="nx">location</span><span class="p">.</span><span class="nx">port</span><span class="p">;</span></pre></div></td></tr><tr id="section-215"><td class="docs"><div class="pilwrap"><a href="#section-215" class="pilcrow">&#182;</a></div><p>some user agents have empty <code>location.port</code></p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">port</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">port</span> <span class="o">=</span> <span class="nx">isSSL</span> <span class="o">?</span> <span class="mi">443</span> <span class="o">:</span> <span class="mi">80</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">xd</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">hostname</span> <span class="o">!=</span> <span class="nx">global</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hostname</span> <span class="o">||</span>
      <span class="nx">port</span> <span class="o">!=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">port</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">xs</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">secure</span> <span class="o">!=</span> <span class="nx">isSSL</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-216"><td class="docs"><div class="pilwrap"><a href="#section-216" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Inherits from Polling.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">inherit</span><span class="p">(</span><span class="nx">XHR</span><span class="p">,</span> <span class="nx">Polling</span><span class="p">);</span></pre></div></td></tr><tr id="section-217"><td class="docs"><div class="pilwrap"><a href="#section-217" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>XHR supports binary</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">XHR</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">supportsBinary</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span></pre></div></td></tr><tr id="section-218"><td class="docs"><div class="pilwrap"><a href="#section-218" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Creates a request.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>method </span><span class="dox_type">String</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">XHR</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">request</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">opts</span><span class="p">){</span>
  <span class="nx">opts</span> <span class="o">=</span> <span class="nx">opts</span> <span class="o">||</span> <span class="p">{};</span>
  <span class="nx">opts</span><span class="p">.</span><span class="nx">uri</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span><span class="p">();</span>
  <span class="nx">opts</span><span class="p">.</span><span class="nx">xd</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">xd</span><span class="p">;</span>
  <span class="nx">opts</span><span class="p">.</span><span class="nx">xs</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">xs</span><span class="p">;</span>
  <span class="nx">opts</span><span class="p">.</span><span class="nx">agent</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">agent</span> <span class="o">||</span> <span class="kc">false</span><span class="p">;</span>
  <span class="nx">opts</span><span class="p">.</span><span class="nx">supportsBinary</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">supportsBinary</span><span class="p">;</span>
  <span class="nx">opts</span><span class="p">.</span><span class="nx">enablesXDR</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">enablesXDR</span><span class="p">;</span></pre></div></td></tr><tr id="section-219"><td class="docs"><div class="pilwrap"><a href="#section-219" class="pilcrow">&#182;</a></div><p>SSL options for Node.js client</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">opts</span><span class="p">.</span><span class="nx">pfx</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">pfx</span><span class="p">;</span>
  <span class="nx">opts</span><span class="p">.</span><span class="nx">key</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">key</span><span class="p">;</span>
  <span class="nx">opts</span><span class="p">.</span><span class="nx">passphrase</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">passphrase</span><span class="p">;</span>
  <span class="nx">opts</span><span class="p">.</span><span class="nx">cert</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">cert</span><span class="p">;</span>
  <span class="nx">opts</span><span class="p">.</span><span class="nx">ca</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ca</span><span class="p">;</span>
  <span class="nx">opts</span><span class="p">.</span><span class="nx">ciphers</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ciphers</span><span class="p">;</span>
  <span class="nx">opts</span><span class="p">.</span><span class="nx">rejectUnauthorized</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">rejectUnauthorized</span><span class="p">;</span>

  <span class="k">return</span> <span class="k">new</span> <span class="nx">Request</span><span class="p">(</span><span class="nx">opts</span><span class="p">);</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-220"><td class="docs"><div class="pilwrap"><a href="#section-220" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Sends data.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>data </span><span class="dox_type">String</span><span>- to send.</span></div><div class="dox_tag_detail"><span>called </span><span class="dox_type">Function</span><span>- upon flush.</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">XHR</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">doWrite</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">fn</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">isBinary</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">data</span> <span class="o">!==</span> <span class="s1">&#39;string&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">req</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">({</span> <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="o">:</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">isBinary</span><span class="o">:</span> <span class="nx">isBinary</span> <span class="p">});</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="nx">req</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;success&#39;</span><span class="p">,</span> <span class="nx">fn</span><span class="p">);</span>
  <span class="nx">req</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">onError</span><span class="p">(</span><span class="s1">&#39;xhr post error&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">sendXhr</span> <span class="o">=</span> <span class="nx">req</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-221"><td class="docs"><div class="pilwrap"><a href="#section-221" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Starts a poll cycle.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">XHR</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">doPoll</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;xhr poll&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">req</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="nx">req</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">onData</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="nx">req</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">onError</span><span class="p">(</span><span class="s1">&#39;xhr poll error&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">pollXhr</span> <span class="o">=</span> <span class="nx">req</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-222"><td class="docs"><div class="pilwrap"><a href="#section-222" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Request constructor</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>options </span><span class="dox_type">Object</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">Request</span><span class="p">(</span><span class="nx">opts</span><span class="p">){</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">method</span> <span class="o">||</span> <span class="s1">&#39;GET&#39;</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">uri</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">uri</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">xd</span> <span class="o">=</span> <span class="o">!!</span><span class="nx">opts</span><span class="p">.</span><span class="nx">xd</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">xs</span> <span class="o">=</span> <span class="o">!!</span><span class="nx">opts</span><span class="p">.</span><span class="nx">xs</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">async</span> <span class="o">=</span> <span class="kc">false</span> <span class="o">!==</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">async</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="kc">undefined</span> <span class="o">!=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">data</span> <span class="o">?</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">data</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">agent</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">agent</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">isBinary</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">isBinary</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">supportsBinary</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">supportsBinary</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">enablesXDR</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">enablesXDR</span><span class="p">;</span></pre></div></td></tr><tr id="section-223"><td class="docs"><div class="pilwrap"><a href="#section-223" class="pilcrow">&#182;</a></div><p>SSL options for Node.js client</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">pfx</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">pfx</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">key</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">key</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">passphrase</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">passphrase</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">cert</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">cert</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">ca</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">ca</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">ciphers</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">ciphers</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">rejectUnauthorized</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">rejectUnauthorized</span><span class="p">;</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">create</span><span class="p">();</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-224"><td class="docs"><div class="pilwrap"><a href="#section-224" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Mix in <code>Emitter</code>.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Emitter</span><span class="p">(</span><span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span></pre></div></td></tr><tr id="section-225"><td class="docs"><div class="pilwrap"><a href="#section-225" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Creates the XHR object and sends the request.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">create</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="kd">var</span> <span class="nx">opts</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">agent</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">agent</span><span class="p">,</span> <span class="nx">xdomain</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">xd</span><span class="p">,</span> <span class="nx">xscheme</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">xs</span><span class="p">,</span> <span class="nx">enablesXDR</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">enablesXDR</span> <span class="p">};</span></pre></div></td></tr><tr id="section-226"><td class="docs"><div class="pilwrap"><a href="#section-226" class="pilcrow">&#182;</a></div><p>SSL options for Node.js client</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">opts</span><span class="p">.</span><span class="nx">pfx</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">pfx</span><span class="p">;</span>
  <span class="nx">opts</span><span class="p">.</span><span class="nx">key</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">key</span><span class="p">;</span>
  <span class="nx">opts</span><span class="p">.</span><span class="nx">passphrase</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">passphrase</span><span class="p">;</span>
  <span class="nx">opts</span><span class="p">.</span><span class="nx">cert</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">cert</span><span class="p">;</span>
  <span class="nx">opts</span><span class="p">.</span><span class="nx">ca</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ca</span><span class="p">;</span>
  <span class="nx">opts</span><span class="p">.</span><span class="nx">ciphers</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ciphers</span><span class="p">;</span>
  <span class="nx">opts</span><span class="p">.</span><span class="nx">rejectUnauthorized</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">rejectUnauthorized</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">(</span><span class="nx">opts</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="k">try</span> <span class="p">{</span>
    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;xhr open %s: %s&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">method</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span><span class="p">);</span>
    <span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">method</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">async</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">supportsBinary</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-227"><td class="docs"><div class="pilwrap"><a href="#section-227" class="pilcrow">&#182;</a></div><p>This has to be done after open because Firefox is stupid
http://stackoverflow.com/questions/13216903/get-binary-data-with-xmlhttprequest-in-a-firefox-extension</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">xhr</span><span class="p">.</span><span class="nx">responseType</span> <span class="o">=</span> <span class="s1">&#39;arraybuffer&#39;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;POST&#39;</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">method</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isBinary</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s1">&#39;Content-type&#39;</span><span class="p">,</span> <span class="s1">&#39;application/octet-stream&#39;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s1">&#39;Content-type&#39;</span><span class="p">,</span> <span class="s1">&#39;text/plain;charset=UTF-8&#39;</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{}</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-228"><td class="docs"><div class="pilwrap"><a href="#section-228" class="pilcrow">&#182;</a></div><p>ie6 check</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;withCredentials&#39;</span> <span class="k">in</span> <span class="nx">xhr</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">xhr</span><span class="p">.</span><span class="nx">withCredentials</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hasXDR</span><span class="p">())</span> <span class="p">{</span>
      <span class="nx">xhr</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">onLoad</span><span class="p">();</span>
      <span class="p">};</span>
      <span class="nx">xhr</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">onError</span><span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
      <span class="p">};</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">xhr</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="k">if</span> <span class="p">(</span><span class="mi">4</span> <span class="o">!=</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">readyState</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="mi">200</span> <span class="o">==</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">status</span> <span class="o">||</span> <span class="mi">1223</span> <span class="o">==</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">onLoad</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr><tr id="section-229"><td class="docs"><div class="pilwrap"><a href="#section-229" class="pilcrow">&#182;</a></div><p>make sure the <code>error</code> event handler that's user-set
does not throw in the same tick and gets caught here</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">onError</span><span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">status</span><span class="p">);</span>
          <span class="p">},</span> <span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">};</span>
    <span class="p">}</span>

    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;xhr data %s&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
    <span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-230"><td class="docs"><div class="pilwrap"><a href="#section-230" class="pilcrow">&#182;</a></div><p>Need to defer since .create() is called directly fhrom the constructor
and thus the 'error' event can only be only bound <em>after</em> this exception
occurs.  Therefore, also, we cannot throw here at all.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">onError</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
    <span class="p">},</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nb">document</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">index</span> <span class="o">=</span> <span class="nx">Request</span><span class="p">.</span><span class="nx">requestsCount</span><span class="o">++</span><span class="p">;</span>
    <span class="nx">Request</span><span class="p">.</span><span class="nx">requests</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-231"><td class="docs"><div class="pilwrap"><a href="#section-231" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Called upon successful response.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onSuccess</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;success&#39;</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">cleanup</span><span class="p">();</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-232"><td class="docs"><div class="pilwrap"><a href="#section-232" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Called if we have data.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onData</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">onSuccess</span><span class="p">();</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-233"><td class="docs"><div class="pilwrap"><a href="#section-233" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Called upon error.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onError</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">cleanup</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-234"><td class="docs"><div class="pilwrap"><a href="#section-234" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Cleans up house.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">cleanup</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fromError</span><span class="p">){</span>
  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">==</span> <span class="k">typeof</span> <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span> <span class="o">||</span> <span class="kc">null</span> <span class="o">===</span> <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-235"><td class="docs"><div class="pilwrap"><a href="#section-235" class="pilcrow">&#182;</a></div><p>xmlhttprequest</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hasXDR</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="nx">empty</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="nx">empty</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">fromError</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">abort</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{}</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nb">document</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">delete</span> <span class="nx">Request</span><span class="p">.</span><span class="nx">requests</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-236"><td class="docs"><div class="pilwrap"><a href="#section-236" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Called upon load.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onLoad</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="kd">var</span> <span class="nx">data</span><span class="p">;</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">contentType</span><span class="p">;</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">contentType</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">getResponseHeader</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">contentType</span> <span class="o">===</span> <span class="s1">&#39;application/octet-stream&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">response</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">supportsBinary</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">data</span> <span class="o">=</span> <span class="s1">&#39;ok&#39;</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">onError</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">onData</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-237"><td class="docs"><div class="pilwrap"><a href="#section-237" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Check if it has XDomainRequest.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hasXDR</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="k">return</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">global</span><span class="p">.</span><span class="nx">XDomainRequest</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">xs</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">enablesXDR</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-238"><td class="docs"><div class="pilwrap"><a href="#section-238" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Aborts the request.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">abort</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">cleanup</span><span class="p">();</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-239"><td class="docs"><div class="pilwrap"><a href="#section-239" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Aborts pending requests when unloading the window. This is needed to prevent<br />memory leaks (e.g. when using IE) and to ensure that no spurious error is<br />emitted.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nb">document</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">Request</span><span class="p">.</span><span class="nx">requestsCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nx">Request</span><span class="p">.</span><span class="nx">requests</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">attachEvent</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">global</span><span class="p">.</span><span class="nx">attachEvent</span><span class="p">(</span><span class="s1">&#39;onunload&#39;</span><span class="p">,</span> <span class="nx">unloadHandler</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">global</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;beforeunload&#39;</span><span class="p">,</span> <span class="nx">unloadHandler</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">unloadHandler</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">Request</span><span class="p">.</span><span class="nx">requests</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">Request</span><span class="p">.</span><span class="nx">requests</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">Request</span><span class="p">.</span><span class="nx">requests</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">abort</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="p">}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="k">typeof</span> <span class="nx">self</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span> <span class="o">?</span> <span class="nx">self</span> <span class="o">:</span> <span class="k">typeof</span> <span class="nb">window</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span> <span class="o">?</span> <span class="nb">window</span> <span class="o">:</span> <span class="p">{})</span>
<span class="p">},{</span><span class="s2">&quot;./polling&quot;</span><span class="o">:</span><span class="mi">18</span><span class="p">,</span><span class="s2">&quot;component-emitter&quot;</span><span class="o">:</span><span class="mi">9</span><span class="p">,</span><span class="s2">&quot;component-inherit&quot;</span><span class="o">:</span><span class="mi">21</span><span class="p">,</span><span class="s2">&quot;debug&quot;</span><span class="o">:</span><span class="mi">22</span><span class="p">,</span><span class="s2">&quot;xmlhttprequest&quot;</span><span class="o">:</span><span class="mi">20</span><span class="p">}],</span><span class="mi">18</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span></pre></div></td></tr><tr id="section-240"><td class="docs"><div class="pilwrap"><a href="#section-240" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Module dependencies.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">Transport</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;../transport&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">parseqs</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;parseqs&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">parser</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;engine.io-parser&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">inherit</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;component-inherit&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">debug</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">)(</span><span class="s1">&#39;engine.io-client:polling&#39;</span><span class="p">);</span></pre></div></td></tr><tr id="section-241"><td class="docs"><div class="pilwrap"><a href="#section-241" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Module exports.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Polling</span><span class="p">;</span></pre></div></td></tr><tr id="section-242"><td class="docs"><div class="pilwrap"><a href="#section-242" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Is XHR2 supported?</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">hasXHR2</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">XMLHttpRequest</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;xmlhttprequest&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">({</span> <span class="nx">xdomain</span><span class="o">:</span> <span class="kc">false</span> <span class="p">});</span>
  <span class="k">return</span> <span class="kc">null</span> <span class="o">!=</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">responseType</span><span class="p">;</span>
<span class="p">})();</span></pre></div></td></tr><tr id="section-243"><td class="docs"><div class="pilwrap"><a href="#section-243" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Polling interface.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>opts </span><span class="dox_type">Object</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">Polling</span><span class="p">(</span><span class="nx">opts</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">forceBase64</span> <span class="o">=</span> <span class="p">(</span><span class="nx">opts</span> <span class="o">&amp;&amp;</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">forceBase64</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">hasXHR2</span> <span class="o">||</span> <span class="nx">forceBase64</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">supportsBinary</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">Transport</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-244"><td class="docs"><div class="pilwrap"><a href="#section-244" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Inherits from Transport.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">inherit</span><span class="p">(</span><span class="nx">Polling</span><span class="p">,</span> <span class="nx">Transport</span><span class="p">);</span></pre></div></td></tr><tr id="section-245"><td class="docs"><div class="pilwrap"><a href="#section-245" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Transport name.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Polling</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s1">&#39;polling&#39;</span><span class="p">;</span></pre></div></td></tr><tr id="section-246"><td class="docs"><div class="pilwrap"><a href="#section-246" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Opens the socket (triggers polling). We write a PING message to determine<br />when the transport is open.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Polling</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">doOpen</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">poll</span><span class="p">();</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-247"><td class="docs"><div class="pilwrap"><a href="#section-247" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Pauses polling.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>callback </span><span class="dox_type">Function</span><span>- upon buffers are flushed and transport is paused</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Polling</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">pause</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">onPause</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">=</span> <span class="s1">&#39;pausing&#39;</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">pause</span><span class="p">(){</span>
    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;paused&#39;</span><span class="p">);</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">=</span> <span class="s1">&#39;paused&#39;</span><span class="p">;</span>
    <span class="nx">onPause</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">polling</span> <span class="o">||</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">writable</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">polling</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;we are currently polling - waiting to pause&#39;</span><span class="p">);</span>
      <span class="nx">total</span><span class="o">++</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;pollComplete&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;pre-pause polling complete&#39;</span><span class="p">);</span>
        <span class="o">--</span><span class="nx">total</span> <span class="o">||</span> <span class="nx">pause</span><span class="p">();</span>
      <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">writable</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;we are currently writing - waiting to pause&#39;</span><span class="p">);</span>
      <span class="nx">total</span><span class="o">++</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;drain&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;pre-pause writing complete&#39;</span><span class="p">);</span>
        <span class="o">--</span><span class="nx">total</span> <span class="o">||</span> <span class="nx">pause</span><span class="p">();</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">pause</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-248"><td class="docs"><div class="pilwrap"><a href="#section-248" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Starts polling cycle.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Polling</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">poll</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;polling&#39;</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">polling</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">doPoll</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;poll&#39;</span><span class="p">);</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-249"><td class="docs"><div class="pilwrap"><a href="#section-249" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Overloads onData to detect payloads.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Polling</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onData</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;polling got data %s&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">callback</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">total</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-250"><td class="docs"><div class="pilwrap"><a href="#section-250" class="pilcrow">&#182;</a></div><p>if its the first message we consider the transport open</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;opening&#39;</span> <span class="o">==</span> <span class="nx">self</span><span class="p">.</span><span class="nx">readyState</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">onOpen</span><span class="p">();</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-251"><td class="docs"><div class="pilwrap"><a href="#section-251" class="pilcrow">&#182;</a></div><p>if its a close packet, we close the ongoing requests</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;close&#39;</span> <span class="o">==</span> <span class="nx">packet</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">onClose</span><span class="p">();</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-252"><td class="docs"><div class="pilwrap"><a href="#section-252" class="pilcrow">&#182;</a></div><p>otherwise bypass onData and handle the message</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">self</span><span class="p">.</span><span class="nx">onPacket</span><span class="p">(</span><span class="nx">packet</span><span class="p">);</span>
  <span class="p">};</span></pre></div></td></tr><tr id="section-253"><td class="docs"><div class="pilwrap"><a href="#section-253" class="pilcrow">&#182;</a></div><p>decode payload</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">parser</span><span class="p">.</span><span class="nx">decodePayload</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">binaryType</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span></pre></div></td></tr><tr id="section-254"><td class="docs"><div class="pilwrap"><a href="#section-254" class="pilcrow">&#182;</a></div><p>if an event did not trigger closing</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;closed&#39;</span> <span class="o">!=</span> <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-255"><td class="docs"><div class="pilwrap"><a href="#section-255" class="pilcrow">&#182;</a></div><p>if we got data we're not polling</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">polling</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;pollComplete&#39;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;open&#39;</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">poll</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;ignoring poll - transport state &quot;%s&quot;&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-256"><td class="docs"><div class="pilwrap"><a href="#section-256" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>For polling, send a close packet.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Polling</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">doClose</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">close</span><span class="p">(){</span>
    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;writing close packet&#39;</span><span class="p">);</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">write</span><span class="p">([{</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;close&#39;</span> <span class="p">}]);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;open&#39;</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;transport open - closing&#39;</span><span class="p">);</span>
    <span class="nx">close</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr><tr id="section-257"><td class="docs"><div class="pilwrap"><a href="#section-257" class="pilcrow">&#182;</a></div><p>in case we're trying to close while
handshaking is in progress (GH-164)</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;transport not open - deferring close&#39;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="nx">close</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-258"><td class="docs"><div class="pilwrap"><a href="#section-258" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Writes a packets payload.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>data </span><span class="dox_type">Array</span><span>- packets</span></div><div class="dox_tag_detail"><span>drain </span><span class="dox_type">Function</span><span>- callback</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Polling</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">write</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">packets</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">writable</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">callbackfn</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">writable</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;drain&#39;</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="nx">parser</span><span class="p">.</span><span class="nx">encodePayload</span><span class="p">(</span><span class="nx">packets</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">supportsBinary</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">doWrite</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">callbackfn</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-259"><td class="docs"><div class="pilwrap"><a href="#section-259" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Generates uri for connection.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Polling</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">uri</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="kd">var</span> <span class="nx">query</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span> <span class="o">||</span> <span class="p">{};</span>
  <span class="kd">var</span> <span class="nx">schema</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">secure</span> <span class="o">?</span> <span class="s1">&#39;https&#39;</span> <span class="o">:</span> <span class="s1">&#39;http&#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">port</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span></pre></div></td></tr><tr id="section-260"><td class="docs"><div class="pilwrap"><a href="#section-260" class="pilcrow">&#182;</a></div><p>cache busting is forced</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="kc">false</span> <span class="o">!==</span> <span class="k">this</span><span class="p">.</span><span class="nx">timestampRequests</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">query</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">timestampParam</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="k">new</span> <span class="nb">Date</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nx">Transport</span><span class="p">.</span><span class="nx">timestamps</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">supportsBinary</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">query</span><span class="p">.</span><span class="nx">sid</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">query</span><span class="p">.</span><span class="nx">b64</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">query</span> <span class="o">=</span> <span class="nx">parseqs</span><span class="p">.</span><span class="nx">encode</span><span class="p">(</span><span class="nx">query</span><span class="p">);</span></pre></div></td></tr><tr id="section-261"><td class="docs"><div class="pilwrap"><a href="#section-261" class="pilcrow">&#182;</a></div><p>avoid port if default for schema</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">port</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="s1">&#39;https&#39;</span> <span class="o">==</span> <span class="nx">schema</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">port</span> <span class="o">!=</span> <span class="mi">443</span><span class="p">)</span> <span class="o">||</span>
     <span class="p">(</span><span class="s1">&#39;http&#39;</span> <span class="o">==</span> <span class="nx">schema</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">port</span> <span class="o">!=</span> <span class="mi">80</span><span class="p">)))</span> <span class="p">{</span>
    <span class="nx">port</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">port</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-262"><td class="docs"><div class="pilwrap"><a href="#section-262" class="pilcrow">&#182;</a></div><p>prepend ? to query</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">query</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">query</span> <span class="o">=</span> <span class="s1">&#39;?&#39;</span> <span class="o">+</span> <span class="nx">query</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">schema</span> <span class="o">+</span> <span class="s1">&#39;://&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">hostname</span> <span class="o">+</span> <span class="nx">port</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">path</span> <span class="o">+</span> <span class="nx">query</span><span class="p">;</span>
<span class="p">};</span>

<span class="p">},{</span><span class="s2">&quot;../transport&quot;</span><span class="o">:</span><span class="mi">14</span><span class="p">,</span><span class="s2">&quot;component-inherit&quot;</span><span class="o">:</span><span class="mi">21</span><span class="p">,</span><span class="s2">&quot;debug&quot;</span><span class="o">:</span><span class="mi">22</span><span class="p">,</span><span class="s2">&quot;engine.io-parser&quot;</span><span class="o">:</span><span class="mi">25</span><span class="p">,</span><span class="s2">&quot;parseqs&quot;</span><span class="o">:</span><span class="mi">35</span><span class="p">,</span><span class="s2">&quot;xmlhttprequest&quot;</span><span class="o">:</span><span class="mi">20</span><span class="p">}],</span><span class="mi">19</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span></pre></div></td></tr><tr id="section-263"><td class="docs"><div class="pilwrap"><a href="#section-263" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Module dependencies.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">Transport</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;../transport&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">parser</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;engine.io-parser&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">parseqs</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;parseqs&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">inherit</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;component-inherit&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">debug</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">)(</span><span class="s1">&#39;engine.io-client:websocket&#39;</span><span class="p">);</span></pre></div></td></tr><tr id="section-264"><td class="docs"><div class="pilwrap"><a href="#section-264" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p><code>ws</code> exposes a WebSocket-compatible interface in<br />Node, or the <code>WebSocket</code> or <code>MozWebSocket</code> globals<br />in the browser.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">WebSocket</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;ws&#39;</span><span class="p">);</span></pre></div></td></tr><tr id="section-265"><td class="docs"><div class="pilwrap"><a href="#section-265" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Module exports.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">WS</span><span class="p">;</span></pre></div></td></tr><tr id="section-266"><td class="docs"><div class="pilwrap"><a href="#section-266" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>WebSocket transport constructor.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">{Object}</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">WS</span><span class="p">(</span><span class="nx">opts</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">forceBase64</span> <span class="o">=</span> <span class="p">(</span><span class="nx">opts</span> <span class="o">&amp;&amp;</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">forceBase64</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">forceBase64</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">supportsBinary</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">perMessageDeflate</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">perMessageDeflate</span><span class="p">;</span>
  <span class="nx">Transport</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-267"><td class="docs"><div class="pilwrap"><a href="#section-267" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Inherits from Transport.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">inherit</span><span class="p">(</span><span class="nx">WS</span><span class="p">,</span> <span class="nx">Transport</span><span class="p">);</span></pre></div></td></tr><tr id="section-268"><td class="docs"><div class="pilwrap"><a href="#section-268" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Transport name.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">WS</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s1">&#39;websocket&#39;</span><span class="p">;</span></pre></div></td></tr><tr id="section-269"><td class="docs"><div class="pilwrap"><a href="#section-269" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>WebSockets support binary</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">WS</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">supportsBinary</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span></pre></div></td></tr><tr id="section-270"><td class="docs"><div class="pilwrap"><a href="#section-270" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Opens socket.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">WS</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">doOpen</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">check</span><span class="p">())</span> <span class="p">{</span></pre></div></td></tr><tr id="section-271"><td class="docs"><div class="pilwrap"><a href="#section-271" class="pilcrow">&#182;</a></div><p>let probe timeout</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">uri</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">protocols</span> <span class="o">=</span> <span class="k">void</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">opts</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">agent</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">agent</span><span class="p">,</span>
    <span class="nx">perMessageDeflate</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">perMessageDeflate</span>
  <span class="p">};</span></pre></div></td></tr><tr id="section-272"><td class="docs"><div class="pilwrap"><a href="#section-272" class="pilcrow">&#182;</a></div><p>SSL options for Node.js client</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">opts</span><span class="p">.</span><span class="nx">pfx</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">pfx</span><span class="p">;</span>
  <span class="nx">opts</span><span class="p">.</span><span class="nx">key</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">key</span><span class="p">;</span>
  <span class="nx">opts</span><span class="p">.</span><span class="nx">passphrase</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">passphrase</span><span class="p">;</span>
  <span class="nx">opts</span><span class="p">.</span><span class="nx">cert</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">cert</span><span class="p">;</span>
  <span class="nx">opts</span><span class="p">.</span><span class="nx">ca</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ca</span><span class="p">;</span>
  <span class="nx">opts</span><span class="p">.</span><span class="nx">ciphers</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ciphers</span><span class="p">;</span>
  <span class="nx">opts</span><span class="p">.</span><span class="nx">rejectUnauthorized</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">rejectUnauthorized</span><span class="p">;</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="nx">uri</span><span class="p">,</span> <span class="nx">protocols</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">ws</span><span class="p">.</span><span class="nx">binaryType</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">supportsBinary</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">ws</span><span class="p">.</span><span class="nx">binaryType</span> <span class="o">=</span> <span class="s1">&#39;arraybuffer&#39;</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">addEventListeners</span><span class="p">();</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-273"><td class="docs"><div class="pilwrap"><a href="#section-273" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Adds event listeners to the socket</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">WS</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addEventListeners</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">ws</span><span class="p">.</span><span class="nx">onopen</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">onOpen</span><span class="p">();</span>
  <span class="p">};</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">ws</span><span class="p">.</span><span class="nx">onclose</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">onClose</span><span class="p">();</span>
  <span class="p">};</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">ws</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ev</span><span class="p">){</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">onData</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">ws</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">onError</span><span class="p">(</span><span class="s1">&#39;websocket error&#39;</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
  <span class="p">};</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-274"><td class="docs"><div class="pilwrap"><a href="#section-274" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Override <code>onData</code> to use a timer on iOS.<br />See: <a href='https://gist.github.com/mloughran/2052006'>https://gist.github.com/mloughran/2052006</a></p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!=</span> <span class="k">typeof</span> <span class="nx">navigator</span>
  <span class="o">&amp;&amp;</span> <span class="sr">/iPad|iPhone|iPod/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">))</span> <span class="p">{</span>
  <span class="nx">WS</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onData</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
      <span class="nx">Transport</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onData</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
    <span class="p">},</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">};</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-275"><td class="docs"><div class="pilwrap"><a href="#section-275" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Writes data to socket.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>array </span><span class="dox_type">Array</span><span>- of packets.</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">WS</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">write</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">packets</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">writable</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></pre></div></td></tr><tr id="section-276"><td class="docs"><div class="pilwrap"><a href="#section-276" class="pilcrow">&#182;</a></div><p>encodePacket efficient as it uses WS framing
no need for encodePayload</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">packets</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">packet</span> <span class="o">=</span> <span class="nx">packets</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="nx">parser</span><span class="p">.</span><span class="nx">encodePacket</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">supportsBinary</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-277"><td class="docs"><div class="pilwrap"><a href="#section-277" class="pilcrow">&#182;</a></div><p>Sometimes the websocket has already been closed but the browser didn't
have a chance of informing us about it yet, in that case send will
throw an error</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">try</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">packet</span><span class="p">.</span><span class="nx">options</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">){</span>
        <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;websocket closed before onclose event&#39;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">ondrain</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">writable</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;drain&#39;</span><span class="p">);</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-278"><td class="docs"><div class="pilwrap"><a href="#section-278" class="pilcrow">&#182;</a></div><p>fake drain
defer to next tick to allow Socket to clear writeBuffer</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">ondrain</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-279"><td class="docs"><div class="pilwrap"><a href="#section-279" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Called upon close</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">WS</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onClose</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="nx">Transport</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onClose</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-280"><td class="docs"><div class="pilwrap"><a href="#section-280" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Closes socket.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">WS</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">doClose</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="k">this</span><span class="p">.</span><span class="nx">ws</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">ws</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-281"><td class="docs"><div class="pilwrap"><a href="#section-281" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Generates uri for connection.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">WS</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">uri</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="kd">var</span> <span class="nx">query</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span> <span class="o">||</span> <span class="p">{};</span>
  <span class="kd">var</span> <span class="nx">schema</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">secure</span> <span class="o">?</span> <span class="s1">&#39;wss&#39;</span> <span class="o">:</span> <span class="s1">&#39;ws&#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">port</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span></pre></div></td></tr><tr id="section-282"><td class="docs"><div class="pilwrap"><a href="#section-282" class="pilcrow">&#182;</a></div><p>avoid port if default for schema</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">port</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="s1">&#39;wss&#39;</span> <span class="o">==</span> <span class="nx">schema</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">port</span> <span class="o">!=</span> <span class="mi">443</span><span class="p">)</span>
    <span class="o">||</span> <span class="p">(</span><span class="s1">&#39;ws&#39;</span> <span class="o">==</span> <span class="nx">schema</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">port</span> <span class="o">!=</span> <span class="mi">80</span><span class="p">)))</span> <span class="p">{</span>
    <span class="nx">port</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">port</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-283"><td class="docs"><div class="pilwrap"><a href="#section-283" class="pilcrow">&#182;</a></div><p>append timestamp to URI</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">timestampRequests</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">query</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">timestampParam</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="k">new</span> <span class="nb">Date</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-284"><td class="docs"><div class="pilwrap"><a href="#section-284" class="pilcrow">&#182;</a></div><p>communicate binary support capabilities</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">supportsBinary</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">query</span><span class="p">.</span><span class="nx">b64</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">query</span> <span class="o">=</span> <span class="nx">parseqs</span><span class="p">.</span><span class="nx">encode</span><span class="p">(</span><span class="nx">query</span><span class="p">);</span></pre></div></td></tr><tr id="section-285"><td class="docs"><div class="pilwrap"><a href="#section-285" class="pilcrow">&#182;</a></div><p>prepend ? to query</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">query</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">query</span> <span class="o">=</span> <span class="s1">&#39;?&#39;</span> <span class="o">+</span> <span class="nx">query</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">schema</span> <span class="o">+</span> <span class="s1">&#39;://&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">hostname</span> <span class="o">+</span> <span class="nx">port</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">path</span> <span class="o">+</span> <span class="nx">query</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-286"><td class="docs"><div class="pilwrap"><a href="#section-286" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Feature detection for WebSocket.</p></div><div class="details"><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Boolean</span><span>whether this transport is available.</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">WS</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">check</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="k">return</span> <span class="o">!!</span><span class="nx">WebSocket</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="s1">&#39;__initialize&#39;</span> <span class="k">in</span> <span class="nx">WebSocket</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="nx">WS</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
<span class="p">};</span>

<span class="p">},{</span><span class="s2">&quot;../transport&quot;</span><span class="o">:</span><span class="mi">14</span><span class="p">,</span><span class="s2">&quot;component-inherit&quot;</span><span class="o">:</span><span class="mi">21</span><span class="p">,</span><span class="s2">&quot;debug&quot;</span><span class="o">:</span><span class="mi">22</span><span class="p">,</span><span class="s2">&quot;engine.io-parser&quot;</span><span class="o">:</span><span class="mi">25</span><span class="p">,</span><span class="s2">&quot;parseqs&quot;</span><span class="o">:</span><span class="mi">35</span><span class="p">,</span><span class="s2">&quot;ws&quot;</span><span class="o">:</span><span class="mi">37</span><span class="p">}],</span><span class="mi">20</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span></pre></div></td></tr><tr id="section-287"><td class="docs"><div class="pilwrap"><a href="#section-287" class="pilcrow">&#182;</a></div><p>browser shim for xmlhttprequest module</p>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">hasCORS</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;has-cors&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">xdomain</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">xdomain</span><span class="p">;</span></pre></div></td></tr><tr id="section-288"><td class="docs"><div class="pilwrap"><a href="#section-288" class="pilcrow">&#182;</a></div><p>scheme must be same when usign XDomainRequest
http://blogs.msdn.com/b/ieinternals/archive/2010/05/13/xdomainrequest-restrictions-limitations-and-workarounds.aspx</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">xscheme</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">xscheme</span><span class="p">;</span></pre></div></td></tr><tr id="section-289"><td class="docs"><div class="pilwrap"><a href="#section-289" class="pilcrow">&#182;</a></div><p>XDomainRequest has a flow of not sending cookie, therefore it should be disabled as a default.
https://github.com/Automattic/engine.io-client/pull/217</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">enablesXDR</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">enablesXDR</span><span class="p">;</span></pre></div></td></tr><tr id="section-290"><td class="docs"><div class="pilwrap"><a href="#section-290" class="pilcrow">&#182;</a></div><p>XMLHttpRequest can be disabled on IE</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">try</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!=</span> <span class="k">typeof</span> <span class="nx">XMLHttpRequest</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="nx">xdomain</span> <span class="o">||</span> <span class="nx">hasCORS</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span></pre></div></td></tr><tr id="section-291"><td class="docs"><div class="pilwrap"><a href="#section-291" class="pilcrow">&#182;</a></div><p>Use XDomainRequest for IE8 if enablesXDR is true
because loading bar keeps flashing when using jsonp-polling
https://github.com/yujiosaka/socke.io-ie8-loading-example</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">try</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!=</span> <span class="k">typeof</span> <span class="nx">XDomainRequest</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">xscheme</span> <span class="o">&amp;&amp;</span> <span class="nx">enablesXDR</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">XDomainRequest</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">xdomain</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">ActiveXObject</span><span class="p">(</span><span class="s1">&#39;Microsoft.XMLHTTP&#39;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="p">},{</span><span class="s2">&quot;has-cors&quot;</span><span class="o">:</span><span class="mi">40</span><span class="p">}],</span><span class="mi">21</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">fn</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){};</span>
  <span class="nx">fn</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span>
  <span class="nx">a</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">fn</span><span class="p">;</span>
  <span class="nx">a</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">a</span><span class="p">;</span>
<span class="p">};</span>
<span class="p">},{}],</span><span class="mi">22</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span></pre></div></td></tr><tr id="section-292"><td class="docs"><div class="pilwrap"><a href="#section-292" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>This is the web browser implementation of <code>debug()</code>.</p></div><div class="body"><p>Expose <code>debug()</code> as the module.</p></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">exports</span> <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;./debug&#39;</span><span class="p">);</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">log</span> <span class="o">=</span> <span class="nx">log</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">formatArgs</span> <span class="o">=</span> <span class="nx">formatArgs</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">save</span> <span class="o">=</span> <span class="nx">save</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">load</span> <span class="o">=</span> <span class="nx">load</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">useColors</span> <span class="o">=</span> <span class="nx">useColors</span><span class="p">;</span></pre></div></td></tr><tr id="section-293"><td class="docs"><div class="pilwrap"><a href="#section-293" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Colors.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">colors</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s1">&#39;lightseagreen&#39;</span><span class="p">,</span>
  <span class="s1">&#39;forestgreen&#39;</span><span class="p">,</span>
  <span class="s1">&#39;goldenrod&#39;</span><span class="p">,</span>
  <span class="s1">&#39;dodgerblue&#39;</span><span class="p">,</span>
  <span class="s1">&#39;darkorchid&#39;</span><span class="p">,</span>
  <span class="s1">&#39;crimson&#39;</span>
<span class="p">];</span></pre></div></td></tr><tr id="section-294"><td class="docs"><div class="pilwrap"><a href="#section-294" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Currently only WebKit-based Web Inspectors, Firefox >= v31,<br />and the Firebug extension (any Firefox version) are known<br />to support "%c" CSS customizations.</p></div><div class="body"><p>TODO: add a <code>localStorage</code> variable to explicitly enable/disable colors</p></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">useColors</span><span class="p">()</span> <span class="p">{</span></pre></div></td></tr><tr id="section-295"><td class="docs"><div class="pilwrap"><a href="#section-295" class="pilcrow">&#182;</a></div><p>is webkit? http://stackoverflow.com/a/16459606/376773</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;WebkitAppearance&#39;</span> <span class="k">in</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">.</span><span class="nx">style</span><span class="p">)</span> <span class="o">||</span></pre></div></td></tr><tr id="section-296"><td class="docs"><div class="pilwrap"><a href="#section-296" class="pilcrow">&#182;</a></div><p>is firebug? http://stackoverflow.com/a/398120/376773</p>
</td><td class="code"><div class="highlight"><pre>    <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">console</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">firebug</span> <span class="o">||</span> <span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">exception</span> <span class="o">&amp;&amp;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">table</span><span class="p">)))</span> <span class="o">||</span></pre></div></td></tr><tr id="section-297"><td class="docs"><div class="pilwrap"><a href="#section-297" class="pilcrow">&#182;</a></div><p>is firefox >= v31?
https://developer.mozilla.org/en-US/docs/Tools/Web<em>Console#Styling</em>messages</p>
</td><td class="code"><div class="highlight"><pre>    <span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">().</span><span class="nx">match</span><span class="p">(</span><span class="sr">/firefox\/(\d+)/</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nb">RegExp</span><span class="p">.</span><span class="nx">$1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">31</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-298"><td class="docs"><div class="pilwrap"><a href="#section-298" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Map %j to <code>JSON.stringify()</code>, since no Web Inspectors do that by default.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">formatters</span><span class="p">.</span><span class="nx">j</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-299"><td class="docs"><div class="pilwrap"><a href="#section-299" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Colorize log arguments if enabled.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">formatArgs</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">useColors</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">useColors</span><span class="p">;</span>

  <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">useColors</span> <span class="o">?</span> <span class="s1">&#39;%c&#39;</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">namespace</span>
    <span class="o">+</span> <span class="p">(</span><span class="nx">useColors</span> <span class="o">?</span> <span class="s1">&#39; %c&#39;</span> <span class="o">:</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="o">+</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="o">+</span> <span class="p">(</span><span class="nx">useColors</span> <span class="o">?</span> <span class="s1">&#39;%c &#39;</span> <span class="o">:</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="o">+</span> <span class="s1">&#39;+&#39;</span> <span class="o">+</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">humanize</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">diff</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">useColors</span><span class="p">)</span> <span class="k">return</span> <span class="nx">args</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="s1">&#39;color: &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">color</span><span class="p">;</span>
  <span class="nx">args</span> <span class="o">=</span> <span class="p">[</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">c</span><span class="p">,</span> <span class="s1">&#39;color: inherit&#39;</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span></pre></div></td></tr><tr id="section-300"><td class="docs"><div class="pilwrap"><a href="#section-300" class="pilcrow">&#182;</a></div><p>the final "%c" is somewhat tricky, because there could be other
arguments passed either before or after the %c, so we need to
figure out the correct index to insert the CSS into</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">lastC</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/%[a-z%]/g</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">match</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;%&#39;</span> <span class="o">===</span> <span class="nx">match</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="nx">index</span><span class="o">++</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;%c&#39;</span> <span class="o">===</span> <span class="nx">match</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-301"><td class="docs"><div class="pilwrap"><a href="#section-301" class="pilcrow">&#182;</a></div><p>we only are interested in the <em>last</em> %c
(the user may have provided their own)</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">lastC</span> <span class="o">=</span> <span class="nx">index</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="nx">args</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">lastC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">c</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">args</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-302"><td class="docs"><div class="pilwrap"><a href="#section-302" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Invokes <code>console.log()</code> when available.<br />No-op when <code>console.log</code> is not a "function".</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">log</span><span class="p">()</span> <span class="p">{</span></pre></div></td></tr><tr id="section-303"><td class="docs"><div class="pilwrap"><a href="#section-303" class="pilcrow">&#182;</a></div><p>This hackery is required for IE8,
where the <code>console.log</code> function doesn't have 'apply'</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">return</span> <span class="s1">&#39;object&#39;</span> <span class="o">==</span> <span class="k">typeof</span> <span class="nx">console</span>
    <span class="o">&amp;&amp;</span> <span class="s1">&#39;function&#39;</span> <span class="o">==</span> <span class="k">typeof</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span>
    <span class="o">&amp;&amp;</span> <span class="nb">Function</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">apply</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">,</span> <span class="nx">console</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-304"><td class="docs"><div class="pilwrap"><a href="#section-304" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Save <code>namespaces</code>.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>namespaces </span><span class="dox_type">String</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">save</span><span class="p">(</span><span class="nx">namespaces</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">==</span> <span class="nx">namespaces</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">localStorage</span><span class="p">.</span><span class="nx">removeItem</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">localStorage</span><span class="p">.</span><span class="nx">debug</span> <span class="o">=</span> <span class="nx">namespaces</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-305"><td class="docs"><div class="pilwrap"><a href="#section-305" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Load <code>namespaces</code>.</p></div><div class="details"><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">String</span><span>returns the previously persisted debug modes</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">load</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">r</span><span class="p">;</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="nx">r</span> <span class="o">=</span> <span class="nx">localStorage</span><span class="p">.</span><span class="nx">debug</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{}</span>
  <span class="k">return</span> <span class="nx">r</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-306"><td class="docs"><div class="pilwrap"><a href="#section-306" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Enable namespaces listed in <code>localStorage.debug</code> initially.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">enable</span><span class="p">(</span><span class="nx">load</span><span class="p">());</span>

<span class="p">},{</span><span class="s2">&quot;./debug&quot;</span><span class="o">:</span><span class="mi">23</span><span class="p">}],</span><span class="mi">23</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span></pre></div></td></tr><tr id="section-307"><td class="docs"><div class="pilwrap"><a href="#section-307" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>This is the common logic for both the Node.js and web browser<br />implementations of <code>debug()</code>.</p></div><div class="body"><p>Expose <code>debug()</code> as the module.</p></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">exports</span> <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">debug</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">coerce</span> <span class="o">=</span> <span class="nx">coerce</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">disable</span> <span class="o">=</span> <span class="nx">disable</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">enable</span> <span class="o">=</span> <span class="nx">enable</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">enabled</span> <span class="o">=</span> <span class="nx">enabled</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">humanize</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;ms&#39;</span><span class="p">);</span></pre></div></td></tr><tr id="section-308"><td class="docs"><div class="pilwrap"><a href="#section-308" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>The currently active debug mode names, and names to skip.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">names</span> <span class="o">=</span> <span class="p">[];</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">skips</span> <span class="o">=</span> <span class="p">[];</span></pre></div></td></tr><tr id="section-309"><td class="docs"><div class="pilwrap"><a href="#section-309" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Map of special "%n" handling functions, for the debug "format" argument.</p></div><div class="body"><p>Valid key names are a single, lowercased letter, i.e. "n".</p></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">formatters</span> <span class="o">=</span> <span class="p">{};</span></pre></div></td></tr><tr id="section-310"><td class="docs"><div class="pilwrap"><a href="#section-310" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Previously assigned color.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">prevColor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr><tr id="section-311"><td class="docs"><div class="pilwrap"><a href="#section-311" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Previous log timestamp.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">prevTime</span><span class="p">;</span></pre></div></td></tr><tr id="section-312"><td class="docs"><div class="pilwrap"><a href="#section-312" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Select a color.</p></div><div class="details"><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Number</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">selectColor</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">colors</span><span class="p">[</span><span class="nx">prevColor</span><span class="o">++</span> <span class="o">%</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">colors</span><span class="p">.</span><span class="nx">length</span><span class="p">];</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-313"><td class="docs"><div class="pilwrap"><a href="#section-313" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Create a debugger with the given <code>namespace</code>.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>namespace </span><span class="dox_type">String</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Function</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">debug</span><span class="p">(</span><span class="nx">namespace</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-314"><td class="docs"><div class="pilwrap"><a href="#section-314" class="pilcrow">&#182;</a></div><p>define the <code>disabled</code> version</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">disabled</span><span class="p">()</span> <span class="p">{</span>
  <span class="p">}</span>
  <span class="nx">disabled</span><span class="p">.</span><span class="nx">enabled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></pre></div></td></tr><tr id="section-315"><td class="docs"><div class="pilwrap"><a href="#section-315" class="pilcrow">&#182;</a></div><p>define the <code>enabled</code> version</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">enabled</span><span class="p">()</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="nx">enabled</span><span class="p">;</span></pre></div></td></tr><tr id="section-316"><td class="docs"><div class="pilwrap"><a href="#section-316" class="pilcrow">&#182;</a></div><p>set <code>diff</code> timestamp</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">curr</span> <span class="o">=</span> <span class="o">+</span><span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">ms</span> <span class="o">=</span> <span class="nx">curr</span> <span class="o">-</span> <span class="p">(</span><span class="nx">prevTime</span> <span class="o">||</span> <span class="nx">curr</span><span class="p">);</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">diff</span> <span class="o">=</span> <span class="nx">ms</span><span class="p">;</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">prev</span> <span class="o">=</span> <span class="nx">prevTime</span><span class="p">;</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">curr</span> <span class="o">=</span> <span class="nx">curr</span><span class="p">;</span>
    <span class="nx">prevTime</span> <span class="o">=</span> <span class="nx">curr</span><span class="p">;</span></pre></div></td></tr><tr id="section-317"><td class="docs"><div class="pilwrap"><a href="#section-317" class="pilcrow">&#182;</a></div><p>add the <code>color</code> if not set</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">==</span> <span class="nx">self</span><span class="p">.</span><span class="nx">useColors</span><span class="p">)</span> <span class="nx">self</span><span class="p">.</span><span class="nx">useColors</span> <span class="o">=</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">useColors</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">==</span> <span class="nx">self</span><span class="p">.</span><span class="nx">color</span> <span class="o">&amp;&amp;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">useColors</span><span class="p">)</span> <span class="nx">self</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="nx">selectColor</span><span class="p">();</span>

    <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>

    <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">coerce</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span></pre></div></td></tr><tr id="section-318"><td class="docs"><div class="pilwrap"><a href="#section-318" class="pilcrow">&#182;</a></div><p>anything else let's inspect with %o</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">args</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;%o&#39;</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-319"><td class="docs"><div class="pilwrap"><a href="#section-319" class="pilcrow">&#182;</a></div><p>apply any <code>formatters</code> transformations</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/%([a-z%])/g</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">format</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-320"><td class="docs"><div class="pilwrap"><a href="#section-320" class="pilcrow">&#182;</a></div><p>if we encounter an escaped % then don't increase the array index</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">match</span> <span class="o">===</span> <span class="s1">&#39;%&#39;</span><span class="p">)</span> <span class="k">return</span> <span class="nx">match</span><span class="p">;</span>
      <span class="nx">index</span><span class="o">++</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">formatter</span> <span class="o">=</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">formatters</span><span class="p">[</span><span class="nx">format</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;function&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">formatter</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="nx">index</span><span class="p">];</span>
        <span class="nx">match</span> <span class="o">=</span> <span class="nx">formatter</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">val</span><span class="p">);</span></pre></div></td></tr><tr id="section-321"><td class="docs"><div class="pilwrap"><a href="#section-321" class="pilcrow">&#182;</a></div><p>now we need to remove <code>args[index]</code> since it's inlined in the <code>format</code></p>
</td><td class="code"><div class="highlight"><pre>        <span class="nx">args</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="nx">index</span><span class="o">--</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">match</span><span class="p">;</span>
    <span class="p">});</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;function&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">formatArgs</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">args</span> <span class="o">=</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">formatArgs</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">logFn</span> <span class="o">=</span> <span class="nx">enabled</span><span class="p">.</span><span class="nx">log</span> <span class="o">||</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">log</span> <span class="o">||</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">console</span><span class="p">);</span>
    <span class="nx">logFn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">enabled</span><span class="p">.</span><span class="nx">enabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">fn</span> <span class="o">=</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">enabled</span><span class="p">(</span><span class="nx">namespace</span><span class="p">)</span> <span class="o">?</span> <span class="nx">enabled</span> <span class="o">:</span> <span class="nx">disabled</span><span class="p">;</span>

  <span class="nx">fn</span><span class="p">.</span><span class="nx">namespace</span> <span class="o">=</span> <span class="nx">namespace</span><span class="p">;</span>

  <span class="k">return</span> <span class="nx">fn</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-322"><td class="docs"><div class="pilwrap"><a href="#section-322" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Enables a debug mode by namespaces. This can include modes<br />separated by a colon and wildcards.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>namespaces </span><span class="dox_type">String</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">enable</span><span class="p">(</span><span class="nx">namespaces</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">exports</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">namespaces</span><span class="p">);</span>

  <span class="kd">var</span> <span class="nx">split</span> <span class="o">=</span> <span class="p">(</span><span class="nx">namespaces</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="sr">/[\s,]+/</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">split</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">split</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="k">continue</span><span class="p">;</span> <span class="c1">// ignore empty strings</span>
    <span class="nx">namespaces</span> <span class="o">=</span> <span class="nx">split</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\*/g</span><span class="p">,</span> <span class="s1">&#39;.*?&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">namespaces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">exports</span><span class="p">.</span><span class="nx">skips</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s1">&#39;^&#39;</span> <span class="o">+</span> <span class="nx">namespaces</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;$&#39;</span><span class="p">));</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">exports</span><span class="p">.</span><span class="nx">names</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s1">&#39;^&#39;</span> <span class="o">+</span> <span class="nx">namespaces</span> <span class="o">+</span> <span class="s1">&#39;$&#39;</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-323"><td class="docs"><div class="pilwrap"><a href="#section-323" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Disable debug output.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">disable</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">exports</span><span class="p">.</span><span class="nx">enable</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-324"><td class="docs"><div class="pilwrap"><a href="#section-324" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Returns true if the given mode name is enabled, false otherwise.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>name </span><span class="dox_type">String</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Boolean</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">enabled</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">len</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">skips</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">exports</span><span class="p">.</span><span class="nx">skips</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">test</span><span class="p">(</span><span class="nx">name</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">names</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">exports</span><span class="p">.</span><span class="nx">names</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">test</span><span class="p">(</span><span class="nx">name</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-325"><td class="docs"><div class="pilwrap"><a href="#section-325" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Coerce <code>val</code>.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>val </span><span class="dox_type">Mixed</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Mixed</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">coerce</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">val</span> <span class="k">instanceof</span> <span class="nb">Error</span><span class="p">)</span> <span class="k">return</span> <span class="nx">val</span><span class="p">.</span><span class="nx">stack</span> <span class="o">||</span> <span class="nx">val</span><span class="p">.</span><span class="nx">message</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">},{</span><span class="s2">&quot;ms&quot;</span><span class="o">:</span><span class="mi">24</span><span class="p">}],</span><span class="mi">24</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span></pre></div></td></tr><tr id="section-326"><td class="docs"><div class="pilwrap"><a href="#section-326" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Helpers.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">s</span> <span class="o">*</span> <span class="mi">60</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">h</span> <span class="o">=</span> <span class="nx">m</span> <span class="o">*</span> <span class="mi">60</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">h</span> <span class="o">*</span> <span class="mi">24</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">d</span> <span class="o">*</span> <span class="mf">365.25</span><span class="p">;</span></pre></div></td></tr><tr id="section-327"><td class="docs"><div class="pilwrap"><a href="#section-327" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Parse or format the given <code>val</code>.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>val </span><span class="dox_type">String</span><span class="dox_type">Number</span></div><div class="dox_tag_detail"><span>options </span><span class="dox_type">Object</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">String</span><span class="dox_type">Number</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"><h2>Options</h2>

<ul>
<li><code>long</code> verbose formatting [false]</li>
</ul></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="nx">options</span><span class="p">){</span>
  <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">==</span> <span class="k">typeof</span> <span class="nx">val</span><span class="p">)</span> <span class="k">return</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">val</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">options</span><span class="p">.</span><span class="kr">long</span>
    <span class="o">?</span> <span class="kr">long</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span>
    <span class="o">:</span> <span class="kr">short</span><span class="p">(</span><span class="nx">val</span><span class="p">);</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-328"><td class="docs"><div class="pilwrap"><a href="#section-328" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Parse the given <code>str</code> and return milliseconds.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>str </span><span class="dox_type">String</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Number</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">match</span> <span class="o">=</span> <span class="sr">/^((?:\d+)?\.?\d+) *(ms|seconds?|s|minutes?|m|hours?|h|days?|d|years?|y)?$/i</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">str</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">match</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">||</span> <span class="s1">&#39;ms&#39;</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">();</span>
  <span class="k">switch</span> <span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="s1">&#39;years&#39;</span><span class="o">:</span>
    <span class="k">case</span> <span class="s1">&#39;year&#39;</span><span class="o">:</span>
    <span class="k">case</span> <span class="s1">&#39;y&#39;</span><span class="o">:</span>
      <span class="k">return</span> <span class="nx">n</span> <span class="o">*</span> <span class="nx">y</span><span class="p">;</span>
    <span class="k">case</span> <span class="s1">&#39;days&#39;</span><span class="o">:</span>
    <span class="k">case</span> <span class="s1">&#39;day&#39;</span><span class="o">:</span>
    <span class="k">case</span> <span class="s1">&#39;d&#39;</span><span class="o">:</span>
      <span class="k">return</span> <span class="nx">n</span> <span class="o">*</span> <span class="nx">d</span><span class="p">;</span>
    <span class="k">case</span> <span class="s1">&#39;hours&#39;</span><span class="o">:</span>
    <span class="k">case</span> <span class="s1">&#39;hour&#39;</span><span class="o">:</span>
    <span class="k">case</span> <span class="s1">&#39;h&#39;</span><span class="o">:</span>
      <span class="k">return</span> <span class="nx">n</span> <span class="o">*</span> <span class="nx">h</span><span class="p">;</span>
    <span class="k">case</span> <span class="s1">&#39;minutes&#39;</span><span class="o">:</span>
    <span class="k">case</span> <span class="s1">&#39;minute&#39;</span><span class="o">:</span>
    <span class="k">case</span> <span class="s1">&#39;m&#39;</span><span class="o">:</span>
      <span class="k">return</span> <span class="nx">n</span> <span class="o">*</span> <span class="nx">m</span><span class="p">;</span>
    <span class="k">case</span> <span class="s1">&#39;seconds&#39;</span><span class="o">:</span>
    <span class="k">case</span> <span class="s1">&#39;second&#39;</span><span class="o">:</span>
    <span class="k">case</span> <span class="s1">&#39;s&#39;</span><span class="o">:</span>
      <span class="k">return</span> <span class="nx">n</span> <span class="o">*</span> <span class="nx">s</span><span class="p">;</span>
    <span class="k">case</span> <span class="s1">&#39;ms&#39;</span><span class="o">:</span>
      <span class="k">return</span> <span class="nx">n</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-329"><td class="docs"><div class="pilwrap"><a href="#section-329" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Short format for <code>ms</code>.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>ms </span><span class="dox_type">Number</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">String</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="kr">short</span><span class="p">(</span><span class="nx">ms</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">ms</span> <span class="o">&gt;=</span> <span class="nx">d</span><span class="p">)</span> <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">ms</span> <span class="o">/</span> <span class="nx">d</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;d&#39;</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">ms</span> <span class="o">&gt;=</span> <span class="nx">h</span><span class="p">)</span> <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">ms</span> <span class="o">/</span> <span class="nx">h</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;h&#39;</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">ms</span> <span class="o">&gt;=</span> <span class="nx">m</span><span class="p">)</span> <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">ms</span> <span class="o">/</span> <span class="nx">m</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;m&#39;</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">ms</span> <span class="o">&gt;=</span> <span class="nx">s</span><span class="p">)</span> <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">ms</span> <span class="o">/</span> <span class="nx">s</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;s&#39;</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">ms</span> <span class="o">+</span> <span class="s1">&#39;ms&#39;</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-330"><td class="docs"><div class="pilwrap"><a href="#section-330" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Long format for <code>ms</code>.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>ms </span><span class="dox_type">Number</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">String</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="kr">long</span><span class="p">(</span><span class="nx">ms</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">plural</span><span class="p">(</span><span class="nx">ms</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">)</span>
    <span class="o">||</span> <span class="nx">plural</span><span class="p">(</span><span class="nx">ms</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="s1">&#39;hour&#39;</span><span class="p">)</span>
    <span class="o">||</span> <span class="nx">plural</span><span class="p">(</span><span class="nx">ms</span><span class="p">,</span> <span class="nx">m</span><span class="p">,</span> <span class="s1">&#39;minute&#39;</span><span class="p">)</span>
    <span class="o">||</span> <span class="nx">plural</span><span class="p">(</span><span class="nx">ms</span><span class="p">,</span> <span class="nx">s</span><span class="p">,</span> <span class="s1">&#39;second&#39;</span><span class="p">)</span>
    <span class="o">||</span> <span class="nx">ms</span> <span class="o">+</span> <span class="s1">&#39; ms&#39;</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-331"><td class="docs"><div class="pilwrap"><a href="#section-331" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Pluralization helper.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">plural</span><span class="p">(</span><span class="nx">ms</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">ms</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">ms</span> <span class="o">&lt;</span> <span class="nx">n</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">)</span> <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">ms</span> <span class="o">/</span> <span class="nx">n</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nx">name</span><span class="p">;</span>
  <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">ms</span> <span class="o">/</span> <span class="nx">n</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;s&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">},{}],</span><span class="mi">25</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span>
<span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">global</span><span class="p">){</span></pre></div></td></tr><tr id="section-332"><td class="docs"><div class="pilwrap"><a href="#section-332" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Module dependencies.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;./keys&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">hasBinary</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;has-binary&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">sliceBuffer</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;arraybuffer.slice&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">base64encoder</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;base64-arraybuffer&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">after</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;after&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">utf8</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">);</span></pre></div></td></tr><tr id="section-333"><td class="docs"><div class="pilwrap"><a href="#section-333" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Check if we are running an android browser. That requires us to use<br />ArrayBuffer with polling transports...</p></div><div class="body"><p><a href='http://ghinda.net/jpeg-blob-ajax-android/'>http://ghinda.net/jpeg-blob-ajax-android/</a></p></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">isAndroid</span> <span class="o">=</span> <span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/Android/i</span><span class="p">);</span></pre></div></td></tr><tr id="section-334"><td class="docs"><div class="pilwrap"><a href="#section-334" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Check if we are running in PhantomJS.<br />Uploading a Blob with PhantomJS does not work correctly, as reported here:<br /><a href='https://github.com/ariya/phantomjs/issues/11395'>https://github.com/ariya/phantomjs/issues/11395</a></p></div><div class="details"><div class="dox_tag_title">Type</div><div class="dox_tag_detail"><span class="dox_type">boolean</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">isPhantomJS</span> <span class="o">=</span> <span class="sr">/PhantomJS/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">);</span></pre></div></td></tr><tr id="section-335"><td class="docs"><div class="pilwrap"><a href="#section-335" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>When true, avoids using Blobs to encode payloads.</p></div><div class="details"><div class="dox_tag_title">Type</div><div class="dox_tag_detail"><span class="dox_type">boolean</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">dontSendBlobs</span> <span class="o">=</span> <span class="nx">isAndroid</span> <span class="o">||</span> <span class="nx">isPhantomJS</span><span class="p">;</span></pre></div></td></tr><tr id="section-336"><td class="docs"><div class="pilwrap"><a href="#section-336" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Current protocol version.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span></pre></div></td></tr><tr id="section-337"><td class="docs"><div class="pilwrap"><a href="#section-337" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Packet types.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">packets</span> <span class="o">=</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">packets</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">open</span><span class="o">:</span>     <span class="mi">0</span>    <span class="c1">// non-ws</span>
  <span class="p">,</span> <span class="nx">close</span><span class="o">:</span>    <span class="mi">1</span>    <span class="c1">// non-ws</span>
  <span class="p">,</span> <span class="nx">ping</span><span class="o">:</span>     <span class="mi">2</span>
  <span class="p">,</span> <span class="nx">pong</span><span class="o">:</span>     <span class="mi">3</span>
  <span class="p">,</span> <span class="nx">message</span><span class="o">:</span>  <span class="mi">4</span>
  <span class="p">,</span> <span class="nx">upgrade</span><span class="o">:</span>  <span class="mi">5</span>
  <span class="p">,</span> <span class="nx">noop</span><span class="o">:</span>     <span class="mi">6</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">packetslist</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">(</span><span class="nx">packets</span><span class="p">);</span></pre></div></td></tr><tr id="section-338"><td class="docs"><div class="pilwrap"><a href="#section-338" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Premade error packet.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">err</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="o">:</span> <span class="s1">&#39;parser error&#39;</span> <span class="p">};</span></pre></div></td></tr><tr id="section-339"><td class="docs"><div class="pilwrap"><a href="#section-339" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Create a blob api even for blob builder when vendor prefixes exist</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">Blob</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;blob&#39;</span><span class="p">);</span></pre></div></td></tr><tr id="section-340"><td class="docs"><div class="pilwrap"><a href="#section-340" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Encodes a packet.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"><pre><code>&lt;packet type id&gt; [ &lt;data&gt; ]
</code></pre>

<h2>Example</h2>

<pre><code>5hello world
3
4
</code></pre>

<p>Binary is encoded in an identical principle</p></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">encodePacket</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">packet</span><span class="p">,</span> <span class="nx">supportsBinary</span><span class="p">,</span> <span class="nx">utf8encode</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;function&#39;</span> <span class="o">==</span> <span class="k">typeof</span> <span class="nx">supportsBinary</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">callback</span> <span class="o">=</span> <span class="nx">supportsBinary</span><span class="p">;</span>
    <span class="nx">supportsBinary</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;function&#39;</span> <span class="o">==</span> <span class="k">typeof</span> <span class="nx">utf8encode</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">callback</span> <span class="o">=</span> <span class="nx">utf8encode</span><span class="p">;</span>
    <span class="nx">utf8encode</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">(</span><span class="nx">packet</span><span class="p">.</span><span class="nx">data</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span>
    <span class="o">?</span> <span class="kc">undefined</span>
    <span class="o">:</span> <span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">buffer</span> <span class="o">||</span> <span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">ArrayBuffer</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span> <span class="k">instanceof</span> <span class="nx">ArrayBuffer</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">encodeArrayBuffer</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span> <span class="nx">supportsBinary</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">Blob</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span> <span class="k">instanceof</span> <span class="nx">global</span><span class="p">.</span><span class="nx">Blob</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">encodeBlob</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span> <span class="nx">supportsBinary</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-341"><td class="docs"><div class="pilwrap"><a href="#section-341" class="pilcrow">&#182;</a></div><p>might be an object with { base64: true, data: dataAsBase64String }</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">data</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">base64</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">encodeBase64Object</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-342"><td class="docs"><div class="pilwrap"><a href="#section-342" class="pilcrow">&#182;</a></div><p>Sending data as a utf-8 string</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">encoded</span> <span class="o">=</span> <span class="nx">packets</span><span class="p">[</span><span class="nx">packet</span><span class="p">.</span><span class="nx">type</span><span class="p">];</span></pre></div></td></tr><tr id="section-343"><td class="docs"><div class="pilwrap"><a href="#section-343" class="pilcrow">&#182;</a></div><p>data fragment is optional</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="kc">undefined</span> <span class="o">!==</span> <span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">encoded</span> <span class="o">+=</span> <span class="nx">utf8encode</span> <span class="o">?</span> <span class="nx">utf8</span><span class="p">.</span><span class="nx">encode</span><span class="p">(</span><span class="nb">String</span><span class="p">(</span><span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">))</span> <span class="o">:</span> <span class="nb">String</span><span class="p">(</span><span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="s1">&#39;&#39;</span> <span class="o">+</span> <span class="nx">encoded</span><span class="p">);</span>

<span class="p">};</span>

<span class="kd">function</span> <span class="nx">encodeBase64Object</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-344"><td class="docs"><div class="pilwrap"><a href="#section-344" class="pilcrow">&#182;</a></div><p>packet data is an object { base64: true, data: dataAsBase64String }</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span> <span class="o">+</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">packets</span><span class="p">[</span><span class="nx">packet</span><span class="p">.</span><span class="nx">type</span><span class="p">]</span> <span class="o">+</span> <span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-345"><td class="docs"><div class="pilwrap"><a href="#section-345" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Encode packet helpers for binary types</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">encodeArrayBuffer</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span> <span class="nx">supportsBinary</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">supportsBinary</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">encodeBase64Packet</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">contentArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">resultBuffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="nx">data</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">);</span>

  <span class="nx">resultBuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">packets</span><span class="p">[</span><span class="nx">packet</span><span class="p">.</span><span class="nx">type</span><span class="p">];</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">contentArray</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">resultBuffer</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">contentArray</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">resultBuffer</span><span class="p">.</span><span class="nx">buffer</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">encodeBlobAsArrayBuffer</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span> <span class="nx">supportsBinary</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">supportsBinary</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">encodeBase64Packet</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">fr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FileReader</span><span class="p">();</span>
  <span class="nx">fr</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">packet</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">fr</span><span class="p">.</span><span class="nx">result</span><span class="p">;</span>
    <span class="nx">exports</span><span class="p">.</span><span class="nx">encodePacket</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span> <span class="nx">supportsBinary</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="k">return</span> <span class="nx">fr</span><span class="p">.</span><span class="nx">readAsArrayBuffer</span><span class="p">(</span><span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">encodeBlob</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span> <span class="nx">supportsBinary</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">supportsBinary</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">encodeBase64Packet</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">dontSendBlobs</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">encodeBlobAsArrayBuffer</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span> <span class="nx">supportsBinary</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">length</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="nx">length</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">packets</span><span class="p">[</span><span class="nx">packet</span><span class="p">.</span><span class="nx">type</span><span class="p">];</span>
  <span class="kd">var</span> <span class="nx">blob</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blob</span><span class="p">([</span><span class="nx">length</span><span class="p">.</span><span class="nx">buffer</span><span class="p">,</span> <span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">]);</span>

  <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">blob</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-346"><td class="docs"><div class="pilwrap"><a href="#section-346" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Encodes a packet with binary data in a base64 string</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>packet, </span><span class="dox_type">Object</span><span>- has `type` and `data`</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">String</span><span>base64 encoded message</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">encodeBase64Packet</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span> <span class="o">+</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">packets</span><span class="p">[</span><span class="nx">packet</span><span class="p">.</span><span class="nx">type</span><span class="p">];</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">Blob</span> <span class="o">&amp;&amp;</span> <span class="nx">packet</span><span class="p">.</span><span class="nx">data</span> <span class="k">instanceof</span> <span class="nx">Blob</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">fr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FileReader</span><span class="p">();</span>
    <span class="nx">fr</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">b64</span> <span class="o">=</span> <span class="nx">fr</span><span class="p">.</span><span class="nx">result</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
      <span class="nx">callback</span><span class="p">(</span><span class="nx">message</span> <span class="o">+</span> <span class="nx">b64</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="k">return</span> <span class="nx">fr</span><span class="p">.</span><span class="nx">readAsDataURL</span><span class="p">(</span><span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">b64data</span><span class="p">;</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="nx">b64data</span> <span class="o">=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">));</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-347"><td class="docs"><div class="pilwrap"><a href="#section-347" class="pilcrow">&#182;</a></div><p>iPhone Safari doesn't let you apply with typed arrays</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">typed</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">basic</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">typed</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">typed</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">basic</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">typed</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="nx">b64data</span> <span class="o">=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">basic</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">message</span> <span class="o">+=</span> <span class="nx">global</span><span class="p">.</span><span class="nx">btoa</span><span class="p">(</span><span class="nx">b64data</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-348"><td class="docs"><div class="pilwrap"><a href="#section-348" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Decodes a packet. Changes format to Blob if requested.</p></div><div class="details"><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Object</span><span>with `type` and `data` (if any)</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">decodePacket</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">binaryType</span><span class="p">,</span> <span class="nx">utf8decode</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-349"><td class="docs"><div class="pilwrap"><a href="#section-349" class="pilcrow">&#182;</a></div><p>String data</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">data</span> <span class="o">==</span> <span class="s1">&#39;string&#39;</span> <span class="o">||</span> <span class="nx">data</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">decodeBase64Packet</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="nx">binaryType</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">utf8decode</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="nx">data</span> <span class="o">=</span> <span class="nx">utf8</span><span class="p">.</span><span class="nx">decode</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">Number</span><span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="o">!=</span> <span class="nx">type</span> <span class="o">||</span> <span class="o">!</span><span class="nx">packetslist</span><span class="p">[</span><span class="nx">type</span><span class="p">])</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">err</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">packetslist</span><span class="p">[</span><span class="nx">type</span><span class="p">],</span> <span class="nx">data</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">};</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">packetslist</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span> <span class="p">};</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">asArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">asArray</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="kd">var</span> <span class="nx">rest</span> <span class="o">=</span> <span class="nx">sliceBuffer</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">Blob</span> <span class="o">&amp;&amp;</span> <span class="nx">binaryType</span> <span class="o">===</span> <span class="s1">&#39;blob&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">rest</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blob</span><span class="p">([</span><span class="nx">rest</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">packetslist</span><span class="p">[</span><span class="nx">type</span><span class="p">],</span> <span class="nx">data</span><span class="o">:</span> <span class="nx">rest</span> <span class="p">};</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-350"><td class="docs"><div class="pilwrap"><a href="#section-350" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Decodes a packet encoded in a base64 string</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>base64 </span><span class="dox_type">String</span><span>- encoded message</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Object</span><span>with `type` and `data` (if any)</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">decodeBase64Packet</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">binaryType</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">packetslist</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)];</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">global</span><span class="p">.</span><span class="nx">ArrayBuffer</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">data</span><span class="o">:</span> <span class="p">{</span> <span class="nx">base64</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">data</span><span class="o">:</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">}</span> <span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">base64encoder</span><span class="p">.</span><span class="nx">decode</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">binaryType</span> <span class="o">===</span> <span class="s1">&#39;blob&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">Blob</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">data</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blob</span><span class="p">([</span><span class="nx">data</span><span class="p">]);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">data</span><span class="o">:</span> <span class="nx">data</span> <span class="p">};</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-351"><td class="docs"><div class="pilwrap"><a href="#section-351" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Encodes multiple messages (payload).</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>packets </span><span class="dox_type">Array</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"><pre><code>&lt;length&gt;:data
</code></pre>

<h2>Example</h2>

<pre><code>11:hello world2:hi
</code></pre>

<p>If any contents are binary, they will be encoded as base64 strings. Base64<br />encoded strings are marked with a b before the length specifier</p></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">encodePayload</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">packets</span><span class="p">,</span> <span class="nx">supportsBinary</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">supportsBinary</span> <span class="o">==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">callback</span> <span class="o">=</span> <span class="nx">supportsBinary</span><span class="p">;</span>
    <span class="nx">supportsBinary</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">isBinary</span> <span class="o">=</span> <span class="nx">hasBinary</span><span class="p">(</span><span class="nx">packets</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">supportsBinary</span> <span class="o">&amp;&amp;</span> <span class="nx">isBinary</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">Blob</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">dontSendBlobs</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">encodePayloadAsBlob</span><span class="p">(</span><span class="nx">packets</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">encodePayloadAsArrayBuffer</span><span class="p">(</span><span class="nx">packets</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">packets</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="s1">&#39;0:&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">setLengthHeader</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">message</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">message</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">encodeOne</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span> <span class="nx">doneCallback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">exports</span><span class="p">.</span><span class="nx">encodePacket</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span> <span class="o">!</span><span class="nx">isBinary</span> <span class="o">?</span> <span class="kc">false</span> <span class="o">:</span> <span class="nx">supportsBinary</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">doneCallback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">setLengthHeader</span><span class="p">(</span><span class="nx">message</span><span class="p">));</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="nx">map</span><span class="p">(</span><span class="nx">packets</span><span class="p">,</span> <span class="nx">encodeOne</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">results</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">));</span>
  <span class="p">});</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-352"><td class="docs"><div class="pilwrap"><a href="#section-352" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Async array map using after</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">map</span><span class="p">(</span><span class="nx">ary</span><span class="p">,</span> <span class="nx">each</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">ary</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">next</span> <span class="o">=</span> <span class="nx">after</span><span class="p">(</span><span class="nx">ary</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>

  <span class="kd">var</span> <span class="nx">eachWithIndex</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">el</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">each</span><span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">result</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">;</span>
      <span class="nx">cb</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">result</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">};</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">ary</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">eachWithIndex</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">ary</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">next</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-353"><td class="docs"><div class="pilwrap"><a href="#section-353" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Decodes data when a payload is maybe expected. Possible binary contents are<br />decoded from their base64 representation</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>data, </span><span class="dox_type">String</span><span>- callback method</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">decodePayload</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">binaryType</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">data</span> <span class="o">!=</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">decodePayloadAsBinary</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">binaryType</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">binaryType</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">callback</span> <span class="o">=</span> <span class="nx">binaryType</span><span class="p">;</span>
    <span class="nx">binaryType</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">packet</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">data</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-354"><td class="docs"><div class="pilwrap"><a href="#section-354" class="pilcrow">&#182;</a></div><p>parser error - ignoring payload</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">length</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">msg</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">chr</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;:&#39;</span> <span class="o">!=</span> <span class="nx">chr</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">length</span> <span class="o">+=</span> <span class="nx">chr</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;&#39;</span> <span class="o">==</span> <span class="nx">length</span> <span class="o">||</span> <span class="p">(</span><span class="nx">length</span> <span class="o">!=</span> <span class="p">(</span><span class="nx">n</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">length</span><span class="p">))))</span> <span class="p">{</span></pre></div></td></tr><tr id="section-355"><td class="docs"><div class="pilwrap"><a href="#section-355" class="pilcrow">&#182;</a></div><p>parser error - ignoring payload</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="nx">msg</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">n</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">length</span> <span class="o">!=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-356"><td class="docs"><div class="pilwrap"><a href="#section-356" class="pilcrow">&#182;</a></div><p>parser error - ignoring payload</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">packet</span> <span class="o">=</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">decodePacket</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">binaryType</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="nx">packet</span><span class="p">.</span><span class="nx">type</span> <span class="o">&amp;&amp;</span> <span class="nx">err</span><span class="p">.</span><span class="nx">data</span> <span class="o">==</span> <span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-357"><td class="docs"><div class="pilwrap"><a href="#section-357" class="pilcrow">&#182;</a></div><p>parser error in individual packet - ignoring payload</p>
</td><td class="code"><div class="highlight"><pre>          <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span> <span class="nx">i</span> <span class="o">+</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">l</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="kc">false</span> <span class="o">===</span> <span class="nx">ret</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-358"><td class="docs"><div class="pilwrap"><a href="#section-358" class="pilcrow">&#182;</a></div><p>advance cursor</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">i</span> <span class="o">+=</span> <span class="nx">n</span><span class="p">;</span>
      <span class="nx">length</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">length</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-359"><td class="docs"><div class="pilwrap"><a href="#section-359" class="pilcrow">&#182;</a></div><p>parser error - ignoring payload</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">};</span></pre></div></td></tr><tr id="section-360"><td class="docs"><div class="pilwrap"><a href="#section-360" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Encodes multiple messages (payload) as binary.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>packets </span><span class="dox_type">Array</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">ArrayBuffer</span><span>encoded payload</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"><p>&lt;1 = binary, 0 = string><number from 0-9><number from 0-9>[...]<number<br />255><data></p>

<h2>Example</h2>

<p>1 3 255 1 2 3, if the binary contents are interpreted as 8 bit integers</p></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">encodePayloadAsArrayBuffer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">packets</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">packets</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">encodeOne</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span> <span class="nx">doneCallback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">exports</span><span class="p">.</span><span class="nx">encodePacket</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">doneCallback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="nx">map</span><span class="p">(</span><span class="nx">packets</span><span class="p">,</span> <span class="nx">encodeOne</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">encodedPackets</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">totalLength</span> <span class="o">=</span> <span class="nx">encodedPackets</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">acc</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">len</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">p</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">){</span>
        <span class="nx">len</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">len</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">acc</span> <span class="o">+</span> <span class="nx">len</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">length</span> <span class="o">+</span> <span class="nx">len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">// string/binary identifier + separator = 2</span>
    <span class="p">},</span> <span class="mi">0</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">resultArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">totalLength</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">bufferIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">encodedPackets</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">isString</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">p</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">ab</span> <span class="o">=</span> <span class="nx">p</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">isString</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">view</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">ab</span> <span class="o">=</span> <span class="nx">view</span><span class="p">.</span><span class="nx">buffer</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">isString</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// not true binary</span>
        <span class="nx">resultArray</span><span class="p">[</span><span class="nx">bufferIndex</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// true binary</span>
        <span class="nx">resultArray</span><span class="p">[</span><span class="nx">bufferIndex</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">lenStr</span> <span class="o">=</span> <span class="nx">ab</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">lenStr</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">resultArray</span><span class="p">[</span><span class="nx">bufferIndex</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">lenStr</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
      <span class="p">}</span>
      <span class="nx">resultArray</span><span class="p">[</span><span class="nx">bufferIndex</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>

      <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">ab</span><span class="p">);</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">view</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">resultArray</span><span class="p">[</span><span class="nx">bufferIndex</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">view</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="p">}</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">resultArray</span><span class="p">.</span><span class="nx">buffer</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-361"><td class="docs"><div class="pilwrap"><a href="#section-361" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Encode as Blob</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">encodePayloadAsBlob</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">packets</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">function</span> <span class="nx">encodeOne</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span> <span class="nx">doneCallback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">exports</span><span class="p">.</span><span class="nx">encodePacket</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">encoded</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">binaryIdentifier</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
      <span class="nx">binaryIdentifier</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">encoded</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">encoded</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">encoded</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">view</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">encoded</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">encoded</span> <span class="o">=</span> <span class="nx">view</span><span class="p">.</span><span class="nx">buffer</span><span class="p">;</span>
        <span class="nx">binaryIdentifier</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">len</span> <span class="o">=</span> <span class="p">(</span><span class="nx">encoded</span> <span class="k">instanceof</span> <span class="nx">ArrayBuffer</span><span class="p">)</span>
        <span class="o">?</span> <span class="nx">encoded</span><span class="p">.</span><span class="nx">byteLength</span>
        <span class="o">:</span> <span class="nx">encoded</span><span class="p">.</span><span class="nx">size</span><span class="p">;</span>

      <span class="kd">var</span> <span class="nx">lenStr</span> <span class="o">=</span> <span class="nx">len</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
      <span class="kd">var</span> <span class="nx">lengthAry</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">lenStr</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">lenStr</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">lengthAry</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">lenStr</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
      <span class="p">}</span>
      <span class="nx">lengthAry</span><span class="p">[</span><span class="nx">lenStr</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">Blob</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">blob</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blob</span><span class="p">([</span><span class="nx">binaryIdentifier</span><span class="p">.</span><span class="nx">buffer</span><span class="p">,</span> <span class="nx">lengthAry</span><span class="p">.</span><span class="nx">buffer</span><span class="p">,</span> <span class="nx">encoded</span><span class="p">]);</span>
        <span class="nx">doneCallback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">blob</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="nx">map</span><span class="p">(</span><span class="nx">packets</span><span class="p">,</span> <span class="nx">encodeOne</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nx">Blob</span><span class="p">(</span><span class="nx">results</span><span class="p">));</span>
  <span class="p">});</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-362"><td class="docs"><div class="pilwrap"><a href="#section-362" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Decodes data when a payload is maybe expected. Strings are decoded by<br />interpreting each byte as a key code for entries marked to start with 0. See<br />description of encodePayloadAsBinary</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>data, </span><span class="dox_type">ArrayBuffer</span><span>- callback method</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">decodePayloadAsBinary</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">binaryType</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">binaryType</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">callback</span> <span class="o">=</span> <span class="nx">binaryType</span><span class="p">;</span>
    <span class="nx">binaryType</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">bufferTail</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">buffers</span> <span class="o">=</span> <span class="p">[];</span>

  <span class="kd">var</span> <span class="nx">numberTooLong</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="nx">bufferTail</span><span class="p">.</span><span class="nx">byteLength</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">tailArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">bufferTail</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">isString</span> <span class="o">=</span> <span class="nx">tailArray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">msgLength</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">tailArray</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">255</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">msgLength</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">310</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">numberTooLong</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="nx">msgLength</span> <span class="o">+=</span> <span class="nx">tailArray</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">numberTooLong</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

    <span class="nx">bufferTail</span> <span class="o">=</span> <span class="nx">sliceBuffer</span><span class="p">(</span><span class="nx">bufferTail</span><span class="p">,</span> <span class="mi">2</span> <span class="o">+</span> <span class="nx">msgLength</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
    <span class="nx">msgLength</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">msgLength</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">msg</span> <span class="o">=</span> <span class="nx">sliceBuffer</span><span class="p">(</span><span class="nx">bufferTail</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">msgLength</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isString</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="nx">msg</span> <span class="o">=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">msg</span><span class="p">));</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-363"><td class="docs"><div class="pilwrap"><a href="#section-363" class="pilcrow">&#182;</a></div><p>iPhone Safari doesn't let you apply to typed arrays</p>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">typed</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
        <span class="nx">msg</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">typed</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">msg</span> <span class="o">+=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">typed</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">buffers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
    <span class="nx">bufferTail</span> <span class="o">=</span> <span class="nx">sliceBuffer</span><span class="p">(</span><span class="nx">bufferTail</span><span class="p">,</span> <span class="nx">msgLength</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">total</span> <span class="o">=</span> <span class="nx">buffers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
  <span class="nx">buffers</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">callback</span><span class="p">(</span><span class="nx">exports</span><span class="p">.</span><span class="nx">decodePacket</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="nx">binaryType</span><span class="p">,</span> <span class="kc">true</span><span class="p">),</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">total</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">};</span>

<span class="p">}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="k">typeof</span> <span class="nx">self</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span> <span class="o">?</span> <span class="nx">self</span> <span class="o">:</span> <span class="k">typeof</span> <span class="nb">window</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span> <span class="o">?</span> <span class="nb">window</span> <span class="o">:</span> <span class="p">{})</span>
<span class="p">},{</span><span class="s2">&quot;./keys&quot;</span><span class="o">:</span><span class="mi">26</span><span class="p">,</span><span class="s2">&quot;after&quot;</span><span class="o">:</span><span class="mi">27</span><span class="p">,</span><span class="s2">&quot;arraybuffer.slice&quot;</span><span class="o">:</span><span class="mi">28</span><span class="p">,</span><span class="s2">&quot;base64-arraybuffer&quot;</span><span class="o">:</span><span class="mi">29</span><span class="p">,</span><span class="s2">&quot;blob&quot;</span><span class="o">:</span><span class="mi">30</span><span class="p">,</span><span class="s2">&quot;has-binary&quot;</span><span class="o">:</span><span class="mi">31</span><span class="p">,</span><span class="s2">&quot;utf8&quot;</span><span class="o">:</span><span class="mi">33</span><span class="p">}],</span><span class="mi">26</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span></pre></div></td></tr><tr id="section-364"><td class="docs"><div class="pilwrap"><a href="#section-364" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Gets the keys for an object.</p></div><div class="details"><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Array</span><span>keys</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span> <span class="o">||</span> <span class="kd">function</span> <span class="nx">keys</span> <span class="p">(</span><span class="nx">obj</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">arr</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kd">var</span> <span class="nx">has</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">has</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">i</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">arr</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">arr</span><span class="p">;</span>
<span class="p">};</span>

<span class="p">},{}],</span><span class="mi">27</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">after</span>

<span class="kd">function</span> <span class="nx">after</span><span class="p">(</span><span class="nx">count</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">err_cb</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">bail</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="nx">err_cb</span> <span class="o">=</span> <span class="nx">err_cb</span> <span class="o">||</span> <span class="nx">noop</span>
    <span class="nx">proxy</span><span class="p">.</span><span class="nx">count</span> <span class="o">=</span> <span class="nx">count</span>

    <span class="k">return</span> <span class="p">(</span><span class="nx">count</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="nx">callback</span><span class="p">()</span> <span class="o">:</span> <span class="nx">proxy</span>

    <span class="kd">function</span> <span class="nx">proxy</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">proxy</span><span class="p">.</span><span class="nx">count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;after called too many times&#39;</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="o">--</span><span class="nx">proxy</span><span class="p">.</span><span class="nx">count</span></pre></div></td></tr><tr id="section-365"><td class="docs"><div class="pilwrap"><a href="#section-365" class="pilcrow">&#182;</a></div><p>after first error, rest are passed to err_cb</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">bail</span> <span class="o">=</span> <span class="kc">true</span>
            <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span></pre></div></td></tr><tr id="section-366"><td class="docs"><div class="pilwrap"><a href="#section-366" class="pilcrow">&#182;</a></div><p>future error callbacks will go to error handler</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">callback</span> <span class="o">=</span> <span class="nx">err_cb</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">proxy</span><span class="p">.</span><span class="nx">count</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">bail</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">noop</span><span class="p">()</span> <span class="p">{}</span>

<span class="p">},{}],</span><span class="mi">28</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span></pre></div></td></tr><tr id="section-367"><td class="docs"><div class="pilwrap"><a href="#section-367" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>An abstraction for slicing an arraybuffer even when<br />ArrayBuffer.prototype.slice is not supported</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">arraybuffer</span><span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">end</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">bytes</span> <span class="o">=</span> <span class="nx">arraybuffer</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">;</span>
  <span class="nx">start</span> <span class="o">=</span> <span class="nx">start</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nx">end</span> <span class="o">=</span> <span class="nx">end</span> <span class="o">||</span> <span class="nx">bytes</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">arraybuffer</span><span class="p">.</span><span class="nx">slice</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">arraybuffer</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">end</span><span class="p">);</span> <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="nx">start</span> <span class="o">+=</span> <span class="nx">bytes</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">end</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="nx">end</span> <span class="o">+=</span> <span class="nx">bytes</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">end</span> <span class="o">&gt;</span> <span class="nx">bytes</span><span class="p">)</span> <span class="p">{</span> <span class="nx">end</span> <span class="o">=</span> <span class="nx">bytes</span><span class="p">;</span> <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">start</span> <span class="o">&gt;=</span> <span class="nx">bytes</span> <span class="o">||</span> <span class="nx">start</span> <span class="o">&gt;=</span> <span class="nx">end</span> <span class="o">||</span> <span class="nx">bytes</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">abv</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">arraybuffer</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">end</span> <span class="o">-</span> <span class="nx">start</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">end</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">,</span> <span class="nx">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">result</span><span class="p">[</span><span class="nx">ii</span><span class="p">]</span> <span class="o">=</span> <span class="nx">abv</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">result</span><span class="p">.</span><span class="nx">buffer</span><span class="p">;</span>
<span class="p">};</span>

<span class="p">},{}],</span><span class="mi">29</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span></pre></div></td></tr><tr id="section-368"><td class="docs"><div class="pilwrap"><a href="#section-368" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>base64-arraybuffer<br /><a href='https://github.com/niklasvh/base64-arraybuffer'>https://github.com/niklasvh/base64-arraybuffer</a></p></div><div class="body"><p>Copyright (c) 2012 Niklas von Hertzen<br />Licensed under the MIT license.</p></div></div>
</td><td class="code"><div class="highlight"><pre><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">chars</span><span class="p">){</span>
  <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>

  <span class="nx">exports</span><span class="p">.</span><span class="nx">encode</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">arraybuffer</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">bytes</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">arraybuffer</span><span class="p">),</span>
    <span class="nx">i</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">base64</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">+=</span><span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">base64</span> <span class="o">+=</span> <span class="nx">chars</span><span class="p">[</span><span class="nx">bytes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">];</span>
      <span class="nx">base64</span> <span class="o">+=</span> <span class="nx">chars</span><span class="p">[((</span><span class="nx">bytes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nx">bytes</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)];</span>
      <span class="nx">base64</span> <span class="o">+=</span> <span class="nx">chars</span><span class="p">[((</span><span class="nx">bytes</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nx">bytes</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)];</span>
      <span class="nx">base64</span> <span class="o">+=</span> <span class="nx">chars</span><span class="p">[</span><span class="nx">bytes</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">63</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">((</span><span class="nx">len</span> <span class="o">%</span> <span class="mi">3</span><span class="p">)</span> <span class="o">===</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">base64</span> <span class="o">=</span> <span class="nx">base64</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">base64</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">len</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">base64</span> <span class="o">=</span> <span class="nx">base64</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">base64</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;==&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">base64</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">exports</span><span class="p">.</span><span class="nx">decode</span> <span class="o">=</span>  <span class="kd">function</span><span class="p">(</span><span class="nx">base64</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">bufferLength</span> <span class="o">=</span> <span class="nx">base64</span><span class="p">.</span><span class="nx">length</span> <span class="o">*</span> <span class="mf">0.75</span><span class="p">,</span>
    <span class="nx">len</span> <span class="o">=</span> <span class="nx">base64</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nx">encoded1</span><span class="p">,</span> <span class="nx">encoded2</span><span class="p">,</span> <span class="nx">encoded3</span><span class="p">,</span> <span class="nx">encoded4</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">base64</span><span class="p">[</span><span class="nx">base64</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&quot;=&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">bufferLength</span><span class="o">--</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">base64</span><span class="p">[</span><span class="nx">base64</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&quot;=&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">bufferLength</span><span class="o">--</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">arraybuffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="nx">bufferLength</span><span class="p">),</span>
    <span class="nx">bytes</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">arraybuffer</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">+=</span><span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">encoded1</span> <span class="o">=</span> <span class="nx">chars</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">base64</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
      <span class="nx">encoded2</span> <span class="o">=</span> <span class="nx">chars</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">base64</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]);</span>
      <span class="nx">encoded3</span> <span class="o">=</span> <span class="nx">chars</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">base64</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]);</span>
      <span class="nx">encoded4</span> <span class="o">=</span> <span class="nx">chars</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">base64</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]);</span>

      <span class="nx">bytes</span><span class="p">[</span><span class="nx">p</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">encoded1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nx">encoded2</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
      <span class="nx">bytes</span><span class="p">[</span><span class="nx">p</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="nx">encoded2</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nx">encoded3</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
      <span class="nx">bytes</span><span class="p">[</span><span class="nx">p</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="nx">encoded3</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nx">encoded4</span> <span class="o">&amp;</span> <span class="mi">63</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">arraybuffer</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">})(</span><span class="s2">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;</span><span class="p">);</span>

<span class="p">},{}],</span><span class="mi">30</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span>
<span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">global</span><span class="p">){</span></pre></div></td></tr><tr id="section-369"><td class="docs"><div class="pilwrap"><a href="#section-369" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Create a blob builder even when vendor prefixes exist</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">BlobBuilder</span> <span class="o">=</span> <span class="nx">global</span><span class="p">.</span><span class="nx">BlobBuilder</span>
  <span class="o">||</span> <span class="nx">global</span><span class="p">.</span><span class="nx">WebKitBlobBuilder</span>
  <span class="o">||</span> <span class="nx">global</span><span class="p">.</span><span class="nx">MSBlobBuilder</span>
  <span class="o">||</span> <span class="nx">global</span><span class="p">.</span><span class="nx">MozBlobBuilder</span><span class="p">;</span></pre></div></td></tr><tr id="section-370"><td class="docs"><div class="pilwrap"><a href="#section-370" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Check if Blob constructor is supported</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">blobSupported</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blob</span><span class="p">([</span><span class="s1">&#39;hi&#39;</span><span class="p">]);</span>
    <span class="k">return</span> <span class="nx">b</span><span class="p">.</span><span class="nx">size</span> <span class="o">==</span> <span class="mi">2</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">})();</span></pre></div></td></tr><tr id="section-371"><td class="docs"><div class="pilwrap"><a href="#section-371" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Check if BlobBuilder is supported</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">blobBuilderSupported</span> <span class="o">=</span> <span class="nx">BlobBuilder</span>
  <span class="o">&amp;&amp;</span> <span class="nx">BlobBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">append</span>
  <span class="o">&amp;&amp;</span> <span class="nx">BlobBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getBlob</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">BlobBuilderConstructor</span><span class="p">(</span><span class="nx">ary</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>

  <span class="kd">var</span> <span class="nx">bb</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BlobBuilder</span><span class="p">();</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">ary</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">bb</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">ary</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="o">?</span> <span class="nx">bb</span><span class="p">.</span><span class="nx">getBlob</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="o">:</span> <span class="nx">bb</span><span class="p">.</span><span class="nx">getBlob</span><span class="p">();</span>
<span class="p">};</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">blobSupported</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">global</span><span class="p">.</span><span class="nx">Blob</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">blobBuilderSupported</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">BlobBuilderConstructor</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">undefined</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">})();</span>

<span class="p">}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="k">typeof</span> <span class="nx">self</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span> <span class="o">?</span> <span class="nx">self</span> <span class="o">:</span> <span class="k">typeof</span> <span class="nb">window</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span> <span class="o">?</span> <span class="nb">window</span> <span class="o">:</span> <span class="p">{})</span>
<span class="p">},{}],</span><span class="mi">31</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span>
<span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">global</span><span class="p">){</span></pre></div></td></tr><tr id="section-372"><td class="docs"><div class="pilwrap"><a href="#section-372" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Module requirements.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">isArray</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;isarray&#39;</span><span class="p">);</span></pre></div></td></tr><tr id="section-373"><td class="docs"><div class="pilwrap"><a href="#section-373" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Module exports.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">hasBinary</span><span class="p">;</span></pre></div></td></tr><tr id="section-374"><td class="docs"><div class="pilwrap"><a href="#section-374" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Checks for binary data.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>anything </span><span class="dox_type">Object</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"><p>Right now only Buffer and ArrayBuffer are supported..</p></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">hasBinary</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>

  <span class="kd">function</span> <span class="nx">_hasBinary</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">obj</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">Buffer</span> <span class="o">&amp;&amp;</span> <span class="nx">global</span><span class="p">.</span><span class="nx">Buffer</span><span class="p">.</span><span class="nx">isBuffer</span><span class="p">(</span><span class="nx">obj</span><span class="p">))</span> <span class="o">||</span>
         <span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">ArrayBuffer</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span> <span class="k">instanceof</span> <span class="nx">ArrayBuffer</span><span class="p">)</span> <span class="o">||</span>
         <span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">Blob</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span> <span class="k">instanceof</span> <span class="nx">Blob</span><span class="p">)</span> <span class="o">||</span>
         <span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">File</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span> <span class="k">instanceof</span> <span class="nx">File</span><span class="p">)</span>
        <span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">obj</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">_hasBinary</span><span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="nx">i</span><span class="p">]))</span> <span class="p">{</span>
              <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
          <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;object&#39;</span> <span class="o">==</span> <span class="k">typeof</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">obj</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">_hasBinary</span><span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]))</span> <span class="p">{</span>
          <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">_hasBinary</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="p">}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="k">typeof</span> <span class="nx">self</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span> <span class="o">?</span> <span class="nx">self</span> <span class="o">:</span> <span class="k">typeof</span> <span class="nb">window</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span> <span class="o">?</span> <span class="nb">window</span> <span class="o">:</span> <span class="p">{})</span>
<span class="p">},{</span><span class="s2">&quot;isarray&quot;</span><span class="o">:</span><span class="mi">32</span><span class="p">}],</span><span class="mi">32</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span> <span class="o">||</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">arr</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arr</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;[object Array]&#39;</span><span class="p">;</span>
<span class="p">};</span>

<span class="p">},{}],</span><span class="mi">33</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span>
<span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">global</span><span class="p">){</span></pre></div></td></tr><tr id="section-375"><td class="docs"><div class="pilwrap"><a href="#section-375" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p><a href='http://mths.be/utf8js'>http://mths.be/utf8js</a> v2.0.0 by @mathias</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="p">;(</span><span class="kd">function</span><span class="p">(</span><span class="nx">root</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-376"><td class="docs"><div class="pilwrap"><a href="#section-376" class="pilcrow">&#182;</a></div><p>Detect free variables <code>exports</code></p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">freeExports</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">exports</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">exports</span><span class="p">;</span></pre></div></td></tr><tr id="section-377"><td class="docs"><div class="pilwrap"><a href="#section-377" class="pilcrow">&#182;</a></div><p>Detect free variable <code>module</code></p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">freeModule</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">module</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">module</span> <span class="o">&amp;&amp;</span>
    <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">==</span> <span class="nx">freeExports</span> <span class="o">&amp;&amp;</span> <span class="nx">module</span><span class="p">;</span></pre></div></td></tr><tr id="section-378"><td class="docs"><div class="pilwrap"><a href="#section-378" class="pilcrow">&#182;</a></div><p>Detect free variable <code>global</code>, from Node.js or Browserified code,
and use it as <code>root</code></p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">freeGlobal</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">global</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">global</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">freeGlobal</span><span class="p">.</span><span class="nx">global</span> <span class="o">===</span> <span class="nx">freeGlobal</span> <span class="o">||</span> <span class="nx">freeGlobal</span><span class="p">.</span><span class="nb">window</span> <span class="o">===</span> <span class="nx">freeGlobal</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">root</span> <span class="o">=</span> <span class="nx">freeGlobal</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-379"><td class="docs"><div class="pilwrap"><a href="#section-379" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><hr /></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">stringFromCharCode</span> <span class="o">=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">;</span></pre></div></td></tr><tr id="section-380"><td class="docs"><div class="pilwrap"><a href="#section-380" class="pilcrow">&#182;</a></div><p>Taken from http://mths.be/punycode</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">ucs2decode</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">output</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="kd">var</span> <span class="nx">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">string</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">value</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">extra</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">counter</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">value</span> <span class="o">=</span> <span class="nx">string</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">counter</span><span class="o">++</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">&gt;=</span> <span class="mh">0xD800</span> <span class="o">&amp;&amp;</span> <span class="nx">value</span> <span class="o">&lt;=</span> <span class="mh">0xDBFF</span> <span class="o">&amp;&amp;</span> <span class="nx">counter</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-381"><td class="docs"><div class="pilwrap"><a href="#section-381" class="pilcrow">&#182;</a></div><p>high surrogate, and there is a next character</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nx">extra</span> <span class="o">=</span> <span class="nx">string</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">counter</span><span class="o">++</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">((</span><span class="nx">extra</span> <span class="o">&amp;</span> <span class="mh">0xFC00</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xDC00</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// low surrogate</span>
          <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(((</span><span class="nx">value</span> <span class="o">&amp;</span> <span class="mh">0x3FF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">extra</span> <span class="o">&amp;</span> <span class="mh">0x3FF</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x10000</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr><tr id="section-382"><td class="docs"><div class="pilwrap"><a href="#section-382" class="pilcrow">&#182;</a></div><p>unmatched surrogate; only append this code unit, in case the next
code unit is the high surrogate of a surrogate pair</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
          <span class="nx">counter</span><span class="o">--</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">output</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-383"><td class="docs"><div class="pilwrap"><a href="#section-383" class="pilcrow">&#182;</a></div><p>Taken from http://mths.be/punycode</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">ucs2encode</span><span class="p">(</span><span class="nx">array</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">array</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">value</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">output</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">index</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">value</span> <span class="o">=</span> <span class="nx">array</span><span class="p">[</span><span class="nx">index</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">&gt;</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">value</span> <span class="o">-=</span> <span class="mh">0x10000</span><span class="p">;</span>
        <span class="nx">output</span> <span class="o">+=</span> <span class="nx">stringFromCharCode</span><span class="p">(</span><span class="nx">value</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">10</span> <span class="o">&amp;</span> <span class="mh">0x3FF</span> <span class="o">|</span> <span class="mh">0xD800</span><span class="p">);</span>
        <span class="nx">value</span> <span class="o">=</span> <span class="mh">0xDC00</span> <span class="o">|</span> <span class="nx">value</span> <span class="o">&amp;</span> <span class="mh">0x3FF</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">output</span> <span class="o">+=</span> <span class="nx">stringFromCharCode</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">output</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-384"><td class="docs"><div class="pilwrap"><a href="#section-384" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><hr /></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">createByte</span><span class="p">(</span><span class="nx">codePoint</span><span class="p">,</span> <span class="nx">shift</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">stringFromCharCode</span><span class="p">(((</span><span class="nx">codePoint</span> <span class="o">&gt;&gt;</span> <span class="nx">shift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">encodeCodePoint</span><span class="p">(</span><span class="nx">codePoint</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">((</span><span class="nx">codePoint</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFF80</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 1-byte sequence</span>
      <span class="k">return</span> <span class="nx">stringFromCharCode</span><span class="p">(</span><span class="nx">codePoint</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">symbol</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">((</span><span class="nx">codePoint</span> <span class="o">&amp;</span> <span class="mh">0xFFFFF800</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 2-byte sequence</span>
      <span class="nx">symbol</span> <span class="o">=</span> <span class="nx">stringFromCharCode</span><span class="p">(((</span><span class="nx">codePoint</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xC0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="nx">codePoint</span> <span class="o">&amp;</span> <span class="mh">0xFFFF0000</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 3-byte sequence</span>
      <span class="nx">symbol</span> <span class="o">=</span> <span class="nx">stringFromCharCode</span><span class="p">(((</span><span class="nx">codePoint</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xE0</span><span class="p">);</span>
      <span class="nx">symbol</span> <span class="o">+=</span> <span class="nx">createByte</span><span class="p">(</span><span class="nx">codePoint</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="nx">codePoint</span> <span class="o">&amp;</span> <span class="mh">0xFFE00000</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 4-byte sequence</span>
      <span class="nx">symbol</span> <span class="o">=</span> <span class="nx">stringFromCharCode</span><span class="p">(((</span><span class="nx">codePoint</span> <span class="o">&gt;&gt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xF0</span><span class="p">);</span>
      <span class="nx">symbol</span> <span class="o">+=</span> <span class="nx">createByte</span><span class="p">(</span><span class="nx">codePoint</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
      <span class="nx">symbol</span> <span class="o">+=</span> <span class="nx">createByte</span><span class="p">(</span><span class="nx">codePoint</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">symbol</span> <span class="o">+=</span> <span class="nx">stringFromCharCode</span><span class="p">((</span><span class="nx">codePoint</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">symbol</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">utf8encode</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">codePoints</span> <span class="o">=</span> <span class="nx">ucs2decode</span><span class="p">(</span><span class="nx">string</span><span class="p">);</span></pre></div></td></tr><tr id="section-385"><td class="docs"><div class="pilwrap"><a href="#section-385" class="pilcrow">&#182;</a></div><p>console.log(JSON.stringify(codePoints.map(function(x) {
    return 'U+' + x.toString(16).toUpperCase();
})));</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">codePoints</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">codePoint</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">byteString</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">index</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">codePoint</span> <span class="o">=</span> <span class="nx">codePoints</span><span class="p">[</span><span class="nx">index</span><span class="p">];</span>
      <span class="nx">byteString</span> <span class="o">+=</span> <span class="nx">encodeCodePoint</span><span class="p">(</span><span class="nx">codePoint</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">byteString</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-386"><td class="docs"><div class="pilwrap"><a href="#section-386" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><hr /></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">readContinuationByte</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">byteIndex</span> <span class="o">&gt;=</span> <span class="nx">byteCount</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Invalid byte index&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">continuationByte</span> <span class="o">=</span> <span class="nx">byteArray</span><span class="p">[</span><span class="nx">byteIndex</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
    <span class="nx">byteIndex</span><span class="o">++</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">((</span><span class="nx">continuationByte</span> <span class="o">&amp;</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">continuationByte</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-387"><td class="docs"><div class="pilwrap"><a href="#section-387" class="pilcrow">&#182;</a></div><p>If we end up here, it’s not a continuation byte</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Invalid continuation byte&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">decodeSymbol</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">byte1</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">byte2</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">byte3</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">byte4</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">codePoint</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">byteIndex</span> <span class="o">&gt;</span> <span class="nx">byteCount</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Invalid byte index&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">byteIndex</span> <span class="o">==</span> <span class="nx">byteCount</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-388"><td class="docs"><div class="pilwrap"><a href="#section-388" class="pilcrow">&#182;</a></div><p>Read first byte</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">byte1</span> <span class="o">=</span> <span class="nx">byteArray</span><span class="p">[</span><span class="nx">byteIndex</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
    <span class="nx">byteIndex</span><span class="o">++</span><span class="p">;</span></pre></div></td></tr><tr id="section-389"><td class="docs"><div class="pilwrap"><a href="#section-389" class="pilcrow">&#182;</a></div><p>1-byte sequence (no continuation bytes)</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">((</span><span class="nx">byte1</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">byte1</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-390"><td class="docs"><div class="pilwrap"><a href="#section-390" class="pilcrow">&#182;</a></div><p>2-byte sequence</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">((</span><span class="nx">byte1</span> <span class="o">&amp;</span> <span class="mh">0xE0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">byte2</span> <span class="o">=</span> <span class="nx">readContinuationByte</span><span class="p">();</span>
      <span class="nx">codePoint</span> <span class="o">=</span> <span class="p">((</span><span class="nx">byte1</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="nx">byte2</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">codePoint</span> <span class="o">&gt;=</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">codePoint</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Invalid continuation byte&#39;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-391"><td class="docs"><div class="pilwrap"><a href="#section-391" class="pilcrow">&#182;</a></div><p>3-byte sequence (may include unpaired surrogates)</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">((</span><span class="nx">byte1</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xE0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">byte2</span> <span class="o">=</span> <span class="nx">readContinuationByte</span><span class="p">();</span>
      <span class="nx">byte3</span> <span class="o">=</span> <span class="nx">readContinuationByte</span><span class="p">();</span>
      <span class="nx">codePoint</span> <span class="o">=</span> <span class="p">((</span><span class="nx">byte1</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nx">byte2</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="nx">byte3</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">codePoint</span> <span class="o">&gt;=</span> <span class="mh">0x0800</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">codePoint</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Invalid continuation byte&#39;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-392"><td class="docs"><div class="pilwrap"><a href="#section-392" class="pilcrow">&#182;</a></div><p>4-byte sequence</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">((</span><span class="nx">byte1</span> <span class="o">&amp;</span> <span class="mh">0xF8</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">byte2</span> <span class="o">=</span> <span class="nx">readContinuationByte</span><span class="p">();</span>
      <span class="nx">byte3</span> <span class="o">=</span> <span class="nx">readContinuationByte</span><span class="p">();</span>
      <span class="nx">byte4</span> <span class="o">=</span> <span class="nx">readContinuationByte</span><span class="p">();</span>
      <span class="nx">codePoint</span> <span class="o">=</span> <span class="p">((</span><span class="nx">byte1</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mh">0x12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nx">byte2</span> <span class="o">&lt;&lt;</span> <span class="mh">0x0C</span><span class="p">)</span> <span class="o">|</span>
        <span class="p">(</span><span class="nx">byte3</span> <span class="o">&lt;&lt;</span> <span class="mh">0x06</span><span class="p">)</span> <span class="o">|</span> <span class="nx">byte4</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">codePoint</span> <span class="o">&gt;=</span> <span class="mh">0x010000</span> <span class="o">&amp;&amp;</span> <span class="nx">codePoint</span> <span class="o">&lt;=</span> <span class="mh">0x10FFFF</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">codePoint</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Invalid UTF-8 detected&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">byteArray</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">byteCount</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">byteIndex</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">utf8decode</span><span class="p">(</span><span class="nx">byteString</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">byteArray</span> <span class="o">=</span> <span class="nx">ucs2decode</span><span class="p">(</span><span class="nx">byteString</span><span class="p">);</span>
    <span class="nx">byteCount</span> <span class="o">=</span> <span class="nx">byteArray</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="nx">byteIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">codePoints</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="kd">var</span> <span class="nx">tmp</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">((</span><span class="nx">tmp</span> <span class="o">=</span> <span class="nx">decodeSymbol</span><span class="p">())</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">codePoints</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">tmp</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">ucs2encode</span><span class="p">(</span><span class="nx">codePoints</span><span class="p">);</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-393"><td class="docs"><div class="pilwrap"><a href="#section-393" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><hr /></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">utf8</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;version&#39;</span><span class="o">:</span> <span class="s1">&#39;2.0.0&#39;</span><span class="p">,</span>
    <span class="s1">&#39;encode&#39;</span><span class="o">:</span> <span class="nx">utf8encode</span><span class="p">,</span>
    <span class="s1">&#39;decode&#39;</span><span class="o">:</span> <span class="nx">utf8decode</span>
  <span class="p">};</span></pre></div></td></tr><tr id="section-394"><td class="docs"><div class="pilwrap"><a href="#section-394" class="pilcrow">&#182;</a></div><p>Some AMD build optimizers, like r.js, check for specific condition patterns
like the following:</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span>
    <span class="k">typeof</span> <span class="nx">define</span> <span class="o">==</span> <span class="s1">&#39;function&#39;</span> <span class="o">&amp;&amp;</span>
    <span class="k">typeof</span> <span class="nx">define</span><span class="p">.</span><span class="nx">amd</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span> <span class="o">&amp;&amp;</span>
    <span class="nx">define</span><span class="p">.</span><span class="nx">amd</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="nx">define</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">utf8</span><span class="p">;</span>
    <span class="p">});</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">freeExports</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">freeExports</span><span class="p">.</span><span class="nx">nodeType</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">freeModule</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// in Node.js or RingoJS v0.8.0+</span>
      <span class="nx">freeModule</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">utf8</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// in Narwhal or RingoJS v0.7.0-</span>
      <span class="kd">var</span> <span class="nx">object</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="kd">var</span> <span class="nx">hasOwnProperty</span> <span class="o">=</span> <span class="nx">object</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">utf8</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">hasOwnProperty</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">utf8</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">freeExports</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">utf8</span><span class="p">[</span><span class="nx">key</span><span class="p">]);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// in Rhino or a web browser</span>
    <span class="nx">root</span><span class="p">.</span><span class="nx">utf8</span> <span class="o">=</span> <span class="nx">utf8</span><span class="p">;</span>
  <span class="p">}</span>

<span class="p">}(</span><span class="k">this</span><span class="p">));</span>

<span class="p">}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="k">typeof</span> <span class="nx">self</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span> <span class="o">?</span> <span class="nx">self</span> <span class="o">:</span> <span class="k">typeof</span> <span class="nb">window</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span> <span class="o">?</span> <span class="nb">window</span> <span class="o">:</span> <span class="p">{})</span>
<span class="p">},{}],</span><span class="mi">34</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span>
<span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">global</span><span class="p">){</span></pre></div></td></tr><tr id="section-395"><td class="docs"><div class="pilwrap"><a href="#section-395" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>JSON parse.</p></div><div class="details"><div class="dox_tag_title">See</div><div class="dox_tag_detail"><span class="dox_type">Based on jQuery#parseJSON (MIT) and JSON2</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">rvalidchars</span> <span class="o">=</span> <span class="sr">/^[\],:{}\s]*$/</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">rvalidescape</span> <span class="o">=</span> <span class="sr">/\\(?:[&quot;\\\/bfnrt]|u[0-9a-fA-F]{4})/g</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">rvalidtokens</span> <span class="o">=</span> <span class="sr">/&quot;[^&quot;\\\n\r]*&quot;|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">rvalidbraces</span> <span class="o">=</span> <span class="sr">/(?:^|:|,)(?:\s*\[)+/g</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">rtrimLeft</span> <span class="o">=</span> <span class="sr">/^\s+/</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">rtrimRight</span> <span class="o">=</span> <span class="sr">/\s+$/</span><span class="p">;</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">parsejson</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">!=</span> <span class="k">typeof</span> <span class="nx">data</span> <span class="o">||</span> <span class="o">!</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">data</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">rtrimLeft</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="nx">rtrimRight</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span></pre></div></td></tr><tr id="section-396"><td class="docs"><div class="pilwrap"><a href="#section-396" class="pilcrow">&#182;</a></div><p>Attempt to parse using the native JSON parser first</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">JSON</span> <span class="o">&amp;&amp;</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">rvalidchars</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">rvalidescape</span><span class="p">,</span> <span class="s1">&#39;@&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">rvalidtokens</span><span class="p">,</span> <span class="s1">&#39;]&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">rvalidbraces</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Function</span><span class="p">(</span><span class="s1">&#39;return &#39;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">))();</span>
  <span class="p">}</span>
<span class="p">};</span>
<span class="p">}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="k">typeof</span> <span class="nx">self</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span> <span class="o">?</span> <span class="nx">self</span> <span class="o">:</span> <span class="k">typeof</span> <span class="nb">window</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span> <span class="o">?</span> <span class="nb">window</span> <span class="o">:</span> <span class="p">{})</span>
<span class="p">},{}],</span><span class="mi">35</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span></pre></div></td></tr><tr id="section-397"><td class="docs"><div class="pilwrap"><a href="#section-397" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Compiles a querystring<br />Returns string representation of the object</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span> </span><span class="dox_type">Object</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">encode</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">str</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="nx">str</span> <span class="o">+=</span> <span class="s1">&#39;&amp;&#39;</span><span class="p">;</span>
      <span class="nx">str</span> <span class="o">+=</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">str</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-398"><td class="docs"><div class="pilwrap"><a href="#section-398" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Parses a simple querystring into an object</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>qs </span><span class="dox_type">String</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">decode</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">qs</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">qry</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="kd">var</span> <span class="nx">pairs</span> <span class="o">=</span> <span class="nx">qs</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">pairs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">pair</span> <span class="o">=</span> <span class="nx">pairs</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">);</span>
    <span class="nx">qry</span><span class="p">[</span><span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nx">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="o">=</span> <span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nx">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">qry</span><span class="p">;</span>
<span class="p">};</span>

<span class="p">},{}],</span><span class="mi">36</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span></pre></div></td></tr><tr id="section-399"><td class="docs"><div class="pilwrap"><a href="#section-399" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Parses an URI</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">re</span> <span class="o">=</span> <span class="sr">/^(?:(?![^:@]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">parts</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="s1">&#39;protocol&#39;</span><span class="p">,</span> <span class="s1">&#39;authority&#39;</span><span class="p">,</span> <span class="s1">&#39;userInfo&#39;</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="s1">&#39;host&#39;</span><span class="p">,</span> <span class="s1">&#39;port&#39;</span><span class="p">,</span> <span class="s1">&#39;relative&#39;</span><span class="p">,</span> <span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="s1">&#39;directory&#39;</span><span class="p">,</span> <span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="s1">&#39;anchor&#39;</span>
<span class="p">];</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">parseuri</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">src</span> <span class="o">=</span> <span class="nx">str</span><span class="p">,</span>
        <span class="nx">b</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">),</span>
        <span class="nx">e</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">b</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">str</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="o">+</span> <span class="nx">str</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="nx">e</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/:/g</span><span class="p">,</span> <span class="s1">&#39;;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nx">str</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">str</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">re</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">str</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
        <span class="nx">uri</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="nx">i</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">uri</span><span class="p">[</span><span class="nx">parts</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">m</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">b</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">uri</span><span class="p">.</span><span class="nx">source</span> <span class="o">=</span> <span class="nx">src</span><span class="p">;</span>
        <span class="nx">uri</span><span class="p">.</span><span class="nx">host</span> <span class="o">=</span> <span class="nx">uri</span><span class="p">.</span><span class="nx">host</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">uri</span><span class="p">.</span><span class="nx">host</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/;/g</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">);</span>
        <span class="nx">uri</span><span class="p">.</span><span class="nx">authority</span> <span class="o">=</span> <span class="nx">uri</span><span class="p">.</span><span class="nx">authority</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/;/g</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">);</span>
        <span class="nx">uri</span><span class="p">.</span><span class="nx">ipv6uri</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">uri</span><span class="p">;</span>
<span class="p">};</span>

<span class="p">},{}],</span><span class="mi">37</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span></pre></div></td></tr><tr id="section-400"><td class="docs"><div class="pilwrap"><a href="#section-400" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Module dependencies.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">global</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">;</span> <span class="p">})();</span></pre></div></td></tr><tr id="section-401"><td class="docs"><div class="pilwrap"><a href="#section-401" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>WebSocket constructor.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">WebSocket</span> <span class="o">=</span> <span class="nx">global</span><span class="p">.</span><span class="nx">WebSocket</span> <span class="o">||</span> <span class="nx">global</span><span class="p">.</span><span class="nx">MozWebSocket</span><span class="p">;</span></pre></div></td></tr><tr id="section-402"><td class="docs"><div class="pilwrap"><a href="#section-402" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Module exports.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">WebSocket</span> <span class="o">?</span> <span class="nx">ws</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span></pre></div></td></tr><tr id="section-403"><td class="docs"><div class="pilwrap"><a href="#section-403" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>WebSocket constructor.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>uri </span><span class="dox_type">String</span></div><div class="dox_tag_detail"><span>protocols </span><span class="dox_type">Array</span><span>- (optional)</span></div><div class="dox_tag_detail"><span>opts </span><span class="dox_type">Object)</span><span>- (optional)</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"><p>The third <code>opts</code> options object gets ignored in web browsers, since it's<br />non-standard, and throws a TypeError if passed to the constructor.<br />See: <a href='https://github.com/einaros/ws/issues/227'>https://github.com/einaros/ws/issues/227</a></p></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">ws</span><span class="p">(</span><span class="nx">uri</span><span class="p">,</span> <span class="nx">protocols</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">instance</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">protocols</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">instance</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="nx">uri</span><span class="p">,</span> <span class="nx">protocols</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">instance</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="nx">uri</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">instance</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">WebSocket</span><span class="p">)</span> <span class="nx">ws</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span>

<span class="p">},{}],</span><span class="mi">38</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span>
<span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">global</span><span class="p">){</span></pre></div></td></tr><tr id="section-404"><td class="docs"><div class="pilwrap"><a href="#section-404" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Module requirements.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">isArray</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;isarray&#39;</span><span class="p">);</span></pre></div></td></tr><tr id="section-405"><td class="docs"><div class="pilwrap"><a href="#section-405" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Module exports.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">hasBinary</span><span class="p">;</span></pre></div></td></tr><tr id="section-406"><td class="docs"><div class="pilwrap"><a href="#section-406" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Checks for binary data.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>anything </span><span class="dox_type">Object</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"><p>Right now only Buffer and ArrayBuffer are supported..</p></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">hasBinary</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>

  <span class="kd">function</span> <span class="nx">_hasBinary</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">obj</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">Buffer</span> <span class="o">&amp;&amp;</span> <span class="nx">global</span><span class="p">.</span><span class="nx">Buffer</span><span class="p">.</span><span class="nx">isBuffer</span><span class="p">(</span><span class="nx">obj</span><span class="p">))</span> <span class="o">||</span>
         <span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">ArrayBuffer</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span> <span class="k">instanceof</span> <span class="nx">ArrayBuffer</span><span class="p">)</span> <span class="o">||</span>
         <span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">Blob</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span> <span class="k">instanceof</span> <span class="nx">Blob</span><span class="p">)</span> <span class="o">||</span>
         <span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">File</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span> <span class="k">instanceof</span> <span class="nx">File</span><span class="p">)</span>
        <span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">obj</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">_hasBinary</span><span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="nx">i</span><span class="p">]))</span> <span class="p">{</span>
              <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
          <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;object&#39;</span> <span class="o">==</span> <span class="k">typeof</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">obj</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">_hasBinary</span><span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]))</span> <span class="p">{</span>
          <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">_hasBinary</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="p">}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="k">typeof</span> <span class="nx">self</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span> <span class="o">?</span> <span class="nx">self</span> <span class="o">:</span> <span class="k">typeof</span> <span class="nb">window</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span> <span class="o">?</span> <span class="nb">window</span> <span class="o">:</span> <span class="p">{})</span>
<span class="p">},{</span><span class="s2">&quot;isarray&quot;</span><span class="o">:</span><span class="mi">39</span><span class="p">}],</span><span class="mi">39</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
<span class="p">},{}],</span><span class="mi">40</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span></pre></div></td></tr><tr id="section-407"><td class="docs"><div class="pilwrap"><a href="#section-407" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Module dependencies.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">global</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;global&#39;</span><span class="p">);</span></pre></div></td></tr><tr id="section-408"><td class="docs"><div class="pilwrap"><a href="#section-408" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Module exports.</p></div><div class="body"><h2>Logic borrowed from Modernizr</h2>

<ul>
<li><a href='https://github.com/Modernizr/Modernizr/blob/master/feature-detects/cors.js'>https://github.com/Modernizr/Modernizr/blob/master/feature-detects/cors.js</a></li>
</ul></div></div>
</td><td class="code"><div class="highlight"><pre><span class="k">try</span> <span class="p">{</span>
  <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="s1">&#39;XMLHttpRequest&#39;</span> <span class="k">in</span> <span class="nx">global</span> <span class="o">&amp;&amp;</span>
    <span class="s1">&#39;withCredentials&#39;</span> <span class="k">in</span> <span class="k">new</span> <span class="nx">global</span><span class="p">.</span><span class="nx">XMLHttpRequest</span><span class="p">();</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-409"><td class="docs"><div class="pilwrap"><a href="#section-409" class="pilcrow">&#182;</a></div><p>if XMLHttp support is disabled in IE then it will throw
when trying to create</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">},{</span><span class="s2">&quot;global&quot;</span><span class="o">:</span><span class="mi">41</span><span class="p">}],</span><span class="mi">41</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span></pre></div></td></tr><tr id="section-410"><td class="docs"><div class="pilwrap"><a href="#section-410" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Returns <code>this</code>. Execute this without a "context" (i.e. without it being<br />attached to an object of the left-hand side), and <code>this</code> points to the<br />"global" scope of the current JS execution.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">;</span> <span class="p">})();</span>

<span class="p">},{}],</span><span class="mi">42</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span>

<span class="kd">var</span> <span class="nx">indexOf</span> <span class="o">=</span> <span class="p">[].</span><span class="nx">indexOf</span><span class="p">;</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="nx">obj</span><span class="p">){</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">indexOf</span><span class="p">)</span> <span class="k">return</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">arr</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">===</span> <span class="nx">obj</span><span class="p">)</span> <span class="k">return</span> <span class="nx">i</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">};</span>
<span class="p">},{}],</span><span class="mi">43</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span></pre></div></td></tr><tr id="section-411"><td class="docs"><div class="pilwrap"><a href="#section-411" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>HOP ref.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">has</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">;</span></pre></div></td></tr><tr id="section-412"><td class="docs"><div class="pilwrap"><a href="#section-412" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Return own keys in <code>obj</code>.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>obj </span><span class="dox_type">Object</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Array</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">keys</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span> <span class="o">||</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">has</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">keys</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">keys</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-413"><td class="docs"><div class="pilwrap"><a href="#section-413" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Return own values in <code>obj</code>.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>obj </span><span class="dox_type">Object</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Array</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">values</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">vals</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">has</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">vals</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">vals</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-414"><td class="docs"><div class="pilwrap"><a href="#section-414" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Merge <code>b</code> into <code>a</code>.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>a </span><span class="dox_type">Object</span></div><div class="dox_tag_detail"><span>b </span><span class="dox_type">Object</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Object</span><span>a</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">merge</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">){</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">has</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">a</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">b</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">a</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-415"><td class="docs"><div class="pilwrap"><a href="#section-415" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Return length of <code>obj</code>.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>obj </span><span class="dox_type">Object</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Number</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">){</span>
  <span class="k">return</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">obj</span><span class="p">).</span><span class="nx">length</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-416"><td class="docs"><div class="pilwrap"><a href="#section-416" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Check if <code>obj</code> is empty.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>obj </span><span class="dox_type">Object</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Boolean</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">isEmpty</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">){</span>
  <span class="k">return</span> <span class="mi">0</span> <span class="o">==</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">length</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
<span class="p">};</span>
<span class="p">},{}],</span><span class="mi">44</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span></pre></div></td></tr><tr id="section-417"><td class="docs"><div class="pilwrap"><a href="#section-417" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Parses an URI</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">re</span> <span class="o">=</span> <span class="sr">/^(?:(?![^:@]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">parts</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="s1">&#39;protocol&#39;</span><span class="p">,</span> <span class="s1">&#39;authority&#39;</span><span class="p">,</span> <span class="s1">&#39;userInfo&#39;</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="s1">&#39;host&#39;</span>
  <span class="p">,</span> <span class="s1">&#39;port&#39;</span><span class="p">,</span> <span class="s1">&#39;relative&#39;</span><span class="p">,</span> <span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="s1">&#39;directory&#39;</span><span class="p">,</span> <span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="s1">&#39;anchor&#39;</span>
<span class="p">];</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">parseuri</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">re</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">str</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="p">,</span> <span class="nx">uri</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="p">,</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>

  <span class="k">while</span> <span class="p">(</span><span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">uri</span><span class="p">[</span><span class="nx">parts</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">m</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">uri</span><span class="p">;</span>
<span class="p">};</span>

<span class="p">},{}],</span><span class="mi">45</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span>
<span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">global</span><span class="p">){</span></pre></div></td></tr><tr id="section-418"><td class="docs"><div class="pilwrap"><a href="#section-418" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>lobal Blob,File</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-419"><td class="docs"><div class="pilwrap"><a href="#section-419" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Module requirements</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">isArray</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;isarray&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">isBuf</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;./is-buffer&#39;</span><span class="p">);</span></pre></div></td></tr><tr id="section-420"><td class="docs"><div class="pilwrap"><a href="#section-420" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Replaces every Buffer | ArrayBuffer in packet with a numbered placeholder.<br />Anything with blobs or files should be fed through removeBlobs before coming<br />here.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>packet </span><span class="dox_type">Object</span><span>- - socket.io event packet</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Object</span><span>with deconstructed packet and list of buffers</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">deconstructPacket</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">packet</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">buffers</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kd">var</span> <span class="nx">packetData</span> <span class="o">=</span> <span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">_deconstructPacket</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">data</span><span class="p">)</span> <span class="k">return</span> <span class="nx">data</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">isBuf</span><span class="p">(</span><span class="nx">data</span><span class="p">))</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">placeholder</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">_placeholder</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">num</span><span class="o">:</span> <span class="nx">buffers</span><span class="p">.</span><span class="nx">length</span> <span class="p">};</span>
      <span class="nx">buffers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">placeholder</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">data</span><span class="p">))</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">newData</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">newData</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_deconstructPacket</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">newData</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;object&#39;</span> <span class="o">==</span> <span class="k">typeof</span> <span class="nx">data</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="nx">data</span> <span class="k">instanceof</span> <span class="nb">Date</span><span class="p">))</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">newData</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">newData</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_deconstructPacket</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">key</span><span class="p">]);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">newData</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">data</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">pack</span> <span class="o">=</span> <span class="nx">packet</span><span class="p">;</span>
  <span class="nx">pack</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">_deconstructPacket</span><span class="p">(</span><span class="nx">packetData</span><span class="p">);</span>
  <span class="nx">pack</span><span class="p">.</span><span class="nx">attachments</span> <span class="o">=</span> <span class="nx">buffers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="c1">// number of binary &#39;attachments&#39;</span>
  <span class="k">return</span> <span class="p">{</span><span class="nx">packet</span><span class="o">:</span> <span class="nx">pack</span><span class="p">,</span> <span class="nx">buffers</span><span class="o">:</span> <span class="nx">buffers</span><span class="p">};</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-421"><td class="docs"><div class="pilwrap"><a href="#section-421" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Reconstructs a binary packet from its placeholder packet and buffers</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>packet </span><span class="dox_type">Object</span><span>- - event packet with placeholders</span></div><div class="dox_tag_detail"><span>buffers </span><span class="dox_type">Array</span><span>- - binary buffers to put in placeholder positions</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Object</span><span>reconstructed packet</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">reconstructPacket</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span> <span class="nx">buffers</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">curPlaceHolder</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">_reconstructPacket</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">data</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">_placeholder</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">buf</span> <span class="o">=</span> <span class="nx">buffers</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">num</span><span class="p">];</span> <span class="c1">// appropriate buffer (should be natural order anyway)</span>
      <span class="k">return</span> <span class="nx">buf</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">data</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_reconstructPacket</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">data</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">data</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;object&#39;</span> <span class="o">==</span> <span class="k">typeof</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">data</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_reconstructPacket</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">key</span><span class="p">]);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">data</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">data</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">packet</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">_reconstructPacket</span><span class="p">(</span><span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
  <span class="nx">packet</span><span class="p">.</span><span class="nx">attachments</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span> <span class="c1">// no longer useful</span>
  <span class="k">return</span> <span class="nx">packet</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-422"><td class="docs"><div class="pilwrap"><a href="#section-422" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Asynchronously removes Blobs or Files from data via<br />FileReader's readAsArrayBuffer method. Used before encoding<br />data as msgpack. Calls callback with the blobless data.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>data </span><span class="dox_type">Object</span></div><div class="dox_tag_detail"><span>callback </span><span class="dox_type">Function</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">removeBlobs</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">function</span> <span class="nx">_removeBlobs</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">curKey</span><span class="p">,</span> <span class="nx">containingObject</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">obj</span><span class="p">)</span> <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span></pre></div></td></tr><tr id="section-423"><td class="docs"><div class="pilwrap"><a href="#section-423" class="pilcrow">&#182;</a></div><p>convert any blob</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">((</span><span class="nx">global</span><span class="p">.</span><span class="nx">Blob</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span> <span class="k">instanceof</span> <span class="nx">Blob</span><span class="p">)</span> <span class="o">||</span>
        <span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">File</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span> <span class="k">instanceof</span> <span class="nx">File</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">pendingBlobs</span><span class="o">++</span><span class="p">;</span></pre></div></td></tr><tr id="section-424"><td class="docs"><div class="pilwrap"><a href="#section-424" class="pilcrow">&#182;</a></div><p>async filereader</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">fileReader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FileReader</span><span class="p">();</span>
      <span class="nx">fileReader</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// this.result == arraybuffer</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">containingObject</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">containingObject</span><span class="p">[</span><span class="nx">curKey</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">result</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="nx">bloblessData</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">result</span><span class="p">;</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-425"><td class="docs"><div class="pilwrap"><a href="#section-425" class="pilcrow">&#182;</a></div><p>if nothing pending its callback time</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="o">!</span> <span class="o">--</span><span class="nx">pendingBlobs</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">callback</span><span class="p">(</span><span class="nx">bloblessData</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">};</span>

      <span class="nx">fileReader</span><span class="p">.</span><span class="nx">readAsArrayBuffer</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span> <span class="c1">// blob -&gt; arraybuffer</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">obj</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// handle array</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">_removeBlobs</span><span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">obj</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;object&#39;</span> <span class="o">==</span> <span class="k">typeof</span> <span class="nx">obj</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isBuf</span><span class="p">(</span><span class="nx">obj</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// and object</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">_removeBlobs</span><span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">obj</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">pendingBlobs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">bloblessData</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
  <span class="nx">_removeBlobs</span><span class="p">(</span><span class="nx">bloblessData</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">pendingBlobs</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">callback</span><span class="p">(</span><span class="nx">bloblessData</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="p">}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="k">typeof</span> <span class="nx">self</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span> <span class="o">?</span> <span class="nx">self</span> <span class="o">:</span> <span class="k">typeof</span> <span class="nb">window</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span> <span class="o">?</span> <span class="nb">window</span> <span class="o">:</span> <span class="p">{})</span>
<span class="p">},{</span><span class="s2">&quot;./is-buffer&quot;</span><span class="o">:</span><span class="mi">47</span><span class="p">,</span><span class="s2">&quot;isarray&quot;</span><span class="o">:</span><span class="mi">48</span><span class="p">}],</span><span class="mi">46</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span></pre></div></td></tr><tr id="section-426"><td class="docs"><div class="pilwrap"><a href="#section-426" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Module dependencies.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">debug</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">)(</span><span class="s1">&#39;socket.io-parser&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">json</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;json3&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">isArray</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;isarray&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">Emitter</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;component-emitter&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">binary</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;./binary&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">isBuf</span> <span class="o">=</span> <span class="nx">_dereq_</span><span class="p">(</span><span class="s1">&#39;./is-buffer&#39;</span><span class="p">);</span></pre></div></td></tr><tr id="section-427"><td class="docs"><div class="pilwrap"><a href="#section-427" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Protocol version.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span></pre></div></td></tr><tr id="section-428"><td class="docs"><div class="pilwrap"><a href="#section-428" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Packet types.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">types</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s1">&#39;CONNECT&#39;</span><span class="p">,</span>
  <span class="s1">&#39;DISCONNECT&#39;</span><span class="p">,</span>
  <span class="s1">&#39;EVENT&#39;</span><span class="p">,</span>
  <span class="s1">&#39;BINARY_EVENT&#39;</span><span class="p">,</span>
  <span class="s1">&#39;ACK&#39;</span><span class="p">,</span>
  <span class="s1">&#39;BINARY_ACK&#39;</span><span class="p">,</span>
  <span class="s1">&#39;ERROR&#39;</span>
<span class="p">];</span></pre></div></td></tr><tr id="section-429"><td class="docs"><div class="pilwrap"><a href="#section-429" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Packet type <code>connect</code>.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">CONNECT</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr><tr id="section-430"><td class="docs"><div class="pilwrap"><a href="#section-430" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Packet type <code>disconnect</code>.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">DISCONNECT</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr><tr id="section-431"><td class="docs"><div class="pilwrap"><a href="#section-431" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Packet type <code>event</code>.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">EVENT</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span></pre></div></td></tr><tr id="section-432"><td class="docs"><div class="pilwrap"><a href="#section-432" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Packet type <code>ack</code>.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">ACK</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span></pre></div></td></tr><tr id="section-433"><td class="docs"><div class="pilwrap"><a href="#section-433" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Packet type <code>error</code>.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">ERROR</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span></pre></div></td></tr><tr id="section-434"><td class="docs"><div class="pilwrap"><a href="#section-434" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Packet type 'binary event'</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">BINARY_EVENT</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span></pre></div></td></tr><tr id="section-435"><td class="docs"><div class="pilwrap"><a href="#section-435" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Packet type <code>binary ack</code>. For acks with binary arguments.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">BINARY_ACK</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span></pre></div></td></tr><tr id="section-436"><td class="docs"><div class="pilwrap"><a href="#section-436" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Encoder constructor.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">Encoder</span> <span class="o">=</span> <span class="nx">Encoder</span><span class="p">;</span></pre></div></td></tr><tr id="section-437"><td class="docs"><div class="pilwrap"><a href="#section-437" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Decoder constructor.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">Decoder</span> <span class="o">=</span> <span class="nx">Decoder</span><span class="p">;</span></pre></div></td></tr><tr id="section-438"><td class="docs"><div class="pilwrap"><a href="#section-438" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>A socket.io Encoder instance</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">Encoder</span><span class="p">()</span> <span class="p">{}</span></pre></div></td></tr><tr id="section-439"><td class="docs"><div class="pilwrap"><a href="#section-439" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Encode a packet as a single string if non-binary, or as a<br />buffer sequence, depending on packet type.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>obj </span><span class="dox_type">Object</span><span>- - packet object</span></div><div class="dox_tag_detail"><span>callback </span><span class="dox_type">Function</span><span>- - function to handle encodings (likely engine.write)</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Calls</span><span>callback with Array of encodings</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Encoder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">encode</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">callback</span><span class="p">){</span>
  <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;encoding packet %j&#39;</span><span class="p">,</span> <span class="nx">obj</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">exports</span><span class="p">.</span><span class="nx">BINARY_EVENT</span> <span class="o">==</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">type</span> <span class="o">||</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">BINARY_ACK</span> <span class="o">==</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">encodeAsBinary</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">encoding</span> <span class="o">=</span> <span class="nx">encodeAsString</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
    <span class="nx">callback</span><span class="p">([</span><span class="nx">encoding</span><span class="p">]);</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-440"><td class="docs"><div class="pilwrap"><a href="#section-440" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Encode packet as string.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>packet </span><span class="dox_type">Object</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">String</span><span>encoded</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">encodeAsString</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">nsp</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></pre></div></td></tr><tr id="section-441"><td class="docs"><div class="pilwrap"><a href="#section-441" class="pilcrow">&#182;</a></div><p>first is type</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">str</span> <span class="o">+=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span></pre></div></td></tr><tr id="section-442"><td class="docs"><div class="pilwrap"><a href="#section-442" class="pilcrow">&#182;</a></div><p>attachments if we have them</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">exports</span><span class="p">.</span><span class="nx">BINARY_EVENT</span> <span class="o">==</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">type</span> <span class="o">||</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">BINARY_ACK</span> <span class="o">==</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">str</span> <span class="o">+=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">attachments</span><span class="p">;</span>
    <span class="nx">str</span> <span class="o">+=</span> <span class="s1">&#39;-&#39;</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-443"><td class="docs"><div class="pilwrap"><a href="#section-443" class="pilcrow">&#182;</a></div><p>if we have a namespace other than <code>/</code>
we append it followed by a comma <code>,</code></p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">nsp</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;/&#39;</span> <span class="o">!=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">nsp</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">nsp</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">str</span> <span class="o">+=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">nsp</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-444"><td class="docs"><div class="pilwrap"><a href="#section-444" class="pilcrow">&#182;</a></div><p>immediately followed by the id</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">nsp</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">str</span> <span class="o">+=</span> <span class="s1">&#39;,&#39;</span><span class="p">;</span>
      <span class="nx">nsp</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">str</span> <span class="o">+=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-445"><td class="docs"><div class="pilwrap"><a href="#section-445" class="pilcrow">&#182;</a></div><p>json data</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">nsp</span><span class="p">)</span> <span class="nx">str</span> <span class="o">+=</span> <span class="s1">&#39;,&#39;</span><span class="p">;</span>
    <span class="nx">str</span> <span class="o">+=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;encoded %j as %s&#39;</span><span class="p">,</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">str</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">str</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-446"><td class="docs"><div class="pilwrap"><a href="#section-446" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Encode packet as 'buffer sequence' by removing blobs, and<br />deconstructing packet into object with placeholders and<br />a list of buffers.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>packet </span><span class="dox_type">Object</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Buffer</span><span>encoded</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">encodeAsBinary</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>

  <span class="kd">function</span> <span class="nx">writeEncoding</span><span class="p">(</span><span class="nx">bloblessData</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">deconstruction</span> <span class="o">=</span> <span class="nx">binary</span><span class="p">.</span><span class="nx">deconstructPacket</span><span class="p">(</span><span class="nx">bloblessData</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">pack</span> <span class="o">=</span> <span class="nx">encodeAsString</span><span class="p">(</span><span class="nx">deconstruction</span><span class="p">.</span><span class="nx">packet</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">buffers</span> <span class="o">=</span> <span class="nx">deconstruction</span><span class="p">.</span><span class="nx">buffers</span><span class="p">;</span>

    <span class="nx">buffers</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">pack</span><span class="p">);</span> <span class="c1">// add packet info to beginning of data list</span>
    <span class="nx">callback</span><span class="p">(</span><span class="nx">buffers</span><span class="p">);</span> <span class="c1">// write all the buffers</span>
  <span class="p">}</span>

  <span class="nx">binary</span><span class="p">.</span><span class="nx">removeBlobs</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">writeEncoding</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-447"><td class="docs"><div class="pilwrap"><a href="#section-447" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>A socket.io Decoder instance</p></div><div class="details"><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Object</span><span>decoder</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">Decoder</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">reconstructor</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-448"><td class="docs"><div class="pilwrap"><a href="#section-448" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Mix in <code>Emitter</code> with Decoder.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Emitter</span><span class="p">(</span><span class="nx">Decoder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span></pre></div></td></tr><tr id="section-449"><td class="docs"><div class="pilwrap"><a href="#section-449" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Decodes an ecoded packet string into packet JSON.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>obj </span><span class="dox_type">String</span><span>- - encoded packet</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Object</span><span>packet</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Decoder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">add</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">packet</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">==</span> <span class="k">typeof</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">packet</span> <span class="o">=</span> <span class="nx">decodeString</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">exports</span><span class="p">.</span><span class="nx">BINARY_EVENT</span> <span class="o">==</span> <span class="nx">packet</span><span class="p">.</span><span class="nx">type</span> <span class="o">||</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">BINARY_ACK</span> <span class="o">==</span> <span class="nx">packet</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// binary packet&#39;s json</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">reconstructor</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BinaryReconstructor</span><span class="p">(</span><span class="nx">packet</span><span class="p">);</span></pre></div></td></tr><tr id="section-450"><td class="docs"><div class="pilwrap"><a href="#section-450" class="pilcrow">&#182;</a></div><p>no attachments, labeled binary but no binary data to follow</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">reconstructor</span><span class="p">.</span><span class="nx">reconPack</span><span class="p">.</span><span class="nx">attachments</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;decoded&#39;</span><span class="p">,</span> <span class="nx">packet</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// non-binary full packet</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;decoded&#39;</span><span class="p">,</span> <span class="nx">packet</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isBuf</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">||</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">base64</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// raw binary data</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">reconstructor</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;got binary data when not reconstructing a packet&#39;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">packet</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">reconstructor</span><span class="p">.</span><span class="nx">takeBinaryData</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">packet</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// received final buffer</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">reconstructor</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;decoded&#39;</span><span class="p">,</span> <span class="nx">packet</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Unknown type: &#39;</span> <span class="o">+</span> <span class="nx">obj</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-451"><td class="docs"><div class="pilwrap"><a href="#section-451" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Decode a packet String (JSON data)</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>str </span><span class="dox_type">String</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">Object</span><span>packet</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">decodeString</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr><tr id="section-452"><td class="docs"><div class="pilwrap"><a href="#section-452" class="pilcrow">&#182;</a></div><p>look up type</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">p</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">str</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">==</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">types</span><span class="p">[</span><span class="nx">p</span><span class="p">.</span><span class="nx">type</span><span class="p">])</span> <span class="k">return</span> <span class="nx">error</span><span class="p">();</span></pre></div></td></tr><tr id="section-453"><td class="docs"><div class="pilwrap"><a href="#section-453" class="pilcrow">&#182;</a></div><p>look up attachments if type binary</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">exports</span><span class="p">.</span><span class="nx">BINARY_EVENT</span> <span class="o">==</span> <span class="nx">p</span><span class="p">.</span><span class="nx">type</span> <span class="o">||</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">BINARY_ACK</span> <span class="o">==</span> <span class="nx">p</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">buf</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">str</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">buf</span> <span class="o">+=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="nx">str</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">buf</span> <span class="o">!=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span> <span class="o">||</span> <span class="nx">str</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Illegal attachments&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">p</span><span class="p">.</span><span class="nx">attachments</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-454"><td class="docs"><div class="pilwrap"><a href="#section-454" class="pilcrow">&#182;</a></div><p>look up namespace (if any)</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;/&#39;</span> <span class="o">==</span> <span class="nx">str</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">p</span><span class="p">.</span><span class="nx">nsp</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;,&#39;</span> <span class="o">==</span> <span class="nx">c</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
      <span class="nx">p</span><span class="p">.</span><span class="nx">nsp</span> <span class="o">+=</span> <span class="nx">c</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="nx">str</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">p</span><span class="p">.</span><span class="nx">nsp</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-455"><td class="docs"><div class="pilwrap"><a href="#section-455" class="pilcrow">&#182;</a></div><p>look up id</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">next</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;&#39;</span> <span class="o">!==</span> <span class="nx">next</span> <span class="o">&amp;&amp;</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="o">==</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">p</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">==</span> <span class="nx">c</span> <span class="o">||</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="o">!=</span> <span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">--</span><span class="nx">i</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">p</span><span class="p">.</span><span class="nx">id</span> <span class="o">+=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="nx">str</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">p</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-456"><td class="docs"><div class="pilwrap"><a href="#section-456" class="pilcrow">&#182;</a></div><p>look up json data</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">str</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="o">++</span><span class="nx">i</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">p</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">str</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">i</span><span class="p">));</span>
    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
      <span class="k">return</span> <span class="nx">error</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;decoded %s as %j&#39;</span><span class="p">,</span> <span class="nx">str</span><span class="p">,</span> <span class="nx">p</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">p</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-457"><td class="docs"><div class="pilwrap"><a href="#section-457" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Deallocates a parser's resources</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">public</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Decoder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">destroy</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">reconstructor</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">reconstructor</span><span class="p">.</span><span class="nx">finishedReconstruction</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-458"><td class="docs"><div class="pilwrap"><a href="#section-458" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>A manager of a binary event's 'buffer sequence'. Should<br />be constructed whenever a packet of type BINARY_EVENT is<br />decoded.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>packet </span><span class="dox_type">Object</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">BinaryReconstructor</span><span>initialized reconstructor</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">BinaryReconstructor</span><span class="p">(</span><span class="nx">packet</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">reconPack</span> <span class="o">=</span> <span class="nx">packet</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">buffers</span> <span class="o">=</span> <span class="p">[];</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-459"><td class="docs"><div class="pilwrap"><a href="#section-459" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Method to be called when binary data received from connection<br />after a BINARY_EVENT packet.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>| </span><span class="dox_type">Buffer</span><span>- ArrayBuffer} binData - the raw binary data received</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">null</span><span>| Object} returns null if more binary data is expected or</span></div><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">BinaryReconstructor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">takeBinaryData</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">binData</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">buffers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">binData</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">buffers</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">reconPack</span><span class="p">.</span><span class="nx">attachments</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// done with buffer list</span>
    <span class="kd">var</span> <span class="nx">packet</span> <span class="o">=</span> <span class="nx">binary</span><span class="p">.</span><span class="nx">reconstructPacket</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">reconPack</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">buffers</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">finishedReconstruction</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">packet</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-460"><td class="docs"><div class="pilwrap"><a href="#section-460" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Cleans up binary packet reconstruction variables.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">BinaryReconstructor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">finishedReconstruction</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">reconPack</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">buffers</span> <span class="o">=</span> <span class="p">[];</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">error</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">type</span><span class="o">:</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">ERROR</span><span class="p">,</span>
    <span class="nx">data</span><span class="o">:</span> <span class="s1">&#39;parser error&#39;</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="p">},{</span><span class="s2">&quot;./binary&quot;</span><span class="o">:</span><span class="mi">45</span><span class="p">,</span><span class="s2">&quot;./is-buffer&quot;</span><span class="o">:</span><span class="mi">47</span><span class="p">,</span><span class="s2">&quot;component-emitter&quot;</span><span class="o">:</span><span class="mi">9</span><span class="p">,</span><span class="s2">&quot;debug&quot;</span><span class="o">:</span><span class="mi">10</span><span class="p">,</span><span class="s2">&quot;isarray&quot;</span><span class="o">:</span><span class="mi">48</span><span class="p">,</span><span class="s2">&quot;json3&quot;</span><span class="o">:</span><span class="mi">49</span><span class="p">}],</span><span class="mi">47</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span>
<span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">global</span><span class="p">){</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">isBuf</span><span class="p">;</span></pre></div></td></tr><tr id="section-461"><td class="docs"><div class="pilwrap"><a href="#section-461" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Returns true if obj is a buffer or an arraybuffer.</p></div><div class="details"><div class="dox_tag_title">API</div><div class="dox_tag_detail"><span class="dox_type">private</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">isBuf</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">Buffer</span> <span class="o">&amp;&amp;</span> <span class="nx">global</span><span class="p">.</span><span class="nx">Buffer</span><span class="p">.</span><span class="nx">isBuffer</span><span class="p">(</span><span class="nx">obj</span><span class="p">))</span> <span class="o">||</span>
         <span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">ArrayBuffer</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span> <span class="k">instanceof</span> <span class="nx">ArrayBuffer</span><span class="p">);</span>
<span class="p">}</span>

<span class="p">}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="k">typeof</span> <span class="nx">self</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span> <span class="o">?</span> <span class="nx">self</span> <span class="o">:</span> <span class="k">typeof</span> <span class="nb">window</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span> <span class="o">?</span> <span class="nb">window</span> <span class="o">:</span> <span class="p">{})</span>
<span class="p">},{}],</span><span class="mi">48</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
<span class="p">},{}],</span><span class="mi">49</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span></pre></div></td></tr><tr id="section-462"><td class="docs"><div class="pilwrap"><a href="#section-462" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>JSON v3.2.6 | <a href='http://bestiejs.github.io/json3'>http://bestiejs.github.io/json3</a> | Copyright 2012-2013, Kit Cambridge | <a href='http://kit.mit-license.org'>http://kit.mit-license.org</a></p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="p">;(</span><span class="kd">function</span> <span class="p">(</span><span class="nb">window</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-463"><td class="docs"><div class="pilwrap"><a href="#section-463" class="pilcrow">&#182;</a></div><p>Convenience aliases.</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">getClass</span> <span class="o">=</span> <span class="p">{}.</span><span class="nx">toString</span><span class="p">,</span> <span class="nx">isProperty</span><span class="p">,</span> <span class="nx">forEach</span><span class="p">,</span> <span class="nx">undef</span><span class="p">;</span></pre></div></td></tr><tr id="section-464"><td class="docs"><div class="pilwrap"><a href="#section-464" class="pilcrow">&#182;</a></div><p>Detect the <code>define</code> function exposed by asynchronous module loaders. The
strict <code>define</code> check is necessary for compatibility with <code>r.js</code>.</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">isLoader</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">define</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">define</span><span class="p">.</span><span class="nx">amd</span><span class="p">;</span></pre></div></td></tr><tr id="section-465"><td class="docs"><div class="pilwrap"><a href="#section-465" class="pilcrow">&#182;</a></div><p>Detect native implementations.</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">nativeJSON</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">JSON</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">JSON</span><span class="p">;</span></pre></div></td></tr><tr id="section-466"><td class="docs"><div class="pilwrap"><a href="#section-466" class="pilcrow">&#182;</a></div><p>Set up the JSON 3 namespace, preferring the CommonJS <code>exports</code> object if
available.</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">JSON3</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">exports</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">exports</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">exports</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">&amp;&amp;</span> <span class="nx">exports</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">JSON3</span> <span class="o">&amp;&amp;</span> <span class="nx">nativeJSON</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-467"><td class="docs"><div class="pilwrap"><a href="#section-467" class="pilcrow">&#182;</a></div><p>Explicitly delegate to the native <code>stringify</code> and <code>parse</code>
implementations in CommonJS environments.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">JSON3</span><span class="p">.</span><span class="nx">stringify</span> <span class="o">=</span> <span class="nx">nativeJSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">;</span>
    <span class="nx">JSON3</span><span class="p">.</span><span class="nx">parse</span> <span class="o">=</span> <span class="nx">nativeJSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr><tr id="section-468"><td class="docs"><div class="pilwrap"><a href="#section-468" class="pilcrow">&#182;</a></div><p>Export for web browsers, JavaScript engines, and asynchronous module
loaders, using the global <code>JSON</code> object if available.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">JSON3</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">JSON</span> <span class="o">=</span> <span class="nx">nativeJSON</span> <span class="o">||</span> <span class="p">{};</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-469"><td class="docs"><div class="pilwrap"><a href="#section-469" class="pilcrow">&#182;</a></div><p>Test the <code>Date#getUTC*</code> methods. Based on work by @Yaffle.</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">isExtended</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="o">-</span><span class="mi">3509827334573292</span><span class="p">);</span>
  <span class="k">try</span> <span class="p">{</span></pre></div></td></tr><tr id="section-470"><td class="docs"><div class="pilwrap"><a href="#section-470" class="pilcrow">&#182;</a></div><p>The <code>getUTCFullYear</code>, <code>Month</code>, and <code>Date</code> methods return nonsensical
results for certain dates in Opera >= 10.53.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">isExtended</span> <span class="o">=</span> <span class="nx">isExtended</span><span class="p">.</span><span class="nx">getUTCFullYear</span><span class="p">()</span> <span class="o">==</span> <span class="o">-</span><span class="mi">109252</span> <span class="o">&amp;&amp;</span> <span class="nx">isExtended</span><span class="p">.</span><span class="nx">getUTCMonth</span><span class="p">()</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">isExtended</span><span class="p">.</span><span class="nx">getUTCDate</span><span class="p">()</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span></pre></div></td></tr><tr id="section-471"><td class="docs"><div class="pilwrap"><a href="#section-471" class="pilcrow">&#182;</a></div><p>Safari &lt; 2.0.2 stores the internal millisecond time value correctly,
but clips the values returned by the date methods to the range of
signed 32-bit integers ([-2 <em>* 31, 2 *</em> 31 - 1]).</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">isExtended</span><span class="p">.</span><span class="nx">getUTCHours</span><span class="p">()</span> <span class="o">==</span> <span class="mi">10</span> <span class="o">&amp;&amp;</span> <span class="nx">isExtended</span><span class="p">.</span><span class="nx">getUTCMinutes</span><span class="p">()</span> <span class="o">==</span> <span class="mi">37</span> <span class="o">&amp;&amp;</span> <span class="nx">isExtended</span><span class="p">.</span><span class="nx">getUTCSeconds</span><span class="p">()</span> <span class="o">==</span> <span class="mi">6</span> <span class="o">&amp;&amp;</span> <span class="nx">isExtended</span><span class="p">.</span><span class="nx">getUTCMilliseconds</span><span class="p">()</span> <span class="o">==</span> <span class="mi">708</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">exception</span><span class="p">)</span> <span class="p">{}</span></pre></div></td></tr><tr id="section-472"><td class="docs"><div class="pilwrap"><a href="#section-472" class="pilcrow">&#182;</a></div><p>Internal: Determines whether the native <code>JSON.stringify</code> and <code>parse</code>
implementations are spec-compliant. Based on work by Ken Snyder.</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">has</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">has</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">!==</span> <span class="nx">undef</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-473"><td class="docs"><div class="pilwrap"><a href="#section-473" class="pilcrow">&#182;</a></div><p>Return cached feature test result.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">return</span> <span class="nx">has</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">isSupported</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;bug-string-char-index&quot;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-474"><td class="docs"><div class="pilwrap"><a href="#section-474" class="pilcrow">&#182;</a></div><p>IE &lt;= 7 doesn't support accessing string characters using square
bracket notation. IE 8 only supports this for primitives.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">isSupported</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;a&quot;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;json&quot;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-475"><td class="docs"><div class="pilwrap"><a href="#section-475" class="pilcrow">&#182;</a></div><p>Indicates whether both <code>JSON.stringify</code> and <code>JSON.parse</code> are
supported.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">isSupported</span> <span class="o">=</span> <span class="nx">has</span><span class="p">(</span><span class="s2">&quot;json-stringify&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">has</span><span class="p">(</span><span class="s2">&quot;json-parse&quot;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">serialized</span> <span class="o">=</span> <span class="s1">&#39;{&quot;a&quot;:[1,true,false,null,&quot;\\u0000\\b\\n\\f\\r\\t&quot;]}&#39;</span><span class="p">;</span></pre></div></td></tr><tr id="section-476"><td class="docs"><div class="pilwrap"><a href="#section-476" class="pilcrow">&#182;</a></div><p>Test <code>JSON.stringify</code>.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;json-stringify&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">stringify</span> <span class="o">=</span> <span class="nx">JSON3</span><span class="p">.</span><span class="nx">stringify</span><span class="p">,</span> <span class="nx">stringifySupported</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">stringify</span> <span class="o">==</span> <span class="s2">&quot;function&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">isExtended</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">stringifySupported</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-477"><td class="docs"><div class="pilwrap"><a href="#section-477" class="pilcrow">&#182;</a></div><p>A test function object with a custom <code>toJSON</code> method.</p>
</td><td class="code"><div class="highlight"><pre>          <span class="p">(</span><span class="nx">value</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
          <span class="p">}).</span><span class="nx">toJSON</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
          <span class="k">try</span> <span class="p">{</span>
            <span class="nx">stringifySupported</span> <span class="o">=</span></pre></div></td></tr><tr id="section-478"><td class="docs"><div class="pilwrap"><a href="#section-478" class="pilcrow">&#182;</a></div><p>Firefox 3.1b1 and b2 serialize string, number, and boolean
primitives as object literals.</p>
</td><td class="code"><div class="highlight"><pre>              <span class="nx">stringify</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">===</span> <span class="s2">&quot;0&quot;</span> <span class="o">&amp;&amp;</span></pre></div></td></tr><tr id="section-479"><td class="docs"><div class="pilwrap"><a href="#section-479" class="pilcrow">&#182;</a></div><p>FF 3.1b1, b2, and JSON 2 serialize wrapped primitives as object
literals.</p>
</td><td class="code"><div class="highlight"><pre>              <span class="nx">stringify</span><span class="p">(</span><span class="k">new</span> <span class="nb">Number</span><span class="p">())</span> <span class="o">===</span> <span class="s2">&quot;0&quot;</span> <span class="o">&amp;&amp;</span>
              <span class="nx">stringify</span><span class="p">(</span><span class="k">new</span> <span class="nb">String</span><span class="p">())</span> <span class="o">==</span> <span class="s1">&#39;&quot;&quot;&#39;</span> <span class="o">&amp;&amp;</span></pre></div></td></tr><tr id="section-480"><td class="docs"><div class="pilwrap"><a href="#section-480" class="pilcrow">&#182;</a></div><p>FF 3.1b1, 2 throw an error if the value is <code>null</code>, <code>undefined</code>, or
does not define a canonical JSON representation (this applies to
objects with <code>toJSON</code> properties as well, <em>unless</em> they are nested
within an object or array).</p>
</td><td class="code"><div class="highlight"><pre>              <span class="nx">stringify</span><span class="p">(</span><span class="nx">getClass</span><span class="p">)</span> <span class="o">===</span> <span class="nx">undef</span> <span class="o">&amp;&amp;</span></pre></div></td></tr><tr id="section-481"><td class="docs"><div class="pilwrap"><a href="#section-481" class="pilcrow">&#182;</a></div><p>IE 8 serializes <code>undefined</code> as <code>"undefined"</code>. Safari &lt;= 5.1.7 and
FF 3.1b3 pass this test.</p>
</td><td class="code"><div class="highlight"><pre>              <span class="nx">stringify</span><span class="p">(</span><span class="nx">undef</span><span class="p">)</span> <span class="o">===</span> <span class="nx">undef</span> <span class="o">&amp;&amp;</span></pre></div></td></tr><tr id="section-482"><td class="docs"><div class="pilwrap"><a href="#section-482" class="pilcrow">&#182;</a></div><p>Safari &lt;= 5.1.7 and FF 3.1b3 throw <code>Error</code>s and <code>TypeError</code>s,
respectively, if the value is omitted entirely.</p>
</td><td class="code"><div class="highlight"><pre>              <span class="nx">stringify</span><span class="p">()</span> <span class="o">===</span> <span class="nx">undef</span> <span class="o">&amp;&amp;</span></pre></div></td></tr><tr id="section-483"><td class="docs"><div class="pilwrap"><a href="#section-483" class="pilcrow">&#182;</a></div><p>FF 3.1b1, 2 throw an error if the given value is not a number,
string, array, object, Boolean, or <code>null</code> literal. This applies to
objects with custom <code>toJSON</code> methods as well, unless they are nested
inside object or array literals. YUI 3.0.0b1 ignores custom <code>toJSON</code>
methods entirely.</p>
</td><td class="code"><div class="highlight"><pre>              <span class="nx">stringify</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">===</span> <span class="s2">&quot;1&quot;</span> <span class="o">&amp;&amp;</span>
              <span class="nx">stringify</span><span class="p">([</span><span class="nx">value</span><span class="p">])</span> <span class="o">==</span> <span class="s2">&quot;[1]&quot;</span> <span class="o">&amp;&amp;</span></pre></div></td></tr><tr id="section-484"><td class="docs"><div class="pilwrap"><a href="#section-484" class="pilcrow">&#182;</a></div><p>Prototype &lt;= 1.6.1 serializes <code>[undefined]</code> as <code>"[]"</code> instead of
<code>"[null]"</code>.</p>
</td><td class="code"><div class="highlight"><pre>              <span class="nx">stringify</span><span class="p">([</span><span class="nx">undef</span><span class="p">])</span> <span class="o">==</span> <span class="s2">&quot;[null]&quot;</span> <span class="o">&amp;&amp;</span></pre></div></td></tr><tr id="section-485"><td class="docs"><div class="pilwrap"><a href="#section-485" class="pilcrow">&#182;</a></div><p>YUI 3.0.0b1 fails to serialize <code>null</code> literals.</p>
</td><td class="code"><div class="highlight"><pre>              <span class="nx">stringify</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;null&quot;</span> <span class="o">&amp;&amp;</span></pre></div></td></tr><tr id="section-486"><td class="docs"><div class="pilwrap"><a href="#section-486" class="pilcrow">&#182;</a></div><p>FF 3.1b1, 2 halts serialization if an array contains a function:
<code>[1, true, getClass, 1]</code> serializes as "[1,true,],". FF 3.1b3
elides non-JSON values from objects and arrays, unless they
define custom <code>toJSON</code> methods.</p>
</td><td class="code"><div class="highlight"><pre>              <span class="nx">stringify</span><span class="p">([</span><span class="nx">undef</span><span class="p">,</span> <span class="nx">getClass</span><span class="p">,</span> <span class="kc">null</span><span class="p">])</span> <span class="o">==</span> <span class="s2">&quot;[null,null,null]&quot;</span> <span class="o">&amp;&amp;</span></pre></div></td></tr><tr id="section-487"><td class="docs"><div class="pilwrap"><a href="#section-487" class="pilcrow">&#182;</a></div><p>Simple serialization test. FF 3.1b1 uses Unicode escape sequences
where character escape codes are expected (e.g., <code>\b</code> => <code>\u0008</code>).</p>
</td><td class="code"><div class="highlight"><pre>              <span class="nx">stringify</span><span class="p">({</span> <span class="s2">&quot;a&quot;</span><span class="o">:</span> <span class="p">[</span><span class="nx">value</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;\x00\b\n\f\r\t&quot;</span><span class="p">]</span> <span class="p">})</span> <span class="o">==</span> <span class="nx">serialized</span> <span class="o">&amp;&amp;</span></pre></div></td></tr><tr id="section-488"><td class="docs"><div class="pilwrap"><a href="#section-488" class="pilcrow">&#182;</a></div><p>FF 3.1b1 and b2 ignore the <code>filter</code> and <code>width</code> arguments.</p>
</td><td class="code"><div class="highlight"><pre>              <span class="nx">stringify</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="o">===</span> <span class="s2">&quot;1&quot;</span> <span class="o">&amp;&amp;</span>
              <span class="nx">stringify</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;[\n 1,\n 2\n]&quot;</span> <span class="o">&amp;&amp;</span></pre></div></td></tr><tr id="section-489"><td class="docs"><div class="pilwrap"><a href="#section-489" class="pilcrow">&#182;</a></div><p>JSON 2, Prototype &lt;= 1.7, and older WebKit builds incorrectly
serialize extended years.</p>
</td><td class="code"><div class="highlight"><pre>              <span class="nx">stringify</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="o">-</span><span class="mf">8.64e15</span><span class="p">))</span> <span class="o">==</span> <span class="s1">&#39;&quot;-271821-04-20T00:00:00.000Z&quot;&#39;</span> <span class="o">&amp;&amp;</span></pre></div></td></tr><tr id="section-490"><td class="docs"><div class="pilwrap"><a href="#section-490" class="pilcrow">&#182;</a></div><p>The milliseconds are optional in ES 5, but required in 5.1.</p>
</td><td class="code"><div class="highlight"><pre>              <span class="nx">stringify</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="mf">8.64e15</span><span class="p">))</span> <span class="o">==</span> <span class="s1">&#39;&quot;+275760-09-13T00:00:00.000Z&quot;&#39;</span> <span class="o">&amp;&amp;</span></pre></div></td></tr><tr id="section-491"><td class="docs"><div class="pilwrap"><a href="#section-491" class="pilcrow">&#182;</a></div><p>Firefox &lt;= 11.0 incorrectly serializes years prior to 0 as negative
four-digit years instead of six-digit years. Credits: @Yaffle.</p>
</td><td class="code"><div class="highlight"><pre>              <span class="nx">stringify</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="o">-</span><span class="mi">621987552</span><span class="nx">e5</span><span class="p">))</span> <span class="o">==</span> <span class="s1">&#39;&quot;-000001-01-01T00:00:00.000Z&quot;&#39;</span> <span class="o">&amp;&amp;</span></pre></div></td></tr><tr id="section-492"><td class="docs"><div class="pilwrap"><a href="#section-492" class="pilcrow">&#182;</a></div><p>Safari &lt;= 5.1.5 and Opera >= 10.53 incorrectly serialize millisecond
values less than 1000. Credits: @Yaffle.</p>
</td><td class="code"><div class="highlight"><pre>              <span class="nx">stringify</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="s1">&#39;&quot;1969-12-31T23:59:59.999Z&quot;&#39;</span><span class="p">;</span>
          <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">exception</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">stringifySupported</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">isSupported</span> <span class="o">=</span> <span class="nx">stringifySupported</span><span class="p">;</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-493"><td class="docs"><div class="pilwrap"><a href="#section-493" class="pilcrow">&#182;</a></div><p>Test <code>JSON.parse</code>.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;json-parse&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">parse</span> <span class="o">=</span> <span class="nx">JSON3</span><span class="p">.</span><span class="nx">parse</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">parse</span> <span class="o">==</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">try</span> <span class="p">{</span></pre></div></td></tr><tr id="section-494"><td class="docs"><div class="pilwrap"><a href="#section-494" class="pilcrow">&#182;</a></div><p>FF 3.1b1, b2 will throw an exception if a bare literal is provided.
Conforming implementations should also coerce the initial argument to
a string prior to parsing.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="nx">parse</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">parse</span><span class="p">(</span><span class="kc">false</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr><tr id="section-495"><td class="docs"><div class="pilwrap"><a href="#section-495" class="pilcrow">&#182;</a></div><p>Simple parsing test.</p>
</td><td class="code"><div class="highlight"><pre>              <span class="nx">value</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">serialized</span><span class="p">);</span>
              <span class="kd">var</span> <span class="nx">parseSupported</span> <span class="o">=</span> <span class="nx">value</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">].</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span> <span class="nx">value</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="mi">1</span><span class="p">;</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">parseSupported</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">try</span> <span class="p">{</span></pre></div></td></tr><tr id="section-496"><td class="docs"><div class="pilwrap"><a href="#section-496" class="pilcrow">&#182;</a></div><p>Safari &lt;= 5.1.2 and FF 3.1b1 allow unescaped tabs in strings.</p>
</td><td class="code"><div class="highlight"><pre>                  <span class="nx">parseSupported</span> <span class="o">=</span> <span class="o">!</span><span class="nx">parse</span><span class="p">(</span><span class="s1">&#39;&quot;\t&quot;&#39;</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">exception</span><span class="p">)</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">parseSupported</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">try</span> <span class="p">{</span></pre></div></td></tr><tr id="section-497"><td class="docs"><div class="pilwrap"><a href="#section-497" class="pilcrow">&#182;</a></div><p>FF 4.0 and 4.0.1 allow leading <code>+</code> signs and leading
decimal points. FF 4.0, 4.0.1, and IE 9-10 also allow
certain octal literals.</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="nx">parseSupported</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="s2">&quot;01&quot;</span><span class="p">)</span> <span class="o">!==</span> <span class="mi">1</span><span class="p">;</span>
                  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">exception</span><span class="p">)</span> <span class="p">{}</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">parseSupported</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">try</span> <span class="p">{</span></pre></div></td></tr><tr id="section-498"><td class="docs"><div class="pilwrap"><a href="#section-498" class="pilcrow">&#182;</a></div><p>FF 4.0, 4.0.1, and Rhino 1.7R3-R4 allow trailing decimal
points. These environments, along with FF 3.1b1 and 2,
also allow trailing commas in JSON objects and arrays.</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="nx">parseSupported</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="s2">&quot;1.&quot;</span><span class="p">)</span> <span class="o">!==</span> <span class="mi">1</span><span class="p">;</span>
                  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">exception</span><span class="p">)</span> <span class="p">{}</span>
                <span class="p">}</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">exception</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">parseSupported</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">isSupported</span> <span class="o">=</span> <span class="nx">parseSupported</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">has</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="o">!!</span><span class="nx">isSupported</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">has</span><span class="p">(</span><span class="s2">&quot;json&quot;</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr><tr id="section-499"><td class="docs"><div class="pilwrap"><a href="#section-499" class="pilcrow">&#182;</a></div><p>Common <code>[[Class]]</code> name aliases.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">functionClass</span> <span class="o">=</span> <span class="s2">&quot;[object Function]&quot;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">dateClass</span> <span class="o">=</span> <span class="s2">&quot;[object Date]&quot;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">numberClass</span> <span class="o">=</span> <span class="s2">&quot;[object Number]&quot;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">stringClass</span> <span class="o">=</span> <span class="s2">&quot;[object String]&quot;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">arrayClass</span> <span class="o">=</span> <span class="s2">&quot;[object Array]&quot;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">booleanClass</span> <span class="o">=</span> <span class="s2">&quot;[object Boolean]&quot;</span><span class="p">;</span></pre></div></td></tr><tr id="section-500"><td class="docs"><div class="pilwrap"><a href="#section-500" class="pilcrow">&#182;</a></div><p>Detect incomplete support for accessing string characters by index.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">charIndexBuggy</span> <span class="o">=</span> <span class="nx">has</span><span class="p">(</span><span class="s2">&quot;bug-string-char-index&quot;</span><span class="p">);</span></pre></div></td></tr><tr id="section-501"><td class="docs"><div class="pilwrap"><a href="#section-501" class="pilcrow">&#182;</a></div><p>Define additional utility methods if the <code>Date</code> methods are buggy.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isExtended</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">floor</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">;</span></pre></div></td></tr><tr id="section-502"><td class="docs"><div class="pilwrap"><a href="#section-502" class="pilcrow">&#182;</a></div><p>A mapping between the months of the year and the number of days between
January 1st and the first of the respective month.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">Months</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">151</span><span class="p">,</span> <span class="mi">181</span><span class="p">,</span> <span class="mi">212</span><span class="p">,</span> <span class="mi">243</span><span class="p">,</span> <span class="mi">273</span><span class="p">,</span> <span class="mi">304</span><span class="p">,</span> <span class="mi">334</span><span class="p">];</span></pre></div></td></tr><tr id="section-503"><td class="docs"><div class="pilwrap"><a href="#section-503" class="pilcrow">&#182;</a></div><p>Internal: Calculates the number of days between the Unix epoch and the
first day of the given month.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">getDay</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">year</span><span class="p">,</span> <span class="nx">month</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">Months</span><span class="p">[</span><span class="nx">month</span><span class="p">]</span> <span class="o">+</span> <span class="mi">365</span> <span class="o">*</span> <span class="p">(</span><span class="nx">year</span> <span class="o">-</span> <span class="mi">1970</span><span class="p">)</span> <span class="o">+</span> <span class="nx">floor</span><span class="p">((</span><span class="nx">year</span> <span class="o">-</span> <span class="mi">1969</span> <span class="o">+</span> <span class="p">(</span><span class="nx">month</span> <span class="o">=</span> <span class="o">+</span><span class="p">(</span><span class="nx">month</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)))</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="nx">floor</span><span class="p">((</span><span class="nx">year</span> <span class="o">-</span> <span class="mi">1901</span> <span class="o">+</span> <span class="nx">month</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">+</span> <span class="nx">floor</span><span class="p">((</span><span class="nx">year</span> <span class="o">-</span> <span class="mi">1601</span> <span class="o">+</span> <span class="nx">month</span><span class="p">)</span> <span class="o">/</span> <span class="mi">400</span><span class="p">);</span>
      <span class="p">};</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-504"><td class="docs"><div class="pilwrap"><a href="#section-504" class="pilcrow">&#182;</a></div><p>Internal: Determines if a property is a direct property of the given
object. Delegates to the native <code>Object#hasOwnProperty</code> method.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">isProperty</span> <span class="o">=</span> <span class="p">{}.</span><span class="nx">hasOwnProperty</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">isProperty</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">property</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">members</span> <span class="o">=</span> <span class="p">{},</span> <span class="nx">constructor</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">((</span><span class="nx">members</span><span class="p">.</span><span class="nx">__proto__</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">members</span><span class="p">.</span><span class="nx">__proto__</span> <span class="o">=</span> <span class="p">{</span></pre></div></td></tr><tr id="section-505"><td class="docs"><div class="pilwrap"><a href="#section-505" class="pilcrow">&#182;</a></div><p>The <em>proto</em> property cannot be set multiple times in recent
versions of Firefox and SeaMonkey.</p>
</td><td class="code"><div class="highlight"><pre>          <span class="s2">&quot;toString&quot;</span><span class="o">:</span> <span class="mi">1</span>
        <span class="p">},</span> <span class="nx">members</span><span class="p">).</span><span class="nx">toString</span> <span class="o">!=</span> <span class="nx">getClass</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-506"><td class="docs"><div class="pilwrap"><a href="#section-506" class="pilcrow">&#182;</a></div><p>Safari &lt;= 2.0.3 doesn't implement <code>Object#hasOwnProperty</code>, but
supports the mutable <em>proto</em> property.</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nx">isProperty</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">property</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-507"><td class="docs"><div class="pilwrap"><a href="#section-507" class="pilcrow">&#182;</a></div><p>Capture and break the object's prototype chain (see section 8.6.2
of the ES 5.1 spec). The parenthesized expression prevents an
unsafe transformation by the Closure Compiler.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="kd">var</span> <span class="nx">original</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">__proto__</span><span class="p">,</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">property</span> <span class="k">in</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">__proto__</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span></pre></div></td></tr><tr id="section-508"><td class="docs"><div class="pilwrap"><a href="#section-508" class="pilcrow">&#182;</a></div><p>Restore the original prototype chain.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">__proto__</span> <span class="o">=</span> <span class="nx">original</span><span class="p">;</span>
            <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
          <span class="p">};</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr><tr id="section-509"><td class="docs"><div class="pilwrap"><a href="#section-509" class="pilcrow">&#182;</a></div><p>Capture a reference to the top-level <code>Object</code> constructor.</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nx">constructor</span> <span class="o">=</span> <span class="nx">members</span><span class="p">.</span><span class="nx">constructor</span><span class="p">;</span></pre></div></td></tr><tr id="section-510"><td class="docs"><div class="pilwrap"><a href="#section-510" class="pilcrow">&#182;</a></div><p>Use the <code>constructor</code> property to simulate <code>Object#hasOwnProperty</code> in
other environments.</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nx">isProperty</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">property</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">parent</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">||</span> <span class="nx">constructor</span><span class="p">).</span><span class="nx">prototype</span><span class="p">;</span>
            <span class="k">return</span> <span class="nx">property</span> <span class="k">in</span> <span class="k">this</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="nx">property</span> <span class="k">in</span> <span class="nx">parent</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span> <span class="o">===</span> <span class="nx">parent</span><span class="p">[</span><span class="nx">property</span><span class="p">]);</span>
          <span class="p">};</span>
        <span class="p">}</span>
        <span class="nx">members</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">isProperty</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">property</span><span class="p">);</span>
      <span class="p">};</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-511"><td class="docs"><div class="pilwrap"><a href="#section-511" class="pilcrow">&#182;</a></div><p>Internal: A set of primitive types used by <code>isHostType</code>.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">PrimitiveTypes</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s1">&#39;boolean&#39;</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="s1">&#39;number&#39;</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="s1">&#39;string&#39;</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="s1">&#39;undefined&#39;</span><span class="o">:</span> <span class="mi">1</span>
    <span class="p">};</span></pre></div></td></tr><tr id="section-512"><td class="docs"><div class="pilwrap"><a href="#section-512" class="pilcrow">&#182;</a></div><p>Internal: Determines if the given object <code>property</code> value is a
non-primitive.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">isHostType</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="nx">property</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">object</span><span class="p">[</span><span class="nx">property</span><span class="p">];</span>
      <span class="k">return</span> <span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span> <span class="o">?</span> <span class="o">!!</span><span class="nx">object</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span> <span class="o">:</span> <span class="o">!</span><span class="nx">PrimitiveTypes</span><span class="p">[</span><span class="nx">type</span><span class="p">];</span>
    <span class="p">};</span></pre></div></td></tr><tr id="section-513"><td class="docs"><div class="pilwrap"><a href="#section-513" class="pilcrow">&#182;</a></div><p>Internal: Normalizes the <code>for...in</code> iteration algorithm across
environments. Each enumerated key is yielded to a <code>callback</code> function.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">forEach</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">Properties</span><span class="p">,</span> <span class="nx">members</span><span class="p">,</span> <span class="nx">property</span><span class="p">;</span></pre></div></td></tr><tr id="section-514"><td class="docs"><div class="pilwrap"><a href="#section-514" class="pilcrow">&#182;</a></div><p>Tests for bugs in the current environment's <code>for...in</code> algorithm. The
<code>valueOf</code> property inherits the non-enumerable flag from
<code>Object.prototype</code> in older versions of IE, Netscape, and Mozilla.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="p">(</span><span class="nx">Properties</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">valueOf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}).</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">valueOf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr><tr id="section-515"><td class="docs"><div class="pilwrap"><a href="#section-515" class="pilcrow">&#182;</a></div><p>Iterate over a new instance of the <code>Properties</code> class.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">members</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Properties</span><span class="p">();</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">property</span> <span class="k">in</span> <span class="nx">members</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-516"><td class="docs"><div class="pilwrap"><a href="#section-516" class="pilcrow">&#182;</a></div><p>Ignore all properties inherited from <code>Object.prototype</code>.</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">isProperty</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">members</span><span class="p">,</span> <span class="nx">property</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">size</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="nx">Properties</span> <span class="o">=</span> <span class="nx">members</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span></pre></div></td></tr><tr id="section-517"><td class="docs"><div class="pilwrap"><a href="#section-517" class="pilcrow">&#182;</a></div><p>Normalize the iteration algorithm.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">size</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-518"><td class="docs"><div class="pilwrap"><a href="#section-518" class="pilcrow">&#182;</a></div><p>A list of non-enumerable properties inherited from <code>Object.prototype</code>.</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nx">members</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;valueOf&quot;</span><span class="p">,</span> <span class="s2">&quot;toString&quot;</span><span class="p">,</span> <span class="s2">&quot;toLocaleString&quot;</span><span class="p">,</span> <span class="s2">&quot;propertyIsEnumerable&quot;</span><span class="p">,</span> <span class="s2">&quot;isPrototypeOf&quot;</span><span class="p">,</span> <span class="s2">&quot;hasOwnProperty&quot;</span><span class="p">,</span> <span class="s2">&quot;constructor&quot;</span><span class="p">];</span></pre></div></td></tr><tr id="section-519"><td class="docs"><div class="pilwrap"><a href="#section-519" class="pilcrow">&#182;</a></div><p>IE &lt;= 8, Mozilla 1.0, and Netscape 6.2 ignore shadowed non-enumerable
properties.</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nx">forEach</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">isFunction</span> <span class="o">=</span> <span class="nx">getClass</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="o">==</span> <span class="nx">functionClass</span><span class="p">,</span> <span class="nx">property</span><span class="p">,</span> <span class="nx">length</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">hasProperty</span> <span class="o">=</span> <span class="o">!</span><span class="nx">isFunction</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">object</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">!=</span> <span class="s1">&#39;function&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">isHostType</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="s1">&#39;hasOwnProperty&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="nx">object</span><span class="p">.</span><span class="nx">hasOwnProperty</span> <span class="o">:</span> <span class="nx">isProperty</span><span class="p">;</span>
          <span class="k">for</span> <span class="p">(</span><span class="nx">property</span> <span class="k">in</span> <span class="nx">object</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-520"><td class="docs"><div class="pilwrap"><a href="#section-520" class="pilcrow">&#182;</a></div><p>Gecko &lt;= 1.0 enumerates the <code>prototype</code> property of functions under
certain conditions; IE does not.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">isFunction</span> <span class="o">&amp;&amp;</span> <span class="nx">property</span> <span class="o">==</span> <span class="s2">&quot;prototype&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">hasProperty</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="nx">property</span><span class="p">))</span> <span class="p">{</span>
              <span class="nx">callback</span><span class="p">(</span><span class="nx">property</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">}</span></pre></div></td></tr><tr id="section-521"><td class="docs"><div class="pilwrap"><a href="#section-521" class="pilcrow">&#182;</a></div><p>Manually invoke the callback for each non-enumerable property.</p>
</td><td class="code"><div class="highlight"><pre>          <span class="k">for</span> <span class="p">(</span><span class="nx">length</span> <span class="o">=</span> <span class="nx">members</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">property</span> <span class="o">=</span> <span class="nx">members</span><span class="p">[</span><span class="o">--</span><span class="nx">length</span><span class="p">];</span> <span class="nx">hasProperty</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="nx">property</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">property</span><span class="p">));</span>
        <span class="p">};</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">size</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-522"><td class="docs"><div class="pilwrap"><a href="#section-522" class="pilcrow">&#182;</a></div><p>Safari &lt;= 2.0.4 enumerates shadowed properties twice.</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nx">forEach</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-523"><td class="docs"><div class="pilwrap"><a href="#section-523" class="pilcrow">&#182;</a></div><p>Create a set of iterated properties.</p>
</td><td class="code"><div class="highlight"><pre>          <span class="kd">var</span> <span class="nx">members</span> <span class="o">=</span> <span class="p">{},</span> <span class="nx">isFunction</span> <span class="o">=</span> <span class="nx">getClass</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="o">==</span> <span class="nx">functionClass</span><span class="p">,</span> <span class="nx">property</span><span class="p">;</span>
          <span class="k">for</span> <span class="p">(</span><span class="nx">property</span> <span class="k">in</span> <span class="nx">object</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-524"><td class="docs"><div class="pilwrap"><a href="#section-524" class="pilcrow">&#182;</a></div><p>Store each property name to prevent double enumeration. The
<code>prototype</code> property of functions is not enumerated due to cross-
environment inconsistencies.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">isFunction</span> <span class="o">&amp;&amp;</span> <span class="nx">property</span> <span class="o">==</span> <span class="s2">&quot;prototype&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isProperty</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">members</span><span class="p">,</span> <span class="nx">property</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">members</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">isProperty</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="nx">property</span><span class="p">))</span> <span class="p">{</span>
              <span class="nx">callback</span><span class="p">(</span><span class="nx">property</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">};</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr><tr id="section-525"><td class="docs"><div class="pilwrap"><a href="#section-525" class="pilcrow">&#182;</a></div><p>No bugs detected; use the standard <code>for...in</code> algorithm.</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nx">forEach</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">isFunction</span> <span class="o">=</span> <span class="nx">getClass</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="o">==</span> <span class="nx">functionClass</span><span class="p">,</span> <span class="nx">property</span><span class="p">,</span> <span class="nx">isConstructor</span><span class="p">;</span>
          <span class="k">for</span> <span class="p">(</span><span class="nx">property</span> <span class="k">in</span> <span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">isFunction</span> <span class="o">&amp;&amp;</span> <span class="nx">property</span> <span class="o">==</span> <span class="s2">&quot;prototype&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">isProperty</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="nx">property</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="nx">isConstructor</span> <span class="o">=</span> <span class="nx">property</span> <span class="o">===</span> <span class="s2">&quot;constructor&quot;</span><span class="p">))</span> <span class="p">{</span>
              <span class="nx">callback</span><span class="p">(</span><span class="nx">property</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">}</span></pre></div></td></tr><tr id="section-526"><td class="docs"><div class="pilwrap"><a href="#section-526" class="pilcrow">&#182;</a></div><p>Manually invoke the callback for the <code>constructor</code> property due to
cross-environment inconsistencies.</p>
</td><td class="code"><div class="highlight"><pre>          <span class="k">if</span> <span class="p">(</span><span class="nx">isConstructor</span> <span class="o">||</span> <span class="nx">isProperty</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="p">(</span><span class="nx">property</span> <span class="o">=</span> <span class="s2">&quot;constructor&quot;</span><span class="p">)))</span> <span class="p">{</span>
            <span class="nx">callback</span><span class="p">(</span><span class="nx">property</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">};</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">forEach</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
    <span class="p">};</span></pre></div></td></tr><tr id="section-527"><td class="docs"><div class="pilwrap"><a href="#section-527" class="pilcrow">&#182;</a></div><p>Public: Serializes a JavaScript <code>value</code> as a JSON string. The optional
<code>filter</code> argument may specify either a function that alters how object and
array members are serialized, or an array of strings and numbers that
indicates which properties should be serialized. The optional <code>width</code>
argument may be either a string or number that specifies the indentation
level of the output.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">has</span><span class="p">(</span><span class="s2">&quot;json-stringify&quot;</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr><tr id="section-528"><td class="docs"><div class="pilwrap"><a href="#section-528" class="pilcrow">&#182;</a></div><p>Internal: A map of control characters and their escaped equivalents.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">Escapes</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">92</span><span class="o">:</span> <span class="s2">&quot;\\\\&quot;</span><span class="p">,</span>
        <span class="mi">34</span><span class="o">:</span> <span class="s1">&#39;\\&quot;&#39;</span><span class="p">,</span>
        <span class="mi">8</span><span class="o">:</span> <span class="s2">&quot;\\b&quot;</span><span class="p">,</span>
        <span class="mi">12</span><span class="o">:</span> <span class="s2">&quot;\\f&quot;</span><span class="p">,</span>
        <span class="mi">10</span><span class="o">:</span> <span class="s2">&quot;\\n&quot;</span><span class="p">,</span>
        <span class="mi">13</span><span class="o">:</span> <span class="s2">&quot;\\r&quot;</span><span class="p">,</span>
        <span class="mi">9</span><span class="o">:</span> <span class="s2">&quot;\\t&quot;</span>
      <span class="p">};</span></pre></div></td></tr><tr id="section-529"><td class="docs"><div class="pilwrap"><a href="#section-529" class="pilcrow">&#182;</a></div><p>Internal: Converts <code>value</code> into a zero-padded string such that its
length is at least equal to <code>width</code>. The <code>width</code> must be &lt;= 6.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">leadingZeroes</span> <span class="o">=</span> <span class="s2">&quot;000000&quot;</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">toPaddedString</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">width</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-530"><td class="docs"><div class="pilwrap"><a href="#section-530" class="pilcrow">&#182;</a></div><p>The <code>|| 0</code> expression is necessary to work around a bug in
Opera &lt;= 7.54u2 where <code>0 == -0</code>, but <code>String(-0) !== "0"</code>.</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">return</span> <span class="p">(</span><span class="nx">leadingZeroes</span> <span class="o">+</span> <span class="p">(</span><span class="nx">value</span> <span class="o">||</span> <span class="mi">0</span><span class="p">)).</span><span class="nx">slice</span><span class="p">(</span><span class="o">-</span><span class="nx">width</span><span class="p">);</span>
      <span class="p">};</span></pre></div></td></tr><tr id="section-531"><td class="docs"><div class="pilwrap"><a href="#section-531" class="pilcrow">&#182;</a></div><p>Internal: Double-quotes a string <code>value</code>, replacing all ASCII control
characters (characters with code unit values between 0 and 31) with
their escaped equivalents. This is an implementation of the
<code>Quote(value)</code> operation defined in ES 5.1 section 15.12.3.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">unicodePrefix</span> <span class="o">=</span> <span class="s2">&quot;\\u00&quot;</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">quote</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="nx">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">isLarge</span> <span class="o">=</span> <span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="o">&amp;&amp;</span> <span class="nx">charIndexBuggy</span><span class="p">,</span> <span class="nx">symbols</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">isLarge</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">symbols</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(;</span> <span class="nx">index</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">charCode</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">index</span><span class="p">);</span></pre></div></td></tr><tr id="section-532"><td class="docs"><div class="pilwrap"><a href="#section-532" class="pilcrow">&#182;</a></div><p>If the character is a control character, append its Unicode or
shorthand escape sequence; otherwise, append the character as-is.</p>
</td><td class="code"><div class="highlight"><pre>          <span class="k">switch</span> <span class="p">(</span><span class="nx">charCode</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="mi">8</span><span class="o">:</span> <span class="k">case</span> <span class="mi">9</span><span class="o">:</span> <span class="k">case</span> <span class="mi">10</span><span class="o">:</span> <span class="k">case</span> <span class="mi">12</span><span class="o">:</span> <span class="k">case</span> <span class="mi">13</span><span class="o">:</span> <span class="k">case</span> <span class="mi">34</span><span class="o">:</span> <span class="k">case</span> <span class="mi">92</span><span class="o">:</span>
              <span class="nx">result</span> <span class="o">+=</span> <span class="nx">Escapes</span><span class="p">[</span><span class="nx">charCode</span><span class="p">];</span>
              <span class="k">break</span><span class="p">;</span>
            <span class="k">default</span><span class="o">:</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">charCode</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">result</span> <span class="o">+=</span> <span class="nx">unicodePrefix</span> <span class="o">+</span> <span class="nx">toPaddedString</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">charCode</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
                <span class="k">break</span><span class="p">;</span>
              <span class="p">}</span>
              <span class="nx">result</span> <span class="o">+=</span> <span class="nx">isLarge</span> <span class="o">?</span> <span class="nx">symbols</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span> <span class="o">:</span> <span class="nx">charIndexBuggy</span> <span class="o">?</span> <span class="nx">value</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">index</span><span class="p">)</span> <span class="o">:</span> <span class="nx">value</span><span class="p">[</span><span class="nx">index</span><span class="p">];</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">result</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">;</span>
      <span class="p">};</span></pre></div></td></tr><tr id="section-533"><td class="docs"><div class="pilwrap"><a href="#section-533" class="pilcrow">&#182;</a></div><p>Internal: Recursively serializes an object. Implements the
<code>Str(key, holder)</code>, <code>JO(value)</code>, and <code>JA(value)</code> operations.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">serialize</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">property</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">properties</span><span class="p">,</span> <span class="nx">whitespace</span><span class="p">,</span> <span class="nx">indentation</span><span class="p">,</span> <span class="nx">stack</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">className</span><span class="p">,</span> <span class="nx">year</span><span class="p">,</span> <span class="nx">month</span><span class="p">,</span> <span class="nx">date</span><span class="p">,</span> <span class="nx">time</span><span class="p">,</span> <span class="nx">hours</span><span class="p">,</span> <span class="nx">minutes</span><span class="p">,</span> <span class="nx">seconds</span><span class="p">,</span> <span class="nx">milliseconds</span><span class="p">,</span> <span class="nx">results</span><span class="p">,</span> <span class="nx">element</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">length</span><span class="p">,</span> <span class="nx">prefix</span><span class="p">,</span> <span class="nx">result</span><span class="p">;</span>
        <span class="k">try</span> <span class="p">{</span></pre></div></td></tr><tr id="section-534"><td class="docs"><div class="pilwrap"><a href="#section-534" class="pilcrow">&#182;</a></div><p>Necessary for host object support.</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nx">value</span> <span class="o">=</span> <span class="nx">object</span><span class="p">[</span><span class="nx">property</span><span class="p">];</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">exception</span><span class="p">)</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">value</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">className</span> <span class="o">=</span> <span class="nx">getClass</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">className</span> <span class="o">==</span> <span class="nx">dateClass</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isProperty</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="s2">&quot;toJSON&quot;</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">value</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-535"><td class="docs"><div class="pilwrap"><a href="#section-535" class="pilcrow">&#182;</a></div><p>Dates are serialized according to the <code>Date#toJSON</code> method
specified in ES 5.1 section 15.9.5.44. See section 15.9.1.15
for the ISO 8601 date time string format.</p>
</td><td class="code"><div class="highlight"><pre>              <span class="k">if</span> <span class="p">(</span><span class="nx">getDay</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-536"><td class="docs"><div class="pilwrap"><a href="#section-536" class="pilcrow">&#182;</a></div><p>Manually compute the year, month, date, hours, minutes,
seconds, and milliseconds if the <code>getUTC*</code> methods are
buggy. Adapted from @Yaffle's <code>date-shim</code> project.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nx">date</span> <span class="o">=</span> <span class="nx">floor</span><span class="p">(</span><span class="nx">value</span> <span class="o">/</span> <span class="mi">864</span><span class="nx">e5</span><span class="p">);</span>
                <span class="k">for</span> <span class="p">(</span><span class="nx">year</span> <span class="o">=</span> <span class="nx">floor</span><span class="p">(</span><span class="nx">date</span> <span class="o">/</span> <span class="mf">365.2425</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1970</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">getDay</span><span class="p">(</span><span class="nx">year</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nx">date</span><span class="p">;</span> <span class="nx">year</span><span class="o">++</span><span class="p">);</span>
                <span class="k">for</span> <span class="p">(</span><span class="nx">month</span> <span class="o">=</span> <span class="nx">floor</span><span class="p">((</span><span class="nx">date</span> <span class="o">-</span> <span class="nx">getDay</span><span class="p">(</span><span class="nx">year</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="mf">30.42</span><span class="p">);</span> <span class="nx">getDay</span><span class="p">(</span><span class="nx">year</span><span class="p">,</span> <span class="nx">month</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nx">date</span><span class="p">;</span> <span class="nx">month</span><span class="o">++</span><span class="p">);</span>
                <span class="nx">date</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="nx">date</span> <span class="o">-</span> <span class="nx">getDay</span><span class="p">(</span><span class="nx">year</span><span class="p">,</span> <span class="nx">month</span><span class="p">);</span></pre></div></td></tr><tr id="section-537"><td class="docs"><div class="pilwrap"><a href="#section-537" class="pilcrow">&#182;</a></div><p>The <code>time</code> value specifies the time within the day (see ES
5.1 section 15.9.1.2). The formula <code>(A % B + B) % B</code> is used
to compute <code>A modulo B</code>, as the <code>%</code> operator does not
correspond to the <code>modulo</code> operation for negative numbers.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nx">time</span> <span class="o">=</span> <span class="p">(</span><span class="nx">value</span> <span class="o">%</span> <span class="mi">864</span><span class="nx">e5</span> <span class="o">+</span> <span class="mi">864</span><span class="nx">e5</span><span class="p">)</span> <span class="o">%</span> <span class="mi">864</span><span class="nx">e5</span><span class="p">;</span></pre></div></td></tr><tr id="section-538"><td class="docs"><div class="pilwrap"><a href="#section-538" class="pilcrow">&#182;</a></div><p>The hours, minutes, seconds, and milliseconds are obtained by
decomposing the time within the day. See section 15.9.1.10.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nx">hours</span> <span class="o">=</span> <span class="nx">floor</span><span class="p">(</span><span class="nx">time</span> <span class="o">/</span> <span class="mi">36</span><span class="nx">e5</span><span class="p">)</span> <span class="o">%</span> <span class="mi">24</span><span class="p">;</span>
                <span class="nx">minutes</span> <span class="o">=</span> <span class="nx">floor</span><span class="p">(</span><span class="nx">time</span> <span class="o">/</span> <span class="mi">6</span><span class="nx">e4</span><span class="p">)</span> <span class="o">%</span> <span class="mi">60</span><span class="p">;</span>
                <span class="nx">seconds</span> <span class="o">=</span> <span class="nx">floor</span><span class="p">(</span><span class="nx">time</span> <span class="o">/</span> <span class="mi">1</span><span class="nx">e3</span><span class="p">)</span> <span class="o">%</span> <span class="mi">60</span><span class="p">;</span>
                <span class="nx">milliseconds</span> <span class="o">=</span> <span class="nx">time</span> <span class="o">%</span> <span class="mi">1</span><span class="nx">e3</span><span class="p">;</span>
              <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">year</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">getUTCFullYear</span><span class="p">();</span>
                <span class="nx">month</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">getUTCMonth</span><span class="p">();</span>
                <span class="nx">date</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">getUTCDate</span><span class="p">();</span>
                <span class="nx">hours</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">getUTCHours</span><span class="p">();</span>
                <span class="nx">minutes</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">getUTCMinutes</span><span class="p">();</span>
                <span class="nx">seconds</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">getUTCSeconds</span><span class="p">();</span>
                <span class="nx">milliseconds</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">getUTCMilliseconds</span><span class="p">();</span>
              <span class="p">}</span></pre></div></td></tr><tr id="section-539"><td class="docs"><div class="pilwrap"><a href="#section-539" class="pilcrow">&#182;</a></div><p>Serialize extended years correctly.</p>
</td><td class="code"><div class="highlight"><pre>              <span class="nx">value</span> <span class="o">=</span> <span class="p">(</span><span class="nx">year</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">year</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="nx">e4</span> <span class="o">?</span> <span class="p">(</span><span class="nx">year</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="s2">&quot;-&quot;</span> <span class="o">:</span> <span class="s2">&quot;+&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nx">toPaddedString</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="nx">year</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="o">-</span><span class="nx">year</span> <span class="o">:</span> <span class="nx">year</span><span class="p">)</span> <span class="o">:</span> <span class="nx">toPaddedString</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nx">year</span><span class="p">))</span> <span class="o">+</span>
                <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="nx">toPaddedString</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">month</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="nx">toPaddedString</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">date</span><span class="p">)</span> <span class="o">+</span></pre></div></td></tr><tr id="section-540"><td class="docs"><div class="pilwrap"><a href="#section-540" class="pilcrow">&#182;</a></div><p>Months, dates, hours, minutes, and seconds should have two
digits; milliseconds should have three.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="s2">&quot;T&quot;</span> <span class="o">+</span> <span class="nx">toPaddedString</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">hours</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nx">toPaddedString</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">minutes</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nx">toPaddedString</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">seconds</span><span class="p">)</span> <span class="o">+</span></pre></div></td></tr><tr id="section-541"><td class="docs"><div class="pilwrap"><a href="#section-541" class="pilcrow">&#182;</a></div><p>Milliseconds are optional in ES 5.0, but required in 5.1.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="nx">toPaddedString</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nx">milliseconds</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;Z&quot;</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="nx">value</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">value</span><span class="p">.</span><span class="nx">toJSON</span> <span class="o">==</span> <span class="s2">&quot;function&quot;</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="nx">className</span> <span class="o">!=</span> <span class="nx">numberClass</span> <span class="o">&amp;&amp;</span> <span class="nx">className</span> <span class="o">!=</span> <span class="nx">stringClass</span> <span class="o">&amp;&amp;</span> <span class="nx">className</span> <span class="o">!=</span> <span class="nx">arrayClass</span><span class="p">)</span> <span class="o">||</span> <span class="nx">isProperty</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="s2">&quot;toJSON&quot;</span><span class="p">)))</span> <span class="p">{</span></pre></div></td></tr><tr id="section-542"><td class="docs"><div class="pilwrap"><a href="#section-542" class="pilcrow">&#182;</a></div><p>Prototype &lt;= 1.6.1 adds non-standard <code>toJSON</code> methods to the
<code>Number</code>, <code>String</code>, <code>Date</code>, and <code>Array</code> prototypes. JSON 3
ignores all <code>toJSON</code> methods on these objects unless they are
defined directly on an instance.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">(</span><span class="nx">property</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-543"><td class="docs"><div class="pilwrap"><a href="#section-543" class="pilcrow">&#182;</a></div><p>If a replacement function was provided, call it to obtain the value
for serialization.</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nx">value</span> <span class="o">=</span> <span class="nx">callback</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="nx">property</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="s2">&quot;null&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">className</span> <span class="o">=</span> <span class="nx">getClass</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">className</span> <span class="o">==</span> <span class="nx">booleanClass</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-544"><td class="docs"><div class="pilwrap"><a href="#section-544" class="pilcrow">&#182;</a></div><p>Booleans are represented literally.</p>
</td><td class="code"><div class="highlight"><pre>          <span class="k">return</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="nx">value</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">className</span> <span class="o">==</span> <span class="nx">numberClass</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-545"><td class="docs"><div class="pilwrap"><a href="#section-545" class="pilcrow">&#182;</a></div><p>JSON numbers must be finite. <code>Infinity</code> and <code>NaN</code> are serialized as
<code>"null"</code>.</p>
</td><td class="code"><div class="highlight"><pre>          <span class="k">return</span> <span class="nx">value</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">value</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">0</span> <span class="o">?</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="nx">value</span> <span class="o">:</span> <span class="s2">&quot;null&quot;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">className</span> <span class="o">==</span> <span class="nx">stringClass</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-546"><td class="docs"><div class="pilwrap"><a href="#section-546" class="pilcrow">&#182;</a></div><p>Strings are double-quoted and escaped.</p>
</td><td class="code"><div class="highlight"><pre>          <span class="k">return</span> <span class="nx">quote</span><span class="p">(</span><span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="nx">value</span><span class="p">);</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-547"><td class="docs"><div class="pilwrap"><a href="#section-547" class="pilcrow">&#182;</a></div><p>Recursively serialize objects and arrays.</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">value</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-548"><td class="docs"><div class="pilwrap"><a href="#section-548" class="pilcrow">&#182;</a></div><p>Check for cyclic structures. This is a linear search; performance
is inversely proportional to the number of unique nested objects.</p>
</td><td class="code"><div class="highlight"><pre>          <span class="k">for</span> <span class="p">(</span><span class="nx">length</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">length</span><span class="o">--</span><span class="p">;)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">stack</span><span class="p">[</span><span class="nx">length</span><span class="p">]</span> <span class="o">===</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-549"><td class="docs"><div class="pilwrap"><a href="#section-549" class="pilcrow">&#182;</a></div><p>Cyclic structures cannot be serialized by <code>JSON.stringify</code>.</p>
</td><td class="code"><div class="highlight"><pre>              <span class="k">throw</span> <span class="nx">TypeError</span><span class="p">();</span>
            <span class="p">}</span>
          <span class="p">}</span></pre></div></td></tr><tr id="section-550"><td class="docs"><div class="pilwrap"><a href="#section-550" class="pilcrow">&#182;</a></div><p>Add the object to the stack of traversed objects.</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
          <span class="nx">results</span> <span class="o">=</span> <span class="p">[];</span></pre></div></td></tr><tr id="section-551"><td class="docs"><div class="pilwrap"><a href="#section-551" class="pilcrow">&#182;</a></div><p>Save the current indentation level and indent one additional level.</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nx">prefix</span> <span class="o">=</span> <span class="nx">indentation</span><span class="p">;</span>
          <span class="nx">indentation</span> <span class="o">+=</span> <span class="nx">whitespace</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">className</span> <span class="o">==</span> <span class="nx">arrayClass</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-552"><td class="docs"><div class="pilwrap"><a href="#section-552" class="pilcrow">&#182;</a></div><p>Recursively serialize array elements.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">for</span> <span class="p">(</span><span class="nx">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">index</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">element</span> <span class="o">=</span> <span class="nx">serialize</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">properties</span><span class="p">,</span> <span class="nx">whitespace</span><span class="p">,</span> <span class="nx">indentation</span><span class="p">,</span> <span class="nx">stack</span><span class="p">);</span>
              <span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">element</span> <span class="o">===</span> <span class="nx">undef</span> <span class="o">?</span> <span class="s2">&quot;null&quot;</span> <span class="o">:</span> <span class="nx">element</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nx">result</span> <span class="o">=</span> <span class="nx">results</span><span class="p">.</span><span class="nx">length</span> <span class="o">?</span> <span class="p">(</span><span class="nx">whitespace</span> <span class="o">?</span> <span class="s2">&quot;[\n&quot;</span> <span class="o">+</span> <span class="nx">indentation</span> <span class="o">+</span> <span class="nx">results</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;,\n&quot;</span> <span class="o">+</span> <span class="nx">indentation</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;\n&quot;</span> <span class="o">+</span> <span class="nx">prefix</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span> <span class="o">:</span> <span class="p">(</span><span class="s2">&quot;[&quot;</span> <span class="o">+</span> <span class="nx">results</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">))</span> <span class="o">:</span> <span class="s2">&quot;[]&quot;</span><span class="p">;</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr><tr id="section-553"><td class="docs"><div class="pilwrap"><a href="#section-553" class="pilcrow">&#182;</a></div><p>Recursively serialize object members. Members are selected from
either a user-specified list of property names, or the object
itself.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">forEach</span><span class="p">(</span><span class="nx">properties</span> <span class="o">||</span> <span class="nx">value</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">property</span><span class="p">)</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">serialize</span><span class="p">(</span><span class="nx">property</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">properties</span><span class="p">,</span> <span class="nx">whitespace</span><span class="p">,</span> <span class="nx">indentation</span><span class="p">,</span> <span class="nx">stack</span><span class="p">);</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">element</span> <span class="o">!==</span> <span class="nx">undef</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-554"><td class="docs"><div class="pilwrap"><a href="#section-554" class="pilcrow">&#182;</a></div><p>According to ES 5.1 section 15.12.3: "If <code>gap</code> {whitespace}
is not the empty string, let <code>member</code> {quote(property) + ":"}
be the concatenation of <code>member</code> and the <code>space</code> character."
The "<code>space</code> character" refers to the literal space
character, not the <code>space</code> {width} argument provided to
<code>JSON.stringify</code>.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">quote</span><span class="p">(</span><span class="nx">property</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">whitespace</span> <span class="o">?</span> <span class="s2">&quot; &quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nx">element</span><span class="p">);</span>
              <span class="p">}</span>
            <span class="p">});</span>
            <span class="nx">result</span> <span class="o">=</span> <span class="nx">results</span><span class="p">.</span><span class="nx">length</span> <span class="o">?</span> <span class="p">(</span><span class="nx">whitespace</span> <span class="o">?</span> <span class="s2">&quot;{\n&quot;</span> <span class="o">+</span> <span class="nx">indentation</span> <span class="o">+</span> <span class="nx">results</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;,\n&quot;</span> <span class="o">+</span> <span class="nx">indentation</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;\n&quot;</span> <span class="o">+</span> <span class="nx">prefix</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span> <span class="o">:</span> <span class="p">(</span><span class="s2">&quot;{&quot;</span> <span class="o">+</span> <span class="nx">results</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span><span class="p">))</span> <span class="o">:</span> <span class="s2">&quot;{}&quot;</span><span class="p">;</span>
          <span class="p">}</span></pre></div></td></tr><tr id="section-555"><td class="docs"><div class="pilwrap"><a href="#section-555" class="pilcrow">&#182;</a></div><p>Remove the object from the traversed object stack.</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
          <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">};</span></pre></div></td></tr><tr id="section-556"><td class="docs"><div class="pilwrap"><a href="#section-556" class="pilcrow">&#182;</a></div><p>Public: <code>JSON.stringify</code>. See ES 5.1 section 15.12.3.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">JSON3</span><span class="p">.</span><span class="nx">stringify</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">filter</span><span class="p">,</span> <span class="nx">width</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">whitespace</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">properties</span><span class="p">,</span> <span class="nx">className</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">filter</span> <span class="o">==</span> <span class="s2">&quot;function&quot;</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">filter</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">filter</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">((</span><span class="nx">className</span> <span class="o">=</span> <span class="nx">getClass</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">filter</span><span class="p">))</span> <span class="o">==</span> <span class="nx">functionClass</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">callback</span> <span class="o">=</span> <span class="nx">filter</span><span class="p">;</span>
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">className</span> <span class="o">==</span> <span class="nx">arrayClass</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-557"><td class="docs"><div class="pilwrap"><a href="#section-557" class="pilcrow">&#182;</a></div><p>Convert the property names array into a makeshift set.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">properties</span> <span class="o">=</span> <span class="p">{};</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">filter</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">value</span><span class="p">;</span> <span class="nx">index</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">filter</span><span class="p">[</span><span class="nx">index</span><span class="o">++</span><span class="p">],</span> <span class="p">((</span><span class="nx">className</span> <span class="o">=</span> <span class="nx">getClass</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">value</span><span class="p">)),</span> <span class="nx">className</span> <span class="o">==</span> <span class="nx">stringClass</span> <span class="o">||</span> <span class="nx">className</span> <span class="o">==</span> <span class="nx">numberClass</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">properties</span><span class="p">[</span><span class="nx">value</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">));</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">width</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">((</span><span class="nx">className</span> <span class="o">=</span> <span class="nx">getClass</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">width</span><span class="p">))</span> <span class="o">==</span> <span class="nx">numberClass</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-558"><td class="docs"><div class="pilwrap"><a href="#section-558" class="pilcrow">&#182;</a></div><p>Convert the <code>width</code> to an integer and create a string containing
<code>width</code> number of space characters.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">((</span><span class="nx">width</span> <span class="o">-=</span> <span class="nx">width</span> <span class="o">%</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">for</span> <span class="p">(</span><span class="nx">whitespace</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">width</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">width</span> <span class="o">=</span> <span class="mi">10</span><span class="p">);</span> <span class="nx">whitespace</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">width</span><span class="p">;</span> <span class="nx">whitespace</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">className</span> <span class="o">==</span> <span class="nx">stringClass</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">whitespace</span> <span class="o">=</span> <span class="nx">width</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="mi">10</span> <span class="o">?</span> <span class="nx">width</span> <span class="o">:</span> <span class="nx">width</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-559"><td class="docs"><div class="pilwrap"><a href="#section-559" class="pilcrow">&#182;</a></div><p>Opera &lt;= 7.54u2 discards the values associated with empty string keys
(<code>""</code>) only if they are used directly within an object member list
(e.g., <code>!("" in { "": 1})</code>).</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">return</span> <span class="nx">serialize</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">value</span> <span class="o">=</span> <span class="p">{},</span> <span class="nx">value</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">value</span><span class="p">),</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">properties</span><span class="p">,</span> <span class="nx">whitespace</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">[]);</span>
      <span class="p">};</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-560"><td class="docs"><div class="pilwrap"><a href="#section-560" class="pilcrow">&#182;</a></div><p>Public: Parses a JSON source string.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">has</span><span class="p">(</span><span class="s2">&quot;json-parse&quot;</span><span class="p">))</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">fromCharCode</span> <span class="o">=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">;</span></pre></div></td></tr><tr id="section-561"><td class="docs"><div class="pilwrap"><a href="#section-561" class="pilcrow">&#182;</a></div><p>Internal: A map of escaped control characters and their unescaped
equivalents.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">Unescapes</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">92</span><span class="o">:</span> <span class="s2">&quot;\\&quot;</span><span class="p">,</span>
        <span class="mi">34</span><span class="o">:</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span>
        <span class="mi">47</span><span class="o">:</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span>
        <span class="mi">98</span><span class="o">:</span> <span class="s2">&quot;\b&quot;</span><span class="p">,</span>
        <span class="mi">116</span><span class="o">:</span> <span class="s2">&quot;\t&quot;</span><span class="p">,</span>
        <span class="mi">110</span><span class="o">:</span> <span class="s2">&quot;\n&quot;</span><span class="p">,</span>
        <span class="mi">102</span><span class="o">:</span> <span class="s2">&quot;\f&quot;</span><span class="p">,</span>
        <span class="mi">114</span><span class="o">:</span> <span class="s2">&quot;\r&quot;</span>
      <span class="p">};</span></pre></div></td></tr><tr id="section-562"><td class="docs"><div class="pilwrap"><a href="#section-562" class="pilcrow">&#182;</a></div><p>Internal: Stores the parser state.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">Index</span><span class="p">,</span> <span class="nx">Source</span><span class="p">;</span></pre></div></td></tr><tr id="section-563"><td class="docs"><div class="pilwrap"><a href="#section-563" class="pilcrow">&#182;</a></div><p>Internal: Resets the parser state and throws a <code>SyntaxError</code>.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">abort</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">Index</span> <span class="o">=</span> <span class="nx">Source</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">throw</span> <span class="nx">SyntaxError</span><span class="p">();</span>
      <span class="p">};</span></pre></div></td></tr><tr id="section-564"><td class="docs"><div class="pilwrap"><a href="#section-564" class="pilcrow">&#182;</a></div><p>Internal: Returns the next token, or <code>"$"</code> if the parser has reached
the end of the source string. A token may be a string, number, <code>null</code>
literal, or Boolean literal.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">lex</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">source</span> <span class="o">=</span> <span class="nx">Source</span><span class="p">,</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">begin</span><span class="p">,</span> <span class="nx">position</span><span class="p">,</span> <span class="nx">isSigned</span><span class="p">,</span> <span class="nx">charCode</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="nx">Index</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">charCode</span> <span class="o">=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">Index</span><span class="p">);</span>
          <span class="k">switch</span> <span class="p">(</span><span class="nx">charCode</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="mi">9</span><span class="o">:</span> <span class="k">case</span> <span class="mi">10</span><span class="o">:</span> <span class="k">case</span> <span class="mi">13</span><span class="o">:</span> <span class="k">case</span> <span class="mi">32</span><span class="o">:</span></pre></div></td></tr><tr id="section-565"><td class="docs"><div class="pilwrap"><a href="#section-565" class="pilcrow">&#182;</a></div><p>Skip whitespace tokens, including tabs, carriage returns, line
feeds, and space characters.</p>
</td><td class="code"><div class="highlight"><pre>              <span class="nx">Index</span><span class="o">++</span><span class="p">;</span>
              <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mi">123</span><span class="o">:</span> <span class="k">case</span> <span class="mi">125</span><span class="o">:</span> <span class="k">case</span> <span class="mi">91</span><span class="o">:</span> <span class="k">case</span> <span class="mi">93</span><span class="o">:</span> <span class="k">case</span> <span class="mi">58</span><span class="o">:</span> <span class="k">case</span> <span class="mi">44</span><span class="o">:</span></pre></div></td></tr><tr id="section-566"><td class="docs"><div class="pilwrap"><a href="#section-566" class="pilcrow">&#182;</a></div><p>Parse a punctuator token (<code>{</code>, <code>}</code>, <code>[</code>, <code>]</code>, <code>:</code>, or <code>,</code>) at
the current position.</p>
</td><td class="code"><div class="highlight"><pre>              <span class="nx">value</span> <span class="o">=</span> <span class="nx">charIndexBuggy</span> <span class="o">?</span> <span class="nx">source</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">Index</span><span class="p">)</span> <span class="o">:</span> <span class="nx">source</span><span class="p">[</span><span class="nx">Index</span><span class="p">];</span>
              <span class="nx">Index</span><span class="o">++</span><span class="p">;</span>
              <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
            <span class="k">case</span> <span class="mi">34</span><span class="o">:</span></pre></div></td></tr><tr id="section-567"><td class="docs"><div class="pilwrap"><a href="#section-567" class="pilcrow">&#182;</a></div><p><code>"</code> delimits a JSON string; advance to the next character and
begin parsing the string. String tokens are prefixed with the
sentinel <code>@</code> character to distinguish them from punctuators and
end-of-string tokens.</p>
</td><td class="code"><div class="highlight"><pre>              <span class="k">for</span> <span class="p">(</span><span class="nx">value</span> <span class="o">=</span> <span class="s2">&quot;@&quot;</span><span class="p">,</span> <span class="nx">Index</span><span class="o">++</span><span class="p">;</span> <span class="nx">Index</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;)</span> <span class="p">{</span>
                <span class="nx">charCode</span> <span class="o">=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">Index</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">charCode</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-568"><td class="docs"><div class="pilwrap"><a href="#section-568" class="pilcrow">&#182;</a></div><p>Unescaped ASCII control characters (those with a code unit
less than the space character) are not permitted.</p>
</td><td class="code"><div class="highlight"><pre>                  <span class="nx">abort</span><span class="p">();</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">charCode</span> <span class="o">==</span> <span class="mi">92</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-569"><td class="docs"><div class="pilwrap"><a href="#section-569" class="pilcrow">&#182;</a></div><p>A reverse solidus (<code>\</code>) marks the beginning of an escaped
control character (including <code>"</code>, <code>\</code>, and <code>/</code>) or Unicode
escape sequence.</p>
</td><td class="code"><div class="highlight"><pre>                  <span class="nx">charCode</span> <span class="o">=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="o">++</span><span class="nx">Index</span><span class="p">);</span>
                  <span class="k">switch</span> <span class="p">(</span><span class="nx">charCode</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">case</span> <span class="mi">92</span><span class="o">:</span> <span class="k">case</span> <span class="mi">34</span><span class="o">:</span> <span class="k">case</span> <span class="mi">47</span><span class="o">:</span> <span class="k">case</span> <span class="mi">98</span><span class="o">:</span> <span class="k">case</span> <span class="mi">116</span><span class="o">:</span> <span class="k">case</span> <span class="mi">110</span><span class="o">:</span> <span class="k">case</span> <span class="mi">102</span><span class="o">:</span> <span class="k">case</span> <span class="mi">114</span><span class="o">:</span></pre></div></td></tr><tr id="section-570"><td class="docs"><div class="pilwrap"><a href="#section-570" class="pilcrow">&#182;</a></div><p>Revive escaped control characters.</p>
</td><td class="code"><div class="highlight"><pre>                      <span class="nx">value</span> <span class="o">+=</span> <span class="nx">Unescapes</span><span class="p">[</span><span class="nx">charCode</span><span class="p">];</span>
                      <span class="nx">Index</span><span class="o">++</span><span class="p">;</span>
                      <span class="k">break</span><span class="p">;</span>
                    <span class="k">case</span> <span class="mi">117</span><span class="o">:</span></pre></div></td></tr><tr id="section-571"><td class="docs"><div class="pilwrap"><a href="#section-571" class="pilcrow">&#182;</a></div><p><code>\u</code> marks the beginning of a Unicode escape sequence.
Advance to the first character and validate the
four-digit code point.</p>
</td><td class="code"><div class="highlight"><pre>                      <span class="nx">begin</span> <span class="o">=</span> <span class="o">++</span><span class="nx">Index</span><span class="p">;</span>
                      <span class="k">for</span> <span class="p">(</span><span class="nx">position</span> <span class="o">=</span> <span class="nx">Index</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span> <span class="nx">Index</span> <span class="o">&lt;</span> <span class="nx">position</span><span class="p">;</span> <span class="nx">Index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">charCode</span> <span class="o">=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">Index</span><span class="p">);</span></pre></div></td></tr><tr id="section-572"><td class="docs"><div class="pilwrap"><a href="#section-572" class="pilcrow">&#182;</a></div><p>A valid sequence comprises four hexdigits (case-
insensitive) that form a single hexadecimal value.</p>
</td><td class="code"><div class="highlight"><pre>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">charCode</span> <span class="o">&gt;=</span> <span class="mi">48</span> <span class="o">&amp;&amp;</span> <span class="nx">charCode</span> <span class="o">&lt;=</span> <span class="mi">57</span> <span class="o">||</span> <span class="nx">charCode</span> <span class="o">&gt;=</span> <span class="mi">97</span> <span class="o">&amp;&amp;</span> <span class="nx">charCode</span> <span class="o">&lt;=</span> <span class="mi">102</span> <span class="o">||</span> <span class="nx">charCode</span> <span class="o">&gt;=</span> <span class="mi">65</span> <span class="o">&amp;&amp;</span> <span class="nx">charCode</span> <span class="o">&lt;=</span> <span class="mi">70</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr><tr id="section-573"><td class="docs"><div class="pilwrap"><a href="#section-573" class="pilcrow">&#182;</a></div><p>Invalid Unicode escape sequence.</p>
</td><td class="code"><div class="highlight"><pre>                          <span class="nx">abort</span><span class="p">();</span>
                        <span class="p">}</span>
                      <span class="p">}</span></pre></div></td></tr><tr id="section-574"><td class="docs"><div class="pilwrap"><a href="#section-574" class="pilcrow">&#182;</a></div><p>Revive the escaped character.</p>
</td><td class="code"><div class="highlight"><pre>                      <span class="nx">value</span> <span class="o">+=</span> <span class="nx">fromCharCode</span><span class="p">(</span><span class="s2">&quot;0x&quot;</span> <span class="o">+</span> <span class="nx">source</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">begin</span><span class="p">,</span> <span class="nx">Index</span><span class="p">));</span>
                      <span class="k">break</span><span class="p">;</span>
                    <span class="k">default</span><span class="o">:</span></pre></div></td></tr><tr id="section-575"><td class="docs"><div class="pilwrap"><a href="#section-575" class="pilcrow">&#182;</a></div><p>Invalid escape sequence.</p>
</td><td class="code"><div class="highlight"><pre>                      <span class="nx">abort</span><span class="p">();</span>
                  <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">charCode</span> <span class="o">==</span> <span class="mi">34</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-576"><td class="docs"><div class="pilwrap"><a href="#section-576" class="pilcrow">&#182;</a></div><p>An unescaped double-quote character marks the end of the
string.</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="k">break</span><span class="p">;</span>
                  <span class="p">}</span>
                  <span class="nx">charCode</span> <span class="o">=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">Index</span><span class="p">);</span>
                  <span class="nx">begin</span> <span class="o">=</span> <span class="nx">Index</span><span class="p">;</span></pre></div></td></tr><tr id="section-577"><td class="docs"><div class="pilwrap"><a href="#section-577" class="pilcrow">&#182;</a></div><p>Optimize for the common case where a string is valid.</p>
</td><td class="code"><div class="highlight"><pre>                  <span class="k">while</span> <span class="p">(</span><span class="nx">charCode</span> <span class="o">&gt;=</span> <span class="mi">32</span> <span class="o">&amp;&amp;</span> <span class="nx">charCode</span> <span class="o">!=</span> <span class="mi">92</span> <span class="o">&amp;&amp;</span> <span class="nx">charCode</span> <span class="o">!=</span> <span class="mi">34</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">charCode</span> <span class="o">=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="o">++</span><span class="nx">Index</span><span class="p">);</span>
                  <span class="p">}</span></pre></div></td></tr><tr id="section-578"><td class="docs"><div class="pilwrap"><a href="#section-578" class="pilcrow">&#182;</a></div><p>Append the string as-is.</p>
</td><td class="code"><div class="highlight"><pre>                  <span class="nx">value</span> <span class="o">+=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">begin</span><span class="p">,</span> <span class="nx">Index</span><span class="p">);</span>
                <span class="p">}</span>
              <span class="p">}</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">Index</span><span class="p">)</span> <span class="o">==</span> <span class="mi">34</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-579"><td class="docs"><div class="pilwrap"><a href="#section-579" class="pilcrow">&#182;</a></div><p>Advance to the next character and return the revived string.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nx">Index</span><span class="o">++</span><span class="p">;</span>
                <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
              <span class="p">}</span></pre></div></td></tr><tr id="section-580"><td class="docs"><div class="pilwrap"><a href="#section-580" class="pilcrow">&#182;</a></div><p>Unterminated string.</p>
</td><td class="code"><div class="highlight"><pre>              <span class="nx">abort</span><span class="p">();</span>
            <span class="k">default</span><span class="o">:</span></pre></div></td></tr><tr id="section-581"><td class="docs"><div class="pilwrap"><a href="#section-581" class="pilcrow">&#182;</a></div><p>Parse numbers and literals.</p>
</td><td class="code"><div class="highlight"><pre>              <span class="nx">begin</span> <span class="o">=</span> <span class="nx">Index</span><span class="p">;</span></pre></div></td></tr><tr id="section-582"><td class="docs"><div class="pilwrap"><a href="#section-582" class="pilcrow">&#182;</a></div><p>Advance past the negative sign, if one is specified.</p>
</td><td class="code"><div class="highlight"><pre>              <span class="k">if</span> <span class="p">(</span><span class="nx">charCode</span> <span class="o">==</span> <span class="mi">45</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">isSigned</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                <span class="nx">charCode</span> <span class="o">=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="o">++</span><span class="nx">Index</span><span class="p">);</span>
              <span class="p">}</span></pre></div></td></tr><tr id="section-583"><td class="docs"><div class="pilwrap"><a href="#section-583" class="pilcrow">&#182;</a></div><p>Parse an integer or floating-point value.</p>
</td><td class="code"><div class="highlight"><pre>              <span class="k">if</span> <span class="p">(</span><span class="nx">charCode</span> <span class="o">&gt;=</span> <span class="mi">48</span> <span class="o">&amp;&amp;</span> <span class="nx">charCode</span> <span class="o">&lt;=</span> <span class="mi">57</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-584"><td class="docs"><div class="pilwrap"><a href="#section-584" class="pilcrow">&#182;</a></div><p>Leading zeroes are interpreted as octal literals.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="nx">charCode</span> <span class="o">==</span> <span class="mi">48</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="nx">charCode</span> <span class="o">=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">Index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span> <span class="nx">charCode</span> <span class="o">&gt;=</span> <span class="mi">48</span> <span class="o">&amp;&amp;</span> <span class="nx">charCode</span> <span class="o">&lt;=</span> <span class="mi">57</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr><tr id="section-585"><td class="docs"><div class="pilwrap"><a href="#section-585" class="pilcrow">&#182;</a></div><p>Illegal octal literal.</p>
</td><td class="code"><div class="highlight"><pre>                  <span class="nx">abort</span><span class="p">();</span>
                <span class="p">}</span>
                <span class="nx">isSigned</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></pre></div></td></tr><tr id="section-586"><td class="docs"><div class="pilwrap"><a href="#section-586" class="pilcrow">&#182;</a></div><p>Parse the integer component.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="k">for</span> <span class="p">(;</span> <span class="nx">Index</span> <span class="o">&lt;</span> <span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="nx">charCode</span> <span class="o">=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">Index</span><span class="p">)),</span> <span class="nx">charCode</span> <span class="o">&gt;=</span> <span class="mi">48</span> <span class="o">&amp;&amp;</span> <span class="nx">charCode</span> <span class="o">&lt;=</span> <span class="mi">57</span><span class="p">);</span> <span class="nx">Index</span><span class="o">++</span><span class="p">);</span></pre></div></td></tr><tr id="section-587"><td class="docs"><div class="pilwrap"><a href="#section-587" class="pilcrow">&#182;</a></div><p>Floats cannot contain a leading decimal point; however, this
case is already accounted for by the parser.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">Index</span><span class="p">)</span> <span class="o">==</span> <span class="mi">46</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">position</span> <span class="o">=</span> <span class="o">++</span><span class="nx">Index</span><span class="p">;</span></pre></div></td></tr><tr id="section-588"><td class="docs"><div class="pilwrap"><a href="#section-588" class="pilcrow">&#182;</a></div><p>Parse the decimal component.</p>
</td><td class="code"><div class="highlight"><pre>                  <span class="k">for</span> <span class="p">(;</span> <span class="nx">position</span> <span class="o">&lt;</span> <span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="nx">charCode</span> <span class="o">=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">position</span><span class="p">)),</span> <span class="nx">charCode</span> <span class="o">&gt;=</span> <span class="mi">48</span> <span class="o">&amp;&amp;</span> <span class="nx">charCode</span> <span class="o">&lt;=</span> <span class="mi">57</span><span class="p">);</span> <span class="nx">position</span><span class="o">++</span><span class="p">);</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">position</span> <span class="o">==</span> <span class="nx">Index</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-589"><td class="docs"><div class="pilwrap"><a href="#section-589" class="pilcrow">&#182;</a></div><p>Illegal trailing decimal.</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="nx">abort</span><span class="p">();</span>
                  <span class="p">}</span>
                  <span class="nx">Index</span> <span class="o">=</span> <span class="nx">position</span><span class="p">;</span>
                <span class="p">}</span></pre></div></td></tr><tr id="section-590"><td class="docs"><div class="pilwrap"><a href="#section-590" class="pilcrow">&#182;</a></div><p>Parse exponents. The <code>e</code> denoting the exponent is
case-insensitive.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nx">charCode</span> <span class="o">=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">Index</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">charCode</span> <span class="o">==</span> <span class="mi">101</span> <span class="o">||</span> <span class="nx">charCode</span> <span class="o">==</span> <span class="mi">69</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">charCode</span> <span class="o">=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="o">++</span><span class="nx">Index</span><span class="p">);</span></pre></div></td></tr><tr id="section-591"><td class="docs"><div class="pilwrap"><a href="#section-591" class="pilcrow">&#182;</a></div><p>Skip past the sign following the exponent, if one is
specified.</p>
</td><td class="code"><div class="highlight"><pre>                  <span class="k">if</span> <span class="p">(</span><span class="nx">charCode</span> <span class="o">==</span> <span class="mi">43</span> <span class="o">||</span> <span class="nx">charCode</span> <span class="o">==</span> <span class="mi">45</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">Index</span><span class="o">++</span><span class="p">;</span>
                  <span class="p">}</span></pre></div></td></tr><tr id="section-592"><td class="docs"><div class="pilwrap"><a href="#section-592" class="pilcrow">&#182;</a></div><p>Parse the exponential component.</p>
</td><td class="code"><div class="highlight"><pre>                  <span class="k">for</span> <span class="p">(</span><span class="nx">position</span> <span class="o">=</span> <span class="nx">Index</span><span class="p">;</span> <span class="nx">position</span> <span class="o">&lt;</span> <span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="nx">charCode</span> <span class="o">=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">position</span><span class="p">)),</span> <span class="nx">charCode</span> <span class="o">&gt;=</span> <span class="mi">48</span> <span class="o">&amp;&amp;</span> <span class="nx">charCode</span> <span class="o">&lt;=</span> <span class="mi">57</span><span class="p">);</span> <span class="nx">position</span><span class="o">++</span><span class="p">);</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">position</span> <span class="o">==</span> <span class="nx">Index</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-593"><td class="docs"><div class="pilwrap"><a href="#section-593" class="pilcrow">&#182;</a></div><p>Illegal empty exponent.</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="nx">abort</span><span class="p">();</span>
                  <span class="p">}</span>
                  <span class="nx">Index</span> <span class="o">=</span> <span class="nx">position</span><span class="p">;</span>
                <span class="p">}</span></pre></div></td></tr><tr id="section-594"><td class="docs"><div class="pilwrap"><a href="#section-594" class="pilcrow">&#182;</a></div><p>Coerce the parsed value to a JavaScript number.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="k">return</span> <span class="o">+</span><span class="nx">source</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">begin</span><span class="p">,</span> <span class="nx">Index</span><span class="p">);</span>
              <span class="p">}</span></pre></div></td></tr><tr id="section-595"><td class="docs"><div class="pilwrap"><a href="#section-595" class="pilcrow">&#182;</a></div><p>A negative sign may only precede numbers.</p>
</td><td class="code"><div class="highlight"><pre>              <span class="k">if</span> <span class="p">(</span><span class="nx">isSigned</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">abort</span><span class="p">();</span>
              <span class="p">}</span></pre></div></td></tr><tr id="section-596"><td class="docs"><div class="pilwrap"><a href="#section-596" class="pilcrow">&#182;</a></div><p><code>true</code>, <code>false</code>, and <code>null</code> literals.</p>
</td><td class="code"><div class="highlight"><pre>              <span class="k">if</span> <span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">Index</span><span class="p">,</span> <span class="nx">Index</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">Index</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
                <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
              <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">Index</span><span class="p">,</span> <span class="nx">Index</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;false&quot;</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">Index</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>
                <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
              <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">Index</span><span class="p">,</span> <span class="nx">Index</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;null&quot;</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">Index</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
                <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
              <span class="p">}</span></pre></div></td></tr><tr id="section-597"><td class="docs"><div class="pilwrap"><a href="#section-597" class="pilcrow">&#182;</a></div><p>Unrecognized token.</p>
</td><td class="code"><div class="highlight"><pre>              <span class="nx">abort</span><span class="p">();</span>
          <span class="p">}</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-598"><td class="docs"><div class="pilwrap"><a href="#section-598" class="pilcrow">&#182;</a></div><p>Return the sentinel <code>$</code> character if the parser has reached the end
of the source string.</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">return</span> <span class="s2">&quot;$&quot;</span><span class="p">;</span>
      <span class="p">};</span></pre></div></td></tr><tr id="section-599"><td class="docs"><div class="pilwrap"><a href="#section-599" class="pilcrow">&#182;</a></div><p>Internal: Parses a JSON <code>value</code> token.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">get</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">results</span><span class="p">,</span> <span class="nx">hasMembers</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">==</span> <span class="s2">&quot;$&quot;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-600"><td class="docs"><div class="pilwrap"><a href="#section-600" class="pilcrow">&#182;</a></div><p>Unexpected end of input.</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nx">abort</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">value</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">((</span><span class="nx">charIndexBuggy</span> <span class="o">?</span> <span class="nx">value</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">:</span> <span class="nx">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="s2">&quot;@&quot;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-601"><td class="docs"><div class="pilwrap"><a href="#section-601" class="pilcrow">&#182;</a></div><p>Remove the sentinel <code>@</code> character.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">return</span> <span class="nx">value</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
          <span class="p">}</span></pre></div></td></tr><tr id="section-602"><td class="docs"><div class="pilwrap"><a href="#section-602" class="pilcrow">&#182;</a></div><p>Parse object and array literals.</p>
</td><td class="code"><div class="highlight"><pre>          <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">==</span> <span class="s2">&quot;[&quot;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-603"><td class="docs"><div class="pilwrap"><a href="#section-603" class="pilcrow">&#182;</a></div><p>Parses a JSON array, returning a new JavaScript array.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">results</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="k">for</span> <span class="p">(;;</span> <span class="nx">hasMembers</span> <span class="o">||</span> <span class="p">(</span><span class="nx">hasMembers</span> <span class="o">=</span> <span class="kc">true</span><span class="p">))</span> <span class="p">{</span>
              <span class="nx">value</span> <span class="o">=</span> <span class="nx">lex</span><span class="p">();</span></pre></div></td></tr><tr id="section-604"><td class="docs"><div class="pilwrap"><a href="#section-604" class="pilcrow">&#182;</a></div><p>A closing square bracket marks the end of the array literal.</p>
</td><td class="code"><div class="highlight"><pre>              <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">==</span> <span class="s2">&quot;]&quot;</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">break</span><span class="p">;</span>
              <span class="p">}</span></pre></div></td></tr><tr id="section-605"><td class="docs"><div class="pilwrap"><a href="#section-605" class="pilcrow">&#182;</a></div><p>If the array literal contains elements, the current token
should be a comma separating the previous element from the
next.</p>
</td><td class="code"><div class="highlight"><pre>              <span class="k">if</span> <span class="p">(</span><span class="nx">hasMembers</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">==</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">value</span> <span class="o">=</span> <span class="nx">lex</span><span class="p">();</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">==</span> <span class="s2">&quot;]&quot;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-606"><td class="docs"><div class="pilwrap"><a href="#section-606" class="pilcrow">&#182;</a></div><p>Unexpected trailing <code>,</code> in array literal.</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="nx">abort</span><span class="p">();</span>
                  <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr><tr id="section-607"><td class="docs"><div class="pilwrap"><a href="#section-607" class="pilcrow">&#182;</a></div><p>A <code>,</code> must separate each array element.</p>
</td><td class="code"><div class="highlight"><pre>                  <span class="nx">abort</span><span class="p">();</span>
                <span class="p">}</span>
              <span class="p">}</span></pre></div></td></tr><tr id="section-608"><td class="docs"><div class="pilwrap"><a href="#section-608" class="pilcrow">&#182;</a></div><p>Elisions and leading commas are not permitted.</p>
</td><td class="code"><div class="highlight"><pre>              <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">==</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">abort</span><span class="p">();</span>
              <span class="p">}</span>
              <span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">get</span><span class="p">(</span><span class="nx">value</span><span class="p">));</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nx">results</span><span class="p">;</span>
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">==</span> <span class="s2">&quot;{&quot;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-609"><td class="docs"><div class="pilwrap"><a href="#section-609" class="pilcrow">&#182;</a></div><p>Parses a JSON object, returning a new JavaScript object.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">results</span> <span class="o">=</span> <span class="p">{};</span>
            <span class="k">for</span> <span class="p">(;;</span> <span class="nx">hasMembers</span> <span class="o">||</span> <span class="p">(</span><span class="nx">hasMembers</span> <span class="o">=</span> <span class="kc">true</span><span class="p">))</span> <span class="p">{</span>
              <span class="nx">value</span> <span class="o">=</span> <span class="nx">lex</span><span class="p">();</span></pre></div></td></tr><tr id="section-610"><td class="docs"><div class="pilwrap"><a href="#section-610" class="pilcrow">&#182;</a></div><p>A closing curly brace marks the end of the object literal.</p>
</td><td class="code"><div class="highlight"><pre>              <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">==</span> <span class="s2">&quot;}&quot;</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">break</span><span class="p">;</span>
              <span class="p">}</span></pre></div></td></tr><tr id="section-611"><td class="docs"><div class="pilwrap"><a href="#section-611" class="pilcrow">&#182;</a></div><p>If the object literal contains members, the current token
should be a comma separator.</p>
</td><td class="code"><div class="highlight"><pre>              <span class="k">if</span> <span class="p">(</span><span class="nx">hasMembers</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">==</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">value</span> <span class="o">=</span> <span class="nx">lex</span><span class="p">();</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">==</span> <span class="s2">&quot;}&quot;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-612"><td class="docs"><div class="pilwrap"><a href="#section-612" class="pilcrow">&#182;</a></div><p>Unexpected trailing <code>,</code> in object literal.</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="nx">abort</span><span class="p">();</span>
                  <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr><tr id="section-613"><td class="docs"><div class="pilwrap"><a href="#section-613" class="pilcrow">&#182;</a></div><p>A <code>,</code> must separate each object member.</p>
</td><td class="code"><div class="highlight"><pre>                  <span class="nx">abort</span><span class="p">();</span>
                <span class="p">}</span>
              <span class="p">}</span></pre></div></td></tr><tr id="section-614"><td class="docs"><div class="pilwrap"><a href="#section-614" class="pilcrow">&#182;</a></div><p>Leading commas are not permitted, object property names must be
double-quoted strings, and a <code>:</code> must separate each property
name and value.</p>
</td><td class="code"><div class="highlight"><pre>              <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">==</span> <span class="s2">&quot;,&quot;</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">value</span> <span class="o">!=</span> <span class="s2">&quot;string&quot;</span> <span class="o">||</span> <span class="p">(</span><span class="nx">charIndexBuggy</span> <span class="o">?</span> <span class="nx">value</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">:</span> <span class="nx">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="s2">&quot;@&quot;</span> <span class="o">||</span> <span class="nx">lex</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;:&quot;</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">abort</span><span class="p">();</span>
              <span class="p">}</span>
              <span class="nx">results</span><span class="p">[</span><span class="nx">value</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="nx">get</span><span class="p">(</span><span class="nx">lex</span><span class="p">());</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nx">results</span><span class="p">;</span>
          <span class="p">}</span></pre></div></td></tr><tr id="section-615"><td class="docs"><div class="pilwrap"><a href="#section-615" class="pilcrow">&#182;</a></div><p>Unexpected token encountered.</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nx">abort</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
      <span class="p">};</span></pre></div></td></tr><tr id="section-616"><td class="docs"><div class="pilwrap"><a href="#section-616" class="pilcrow">&#182;</a></div><p>Internal: Updates a traversed object member.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">update</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">property</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">property</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">element</span> <span class="o">===</span> <span class="nx">undef</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">delete</span> <span class="nx">source</span><span class="p">[</span><span class="nx">property</span><span class="p">];</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">source</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span> <span class="o">=</span> <span class="nx">element</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">};</span></pre></div></td></tr><tr id="section-617"><td class="docs"><div class="pilwrap"><a href="#section-617" class="pilcrow">&#182;</a></div><p>Internal: Recursively traverses a parsed JSON object, invoking the
<code>callback</code> function for each value. This is an implementation of the
<code>Walk(holder, name)</code> operation defined in ES 5.1 section 15.12.2.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">walk</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">property</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">source</span><span class="p">[</span><span class="nx">property</span><span class="p">],</span> <span class="nx">length</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">value</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-618"><td class="docs"><div class="pilwrap"><a href="#section-618" class="pilcrow">&#182;</a></div><p><code>forEach</code> can't be used to traverse an array in Opera &lt;= 8.54
because its <code>Object#hasOwnProperty</code> implementation returns <code>false</code>
for array indices (e.g., <code>![1, 2, 3].hasOwnProperty("0")</code>).</p>
</td><td class="code"><div class="highlight"><pre>          <span class="k">if</span> <span class="p">(</span><span class="nx">getClass</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">==</span> <span class="nx">arrayClass</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="nx">length</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">length</span><span class="o">--</span><span class="p">;)</span> <span class="p">{</span>
              <span class="nx">update</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">length</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">forEach</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">property</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">update</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">property</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
            <span class="p">});</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">callback</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">property</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
      <span class="p">};</span></pre></div></td></tr><tr id="section-619"><td class="docs"><div class="pilwrap"><a href="#section-619" class="pilcrow">&#182;</a></div><p>Public: <code>JSON.parse</code>. See ES 5.1 section 15.12.2.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">JSON3</span><span class="p">.</span><span class="nx">parse</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">value</span><span class="p">;</span>
        <span class="nx">Index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nx">Source</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="nx">source</span><span class="p">;</span>
        <span class="nx">result</span> <span class="o">=</span> <span class="nx">get</span><span class="p">(</span><span class="nx">lex</span><span class="p">());</span></pre></div></td></tr><tr id="section-620"><td class="docs"><div class="pilwrap"><a href="#section-620" class="pilcrow">&#182;</a></div><p>If a JSON string contains multiple tokens, it is invalid.</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">lex</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;$&quot;</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">abort</span><span class="p">();</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-621"><td class="docs"><div class="pilwrap"><a href="#section-621" class="pilcrow">&#182;</a></div><p>Reset the parser state.</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nx">Index</span> <span class="o">=</span> <span class="nx">Source</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">callback</span> <span class="o">&amp;&amp;</span> <span class="nx">getClass</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="o">==</span> <span class="nx">functionClass</span> <span class="o">?</span> <span class="nx">walk</span><span class="p">((</span><span class="nx">value</span> <span class="o">=</span> <span class="p">{},</span> <span class="nx">value</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">value</span><span class="p">),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="o">:</span> <span class="nx">result</span><span class="p">;</span>
      <span class="p">};</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-622"><td class="docs"><div class="pilwrap"><a href="#section-622" class="pilcrow">&#182;</a></div><p>Export for asynchronous module loaders.</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">isLoader</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">define</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">JSON3</span><span class="p">;</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}(</span><span class="k">this</span><span class="p">));</span>

<span class="p">},{}],</span><span class="mi">50</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">toArray</span>

<span class="kd">function</span> <span class="nx">toArray</span><span class="p">(</span><span class="nx">list</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">array</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nx">index</span> <span class="o">=</span> <span class="nx">index</span> <span class="o">||</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">index</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">list</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">array</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="nx">index</span><span class="p">]</span> <span class="o">=</span> <span class="nx">list</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">array</span>
<span class="p">}</span>

<span class="p">},{}]},{},[</span><span class="mi">1</span><span class="p">])</span>
<span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">});</span>

</pre></div></td></tr></tbody></table><div id="generated">generated Thu Feb 19 2015 15:13:35 GMT-0800 (PST)  </div><div id="projectname"><a href="../../../index.html">thesisApp</a></div></div></body></html>